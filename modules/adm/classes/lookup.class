<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */

class BusinessAdmLookup
{
	
	/* ---------------------------------------

	Método LookupUo()

	Gera o Lookup de uos com
	busca na tabela ad_uo.

	----------------------------------------*/
	
	function LookupUo(&$lookup)
	{
		$filterNome = $lookup->GetFilterValue('filterNome');
		if (!$filterNome) $filterNome = $lookup->GetFilterValue();
		if (!$filterNome) $filterNome = '%';
		$lookup->AddFilterField( 
			new TextField('filterNome',$filterNome,'Sigla da U.O.',50)
		);
		$columns = array(
			new DataGridColumn('nome','Nome','left',true,'85%',true),
		);
		$sql = new sql();
		$sql->SetColumns('
			iduo,
			nome
		');
		$sql->SetTables('
			ad_uo
		');
		if ($filterNome)
		{
			$where = "upper(sigla) like upper('$filterNome%')";
			$sql->SetWhere($where);
		}
		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Pesquisa de U.O.',
			10,
			0
		);
	}
	/* ---------------------------------------

	Método LookupMaterial()

	Gera o Lookup de material com
	busca na tabela ad_material.

	----------------------------------------*/
	
	function LookupMaterial(&$lookup)
	{
		global $MIOLO, $page, $state;
		
		
		$session = $MIOLO->session;
        $codmaterial = (intval($lookup->GetFilterValue('filter'))) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('codmaterial');
        $descricao = (!$codmaterial && $lookup->GetFilterValue('filter')) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('descricao');
        $lookup->AddFilterField(new Text('','Digite o código:'));
		$lookup->AddFilterField(new TextField('codmaterial',$codmaterial,'',12));
        $lookup->AddFilterField(new Text('','ou a descrição:'));
        $lookup->AddFilterField(new TextField('descricao',$descricao,'',30));
        //if (!$descricao || $codmaterial) $descricao = 'NÃO INFORMADO';
		$columns = array(
			new DataGridColumn('idmaterial','Código','left',true,'10%',false),
			new DataGridColumn('codmaterial','Código','left',true,'10%',true),
			new DataGridColumn('unidade','Un','left',true,'10%',true),
                        new DataGridColumn('precoestimado','Valor Unitário R$','left',true,'10%',true),
			new DataGridColumn('descricao','Nome','left',true,'60%',true),
                        
		);
		$sql = new sql();
		$descr = "REPLACE (descricao,'\r\n',' ')";
		$sql->SetColumns('
			idmaterial,
			REPLACE (descricao,\'\r\n\',\' \') as descricao,
			codmaterial,
                        unidade,
                        precoestimado 
           
		');
		$sql->SetTables('
			ad_material
		');
		if ($codmaterial and is_numeric($codmaterial) and !$descricao)
		{
			$where = "(upper(ativo) = 'S' and upper(".$descr.") like upper('%$descricao%') and idelemento = 339030) and (upper(ativo) = 'S' and codmaterial = $codmaterial and idelemento = 339030)";
			$sql->SetWhere($where);
		} else if ($codmaterial and is_numeric($codmaterial) and $descricao)
		{
			$where = "(upper(ativo) = 'S' and upper(".$descr.") like upper('%$descricao%') and idelemento = 339030) or (upper(ativo) = 'S' and codmaterial = $codmaterial and idelemento = 339030)";
			$sql->SetWhere($where);
		}
		else 
		{
			//$where = "(upper(ativo) = 'S' and upper(descricao) like upper('%$descricao%') and idelemento = 339030) or (upper(ativo) = 'S' and idelemento = 339030)";
			$where = "(upper(ativo) = 'S' and upper(".$descr.") like upper('%$descricao%') and idelemento = 339030)";
			$sql->SetWhere($where);
		}
		$sql->SetOrderBy('descricao');

		if ( $session->isRegistered("filterAntigo") )
		{
			$filterAntigo = $session->getValue("filterAntigo"); 
		}
		else
		{
			$session->register("filterAntigo");
			$session->setValue("filterAntigo",$descricao);
			$filterAntigo = $session->getValue("filterAntigo");
		}

		if ( $descricao != $filterAntigo )
		{
			$filterAntigo = $descricao;
			$session->setValue("filterAntigo",$filterAntigo);
			$state->set('pn_page',1);
		}

		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Pesquisa de Material',
			10,
			0
		);
	}

	/* ---------------------------------------

	Método LookupMaterialAcervo()

	Gera o Lookup de material de consumo com
	busca na tabela ad_material.

	----------------------------------------*/
	
	function LookupMaterialAcervo(&$lookup)
	{
		global $MIOLO, $page, $state;
		
		$session = $MIOLO->session;
        $codmaterial = (intval($lookup->GetFilterValue('filter'))) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('codmaterial');
        $descricao = (!$codmaterial && $lookup->GetFilterValue('filter')) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('descricao');
        $lookup->AddFilterField(new Text('','Digite o código:'));
		$lookup->AddFilterField(new TextField('codmaterial',$codmaterial,'',14));
        $lookup->AddFilterField(new Text('','ou a descrição:'));
        $lookup->AddFilterField(new TextField('descricao',$descricao,'',30));
        $codmaterial = trim($codmaterial);
        $descricao = trim($descricao);
		$columns = array(
			new DataGridColumn('idmaterial','Código','left',true,'10%',false),
			new DataGridColumn('codmaterial','Código','left',true,'10%',true),
			new DataGridColumn('unidade','Un','left',true,'10%',true),
                        new DataGridColumn('precoestimado','Valor Unitário R$','left',true,'10%',true),
			new DataGridColumn('descricao','Nome','left',true,'60%',true),
                        
		);
		$sql = new sql();
		$descr = "REPLACE (descricao,'\r\n',' ')";
		$sql->SetColumns('
			idmaterial,
			REPLACE (descricao,\'\r\n\',\' \') as descricao,
			codmaterial,
            unidade,
            precoestimado
		');
		$sql->SetTables('
			ad_material
		');
		if ($codmaterial)
			$where = "(upper(ativo) = 'S' and (" . ($descricao ? "upper(".$descr.") like upper('%$descricao%') or " : '') . "cast(codmaterial as varchar) = '$codmaterial') and idelemento = '339030' and idsubelemento='46')"; // -- Sugestão da EAFBarbacena -- //
		else
			$where = "(upper(ativo) = 'S' and " . ($descricao ? "upper(".$descr.") like upper('%$descricao%') and " : '') . "idelemento = '339030' and idsubelemento='46')"; // -- Sugestão da EAFBarbacena -- //			
    $sql->SetWhere($where);
		$sql->SetOrderBy('descricao');

		if ( $session->isRegistered("filterAntigo") )
		{
			$filterAntigo = $session->getValue("filterAntigo"); 
		}
		else
		{
			$session->register("filterAntigo");
			$session->setValue("filterAntigo",$descricao);
			$filterAntigo = $session->getValue("filterAntigo");
		}

		if ( $descricao != $filterAntigo )
		{
			$filterAntigo = $descricao;
			$session->setValue("filterAntigo",$filterAntigo);
			$state->set('pn_page',1);
		}

		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Pesquisa de Material',
			10,
			0
		);
	}

	/* ---------------------------------------

	Método LookupMaterialConsumo()

	Gera o Lookup de material de consumo com
	busca na tabela ad_material.

	----------------------------------------*/
	
	function LookupMaterialConsumo(&$lookup)
	{
		global $MIOLO, $page, $state;
				
		$session = $MIOLO->session;
        $codmaterial = (intval($lookup->GetFilterValue('filter'))) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('codmaterial');
        $descricao = (!$codmaterial && $lookup->GetFilterValue('filter')) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('descricao');
         
        //$idmaterial = (intval($lookup->GetFilterValue('filter'))) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('idmaterial');
        //$descricao = (!$idmaterial && $lookup->GetFilterValue('filter')) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('descricao');


        $lookup->AddFilterField(new Text('','Digite o Código:'));
		$lookup->AddFilterField(new TextField('codmaterial',$codmaterial,'',12));
        //$lookup->AddFilterField(new TextField('idmaterial',$idmaterial,'',12));
        $lookup->AddFilterField(new Text('','ou a descrição:'));
        $lookup->AddFilterField(new TextField('descricao',$descricao,'',30));
        $codmaterial = trim($codmaterial);
        //$idmaterial = trim($idmaterial);
        $descricao = trim($descricao);
		$columns = array(
			new DataGridColumn('idmaterial','Código','left',true,'10%',false),
			new DataGridColumn('codmaterial','Código','left',true,'10%',true),
			new DataGridColumn('unidade','Un','left',true,'10%',true),
            new DataGridColumn('precoestimado','Valor Unitário R$','left',true,'10%',true),
			new DataGridColumn('descricao','Nome','left',false,'60%',true),                        
		);
		$sql = new sql();
		$sql->SetColumns('
			idmaterial,
			REPLACE (descricao,\'\r\n\',\' \') as descricao,
			codmaterial,
            unidade,
            precoestimado               
		');
		$sql->SetTables('
			ad_material
		');
		if ($codmaterial)
			$where = "(upper(ativo) = 'S' and (" . ($descricao ? "upper(REPLACE (descricao,'\r\n',' ')) like upper('%$descricao%') or " : '') . "cast(codmaterial as varchar) = '$codmaterial') and idelemento = '339030')"; // -- Sugestão da EAFBarbacena -- //
		else
			$where = "(upper(ativo) = 'S' and " . ($descricao ? "upper(REPLACE (descricao,'\r\n',' ')) like upper('%$descricao%') and " : '') . "idelemento = '339030')"; // -- Sugestão da EAFBarbacena -- //

        //if ($idmaterial)
			//$where = "(upper(ativo) = 'S' and (" . ($descricao ? "upper(descricao) like upper('%$descricao%') or " : '') . "cast(idmaterial as varchar) = '$idmaterial') and idelemento = '339030')"; // -- Sugestão da EAFBarbacena -- //
		//else
			//$where = "(upper(ativo) = 'S' and " . ($descricao ? "upper(descricao) like upper('%$descricao%') and " : '') . "idelemento = '339030')";

    $sql->SetWhere($where);
		$sql->SetOrderBy('descricao');

		if ( $session->isRegistered("filterAntigo") )
		{
			$filterAntigo = $session->getValue("filterAntigo"); 
		}
		else
		{
			$session->register("filterAntigo");
			$session->setValue("filterAntigo",$descricao);
			$filterAntigo = $session->getValue("filterAntigo");
		}

		if ( $descricao != $filterAntigo )
		{
			$filterAntigo = $descricao;
			$session->setValue("filterAntigo",$filterAntigo);
			$state->set('pn_page',1);
		}

		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Pesquisa de Material',
			10,
			0
		);
	}
	
	/* ---------------------------------------

	Método LookupMaterialPermanente()

	Gera o Lookup de material permanente com
	busca na tabela ad_material.

	----------------------------------------*/
	
	function LookupMaterialPermanente(&$lookup)
	{
		global $MIOLO, $page, $state;

		$session = $MIOLO->session;
        $codmaterial = (intval($lookup->GetFilterValue('filter'))) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('codmaterial');
        $descricao = (!$codmaterial && $lookup->GetFilterValue('filter')) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('descricao');
         
        //$idmaterial = (intval($lookup->GetFilterValue('filter'))) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('idmaterial');
        //$descricao = (!$idmaterial && $lookup->GetFilterValue('filter')) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('descricao');
      
        $lookup->AddFilterField(new Text('','Digite o Código:'));
		$lookup->AddFilterField(new TextField('codmaterial',$codmaterial,'',12));
        //$lookup->AddFilterField(new TextField('idmaterial',$idmaterial,'',12));
        $lookup->AddFilterField(new Text('','ou a descrição:'));
        $lookup->AddFilterField(new TextField('descricao',$descricao,'',30));
        $descricao = trim($descricao);
        $codmaterial = trim($codmaterial);
        //$idmaterial = trim($idmaterial);
		$columns = array(
			new DataGridColumn('idmaterial','Código','left',true,'10%',false),
			new DataGridColumn('codmaterial','CATMAT','left',true,'10%',true),
                        new DataGridColumn('unidade','Un','left',true,'10%',true),
                        new DataGridColumn('precoestimado','Valor Unitário R$','left',true,'10%',true),
			new DataGridColumn('descricao','Nome','left',false,'60%',true),
		);
		$sql = new sql();
		$sql->SetColumns('
			idmaterial,			
			REPLACE (descricao,\'\r\n\',\' \') as descricao,
			codmaterial,
                        unidade,
                        precoestimado
		');
		$sql->SetTables('
			ad_material
		');

        if ($codmaterial)
            $where = "(upper(ativo) = 'S' and (" . ($descricao ? "upper(REPLACE (descricao,'\r\n',' ')) like upper('%$descricao%') or " : '') . "cast(codmaterial as varchar) = '$codmaterial') and idelemento = '449052')"; // -- Sugestão da EAFBarbacena -- //
        else
           $where = "(upper(ativo) = 'S' and " . ($descricao ? "upper(REPLACE (descricao,'\r\n',' ')) like upper('%$descricao%') and " : '') . "idelemento = '449052')"; // -- Sugestão da EAFBarbacena -- //
           
           //if ($idmaterial)
            //$where = "(upper(ativo) = 'S' and (" . ($descricao ? "upper(descricao) like upper('%$descricao%') or " : '') . "cast(idmaterial as varchar) = '$idmaterial') and idelemento = '449052')"; // -- Sugestão da EAFBarbacena -- //
        //else
          //  $where = "(upper(ativo) = 'S' and " . ($descricao ? "upper(descricao) like upper('%$descricao%') and " : '') . "idelemento = '449052')";
          
        $sql->SetWhere($where);
		$sql->SetOrderBy('descricao');

		if ( $session->isRegistered("filterAntigo") )
		{
			$filterAntigo = $session->getValue("filterAntigo"); 
		}
		else
		{
			$session->register("filterAntigo");
			$session->setValue("filterAntigo",$descricao);
			$filterAntigo = $session->getValue("filterAntigo");
		}

		if ( $descricao != $filterAntigo )
		{
			$filterAntigo = $descricao;
			$session->setValue("filterAntigo",$filterAntigo);
			$state->set('pn_page',1);
		}

		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Pesquisa de Material',
			10,
			0
		);
	}


	/* ---------------------------------------

	Método LookupMaterialEstoque()

	Gera o Lookup de material com
	busca na tabela ad_material desde que 
	esteja disponivel no estoque do almoxarifado.

	----------------------------------------*/
	
	function LookupMaterialEstoque(&$lookup)
	{		
      $idUo = ($lookup->GetFilterValue('filter0')) ? $lookup->GetFilterValue('filter0') : $lookup->GetFilterValue('idUo');
      $codmaterial = (intval($lookup->GetFilterValue('filter1'))) ? $lookup->GetFilterValue('filter1') : $lookup->GetFilterValue('codmaterial');
      $descricao = (!$codmaterial && $lookup->GetFilterValue('filter1')) ? $lookup->GetFilterValue('filter1') : $lookup->GetFilterValue('descricao');      	
      $lookup->AddFilterField(new HiddenField('idUo',$idUo));
      $lookup->AddFilterField(new Text('','Digite o código:'));
      $lookup->AddFilterField(new TextField('codmaterial',$codmaterial,'',12));
      $lookup->AddFilterField(new Text('','ou a descrição:'));
      $lookup->AddFilterField(new TextField('descricao',$descricao,'',30));
      $descricao = trim($descricao);
      $codmaterial = trim($codmaterial);
      $columns = array(
          new DataGridColumn('codmaterial','Código','left',true,'20%',true),
          new DataGridColumn('unidade','Un','left',true,'10%',true),
          new DataGridColumn('descricao','Nome','left',true,'70%',true)
      );
      $sql = new sql();
      $sql->SetColumns("
          m.idmaterial,
          m.codmaterial,
          REPLACE (m.descricao,'\r\n',' ') as descricao,
          unidade
      ");
      $sql->SetJoin('ad_material m','ad_estoque e','m.idmaterial = e.idmaterial');
      $sql->SetWhere("e.iduo = $idUo");
	  $descr = "REPLACE (m.descricao,'\r\n',' ')";
      if ($codmaterial)
          $where = "(" . ($descricao ? "upper(".$descr.") like upper('%$descricao%') or " : '') . "CAST(m.codmaterial AS varchar) = '$codmaterial')"; // -- Sugestão da EAFBarbacena - Helton -- //
      else
          $where = ($descricao ? "upper(".$descr.") like upper('%$descricao%')" : ''); // -- Sugestão da EAFBarbacena - Helton -- //
      $sql->SetWhere($where);
		
      $sql->SetWhereAnd('e.estoque > 0');
      $sql->SetOrderBy('descricao');
      $lookup->SetGrid(
          'sigaept',
          $sql,
          $columns,
          'Pesquisa de Material',
          10,
          0
      );
  }
	
	function LookupInstituicao(&$lookup)
	{
		$filterNome = $lookup->GetFilterValue('filterNome');
		if (!$filterNome)
		{
			$filterNome = $lookup->GetFilterValue();
		}
		$filterCGC = $lookup->GetFilterValue('filterCGC');
		if (!$filterNome)
			if (!$filterCGC)
				$filterNome = 'NAO INFORMADO';

		
		$lookup->AddFilterField( new TextField('filterNome', $filterNome, 'Nome da Instituicao'));
		$lookup->AddFilterField( new TextField('filterCGC', $filterCGC, 'CGC'));
		
		$columns = array(
			new DataGridColumn('nome','Nome','left',true,'80%',true),
			new DataGridColumn('cgc','CGC','left',true,'20%',true)
			);

			$sql = new sql('idinstituicao,nome,cgc','cm_instituicao');

			if ($filterNome)
			{
				$sql->where .= " upper(nome) like upper('$filterNome%')";
			}
			if ($filterCGC)
			{
				if ($filterNome)
				{
					$sql->where .= " and ";
				}
				$sql->where .= "cgc like '$filterCGC'";
			}

        $lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa Instituicao',10,0);
	}

	function LookupAgencia(&$lookup)
	{
		$filterNome = $lookup->GetFilterValue('filterNome');
		if(!$filterNome)
		{
			$filterNome = $lookup->GetFilterValue();
		}
		$filterIdAgenc = $lookup->GetFilterValue('filterIdAgenc');

		if(!$filterNome)
			if(!$filterIdAgenc)
				$filterNome = '%';

		$lookup->AddFilterField( new TextField('filterNome',$filterNome,'Nome da Agencia'));
		$lookup->AddFilterField( new TextField('filterIdAgenc',$filterIdAgenc,'Numero da Agencia'));

		$columns = array(
			new DataGridColumn('key','key','right',true,'0%',false),
		  new DataGridColumn('nome','Nome','left',true,'80%',true),
			new DataGridColumn('idagenc','Numero','left',true,'20%',true)
		);

		$sql = new sql("trim(t.idagenc)||'_'||t.idbanco as key,t.idagenc,t.nome,t.idbanco",'cm_agencia t');

    if ($filterNome)
		{
			$sql->where .= " upper(nome) like upper('$filterNome%')";
		}
		if ($filterIdAgenc)
		{
			if ($filterNome)
			{
				$sql->where .= " and ";
			}
			$sql->where .= "idagenc like '$filterIdAgenc'";
		}
		$lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa Agencia',10,0);
	}


    /*+++++++
    # LookupAgenciaBanco:
	# Filtro por nome e id da agencia (cm_agencia)
	# Grid:
    --------*/

	function LookupAgenciaBanco(&$lookup)
	{
		$filterNome = $lookup->GetFilterValue('filterNome');
		if(!$filterNome)
		{
			$filterNome = $lookup->GetFilterValue();
		}
		$filterIdAgenc = $lookup->GetFilterValue('filterIdAgenc');

		if(!$filterNome)
			if(!$filterIdAgenc)
				$filterNome = '%';

		$lookup->AddFilterField( new TextField('filterNome',$filterNome,'Nome da Agencia'));
		$lookup->AddFilterField( new TextField('filterIdAgenc',$filterIdAgenc,'Numero da Agencia'));

		$columns = array(
			new DataGridColumn('idagenc','Numero','left',true,'20%',true),
			new DataGridColumn('idbanco','idbanco','left',true,'0%',false),
			new DataGridColumn('nome','Agencia','left',true,'80%',true),
			new DataGridColumn('nomebanco','Banco','left',true,'80%',true)
		);

		$sql = new sql("t.idagenc,t.idbanco,t.nome,b.nome as nomebanco",'cm_agencia t,cm_banco b', 't.idbanco = b.idbanco');

    if ($filterNome)
		{
			$sql->where .= " and upper(t.nome) like upper('$filterNome%')";
		}
		if ($filterIdAgenc)
		{
			$sql->where .= " and t.idagenc like '$filterIdAgenc'";
		}
		$lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa Agencia',10,0);
	}


    /*+++++++
    # LookupUsuarioFuncionario:
	# Filtro por nome (NAO login) do funcionario
	# Grid: cm_pessoa.nome, cm_usuario.idusuario
	#       rh_funcionario.idfuncionario (SIAPE)
    --------*/

	function LookupUsuarioFuncionario(&$lookup)
	{
		$filterNome = $lookup->GetFilterValue('filterNome');

		if (!$filterNome)
		{
			$filterNome = $lookup->GetFilterValue();
		}
		$lookup->AddFilterField(new TextField('filterNome',$filterNome,'Nome',40));

		$sql = new sql();
		$sql->SetColumns('u.idusuario, p.nome, func.idfuncionario');
		$sql->SetJoin('cm_pessoa p','rh_funcionario func','p.idpessoa = func.idpessoa');
		$sql->SetJoin('cm_pessoa p','cm_usuario u','p.idpessoa = u.idpessoa');
		$sql->SetOrderBy('p.nome');

		if ($filterNome)
		{
			$sql->SetWhere("upper(p.nome) LIKE upper('$filterNome%')");
		}

		$columns = array(
			new DataGridColumn('idusuario','IdUsuário','left',true,'0%',false),
			new DataGridColumn('nome','Nome','left',true,'80%',true),
			new DataGridColumn('idfuncionario','SIAPE','right',true,'20%',true)
		);

		$lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa Usuário',10,0);
	}



    /*+++++++
    # LookupCadBolsa:
	# Filtro pela descricao da bolsa
	# Grid: (ad_bolsa) idbolsa e descricao
    --------*/

    function LookupCadBolsa(&$lookup)
    {
        $filterDescricao = $lookup->GetFilterValue('filterDescricao');
        if (!$filterDescricao) {
           $filterDescricao = $lookup->GetFilterValue();
        }
        $lookup->AddFilterField( new TextField('filterDescricao',
		$filterDescricao,'Descrição', 30));
		$columns = array(
			new DataGridColumn('idbolsa','Id','center',true, '15%',true),
			new DataGridColumn('descricao','Descrição','left', true, '85%',true)
			);
		$columns[0]->visible = true;
		$sql = new sql('b.idbolsa, b.descricao','ad_bolsa b');
		
		if ( $filterDescricao )
		{
			$sql->where .= " ( upper(b.descricao) like upper('{$filterDescricao}%') )";
		}
		$sql->SetOrderBy('b.descricao');
		$lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa de Bolsas de Estágio',15,0);
	}


	/* ---------------------------------------

	Método LookupRequisicao()

	Gera o Lookup de requisicao com
	busca na tabela ad_requisicao.

	----------------------------------------*/
	
	function LookupRequisicao(&$lookup)
	{
		$filterNumero = $lookup->GetFilterValue('filterNumero');
		if (!$filterNumero)
			$filterNumero = $lookup->GetFilterValue();

        $filterTipo = $lookup->GetFilterValue('filterTipo');
        $filterStatus = $lookup->GetFilterValue('filterStatus');
        $filterDataInicial = $lookup->GetFilterValue('filterDataInicial');
        $filterDataFinal = $lookup->GetFilterValue('filterDataFinal');

        $tipos = array(
                NULL=>"TODOS",
                "1"=>"RESTAURANTE",
                "2"=>"HOTEL",
                "3"=>"PASSAGEM",               
                "4"=>"VEICULO",
            );
            
        $status = array(
                NULL=>"TODOS",
                "1"=>"PENDENTE",
                "2"=>"SOLICITADA",
                "3"=>"ANALISE UO REQ",               
                "4"=>"AUTORIZADA",
                "5"=>"DEVOLVIDA",
                "6"=>"RECUSADA UO REQ",
                "7"=>"LIBERADA PARA EXECUCAO",               
                "8"=>"EXECUTADA PARCIALMENTE",
                "9"=>"EXECUTADA TOTALMENTE",
                "A"=>"RECUSADA UO EXEC",
                "B"=>"CONSOLIDADA",               
                "D"=>"PAGAMENTO NAO AUTORIZADO",
                "E"=>"PAGAMENTO AUTORIZADO",
                "F"=>"FINALIZADA",
            );

		$lookup->AddFilterField(new TextField('filterNumero',$filterNumero,'N&ordm; da Requisição:',10));
        $lookup->AddFilterField(new selection('filtertipo',$filtertipo,'Tipo:',$tipos));
        $lookup->AddFilterField(new Selection('filterStatus',$filterStatus,'Situação:',$status));
        $lookup->AddFilterField(new calendarField('filterDataInicial',$filterDataInicial,'Com Data a partir de:'));
        $lookup->AddFilterField(new calendarField('filterDataFinal',$filterDataFinal,'Com Data até:'));

		$columns = array(
			new DataGridColumn('idrequisicao','Número','center',true,'10%',true),
			new DataGridColumn('datahorareq','Data/Hora','center',true,'20%',true),
			new DataGridColumn('tiporeq','Tipo','center',true,'20%',true),
			new DataGridColumn('status','Status','center',true,'20%',true),
			new DataGridColumn('uoexec','UO EXEC','center',true,'20%',true)	
		);
		$sql = new sql();
		$sql->SetColumns("
			r.idrequisicao,
            TO_CHAR(r.datahorareq,'DD/MM/YYYY HH24:MI:SS') as datahorareq,
            t.descricao as tiporeq,
			tg.item2 as status,
            uo.sigla as uoexec
		");

		$sql->SetTables('
			ad_requisicao r,
            cm_tabelageral tg,
            ad_uo uo,
            ad_tiporeq t
		');
	
		$sql->SetWhere("
                tg.tabela = 'AD_ALMOXSTATUSREQ' and
                tg.item1 = r.status and
                r.iduoexec = uo.iduo and
                t.idtiporeq = r.tiporequisicao
            ");
            
        $sql->SetOrderBy('r.datahorareq');
        
		if ($filterNumero)
		{
			$where = "r.idrequisicao = '$filterNumero'";
			$sql->SetWhereAnd($where);
		}

 		if ($filterTipo)
		{
			$where = "r.tiporequisicao = '$filterTipo'";
			$sql->SetWhereAnd($where);
		}
       
		if ($filterStatus)
		{
			$where = "r.status = '$filterStatus'";
			$sql->SetWhereAnd($where);
		}
        
		if ($filterDataInicial)
		{
			$where = "r.datahorareq >= TO_DATE('$filterDataInicial','DD/MM/YYYY')";
			$sql->SetWhereAnd($where);
		}
        
		if ($filterDataFinal)
		{
			$where = "r.datahorareq <= TO_DATE('$filterDataFinal','DD/MM/YYYY')";
			$sql->SetWhereAnd($where);
		}

		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Pesquisa Avançada de Requisição',
			10,
			0
		);
	}
	
	function LookupSubelemento(&$lookup)
	{
		$filterNome = $lookup->GetFilterValue('filterNome');
		if (!$filterNome) $filterNome = $lookup->GetFilterValue();
		if (!$filterNome) $filterNome = '%';
		$lookup->AddFilterField( 
			new TextField('filterNome',$filterNome,'Descrição do subelemento',50)
		);
		$columns = array(
			new DataGridColumn('descricao','Nome','left',true,'95%',true)
		);
		$sql = new sql();
		$sql->SetColumns('
			idsubelemento,
			idelemento,
			descricao
		');
		$sql->SetTables('
			ad_subelemento
		');
		if ($filterNome)
		{
			$where = "upper(descricao) like upper('$filterNome%')";
			$sql->SetWhere($where);
			$sql->SetWhereAnd("idelemento = '339030'");
		}
		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Pesquisa de Material',
			10,
			0
		);
	}

	/* ---------------------------------------

	Método LookupOrdemEntrega()

	Gera o Lookup de ordem de entrega com
	busca na tabela ad_requisicao.

	----------------------------------------*/
	
	function LookupOrdemEntrega(&$lookup)
	{
		$filterSetor = $lookup->GetFilterValue('filter0');
		$filterNumero = $lookup->GetFilterValue('filter1');
		if (!$filterNome)
			$filterNumero = $lookup->GetFilterValue();
		if (!$filterNome) $filterNome = '%';

		$lookup->AddFilterField( 
			new TextField('filterNumero',$filterNumero,'Número da Ordem',10)
		);
		$lookup->AddFilterField( 
			new HiddenField('filter0',$filterSetor)
		);
	
		$columns = array(
			new DataGridColumn('numeroordem','Número','center',true,'25%',true),
			new DataGridColumn('dataordent','Data','center',true,'25%',true),
			new DataGridColumn('nomesetor','Setor','center',true,'50%',true)	
		);
		$sql = new sql();
		$sql->SetColumns('o.numeroordem,o.dataordent,s.nomesetor');
		$sql->SetTables('ad_ordentrega o,cm_setor s');	
		$sql->SetWhere("o.idsetor = s.idsetor");
		$sql->SetWhereAnd("o.idsetor = '$filterSetor'");
	
		if ($filterNumero)
		{
			$where = "o.numeroordem = '$filterNumero'";
			$sql->SetWhereAnd($where);
		}

		$lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa de Ordem de Entrega',10,0);
	}


	function LookupLicitacao(&$lookup)
	{
		$filterNumero = $lookup->GetFilterValue('filter0');
		$filterTipo = $lookup->GetFilterValue('filter1');

		$lookup->AddFilterField( 
			new TextField('filter0',$filterNumero,'Licitação: ',50)
		);
		
		$lookup->AddFilterField(
			new HiddenField('filter1',$filterTipo)
		);

		$columns = array(
			new DataGridColumn('idlicitacao','','left',true,'',false),
			new DataGridColumn('numero','Número','center',true,'20%',true),
			new DataGridColumn('dataabertura','Data de Abertura','center',true,'20%',true),
			new DataGridColumn('datahomologacao','Data Homologação','center',true,'15%',true),
			new DataGridColumn('valor','Valor Licitação','right',true,'15%',true),
			new DataGridColumn('empenhado','Valor Empenhado','right',true,'15%',true),
			new DataGridColumn('idModalidaDeLicitacao','Modalidade','center',true,'',false),
			new DataGridColumn('saldo','Saldo','right',true,'15%',true),
		);
		$sql = new sql();
		$sql->SetWhere("tg.tabela = 'AD_ALMOXSTATUSLIC' and tg.item1 = l.status");
		$sql->SetOrderBy('l.numero');

		if ($filterNumero)
		{
			$where = "l.numero like '%$filterNumero%'";
			$sql->SetWhereAnd($where);
		}
		$sql->SetColumns("
			distinct(l.idlicitacao),
			l.numero,
			l.dataabertura,
			l.datahomologacao,
			null as valor,
			null as empenhado,
			l.idModalidaDeLicitacao,
			null as saldo
		");

		if( ($filterTipo == 1) || ($filterTipo == 2) )//novas ou parciais
		{
			$sql->SetTables("
				ad_licitacao l,
				cm_tabelageral tg,
				ad_empenhado e
			");
		}
		else
		{
			$sql->SetTables("
				ad_licitacao l,
				cm_tabelageral tg
			");
		}

		if($filterTipo == 3)//com saldo
		{
			$sql->SetWhereAnd("(tg.item2 = 'VENCEDORES DEFINIDOS')");
		}
		else
		{
			$sql->SetWhereAnd("(tg.item2 = 'VENCEDORES DEFINIDOS' or tg.item2 = 'EMPENHADA')");
		}

		if($filterTipo == 1)//novas
		{
		
//Takanori
		//$sql->SetWhereAnd("(l.idlicitacao = e.idlicitacao(+)) and (e.idlicitacao is null)");

		$sql->tables = null;
		$sql->SetTables("ad_licitacao l LEFT OUTER JOIN ad_empenhado e on(l.idlicitacao = e.idlicitacao), cm_tabelageral tg ");
		$sql->SetWhereAnd("e.idlicitacao is null");
//Takanori
		}
		elseif($filterTipo == 2)//parciais
		{
			$sql->SetWhereAnd("(l.idlicitacao = e.idlicitacao)");
		}

		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Selecionar Licitação',
			20,
			0
		);
		$lookup->grid->setRowMethod('BusinessAdmLookup', 'LookupLicitacaoRowMethod');
	}
	
	/* ---------------------------------------

	Método LookupLicitacaoSuplementar()

	Gera o Lookup de licitações com
	busca nas tabela ad_requisicao e ad_itemreq verificando quais são as requisições suplementares.

	----------------------------------------*/
	
	function LookupLicitacaoSuplementar(&$lookup)
	{
		$filterNumero = $lookup->GetFilterValue('filter0');
		$filterTipo = $lookup->GetFilterValue('filter1');

		$lookup->AddFilterField( 
			new TextField('filter0',$filterNumero,'Licitação: ',50)
		);
		
		$lookup->AddFilterField(
			new HiddenField('filter1',$filterTipo)
		);

		$columns = array(
			new DataGridColumn('idlicitacao','','left',true,'',false),
			new DataGridColumn('numero','Número','center',true,'20%',true),
			new DataGridColumn('dataabertura','Data de Abertura','center',true,'20%',true),
			new DataGridColumn('datahomologacao','Data Homologação','center',true,'15%',true),
			new DataGridColumn('valor','Valor Licitação','right',true,'15%',true),
			new DataGridColumn('empenhado','Valor Empenhado','right',true,'15%',true),
			new DataGridColumn('idModalidaDeLicitacao','Modalidade','center',true,'',false),
			new DataGridColumn('saldo','Saldo','right',true,'15%',true),
		);
		$sql = new sql();
		$sql->SetWhere("tg.tabela = 'AD_ALMOXSTATUSLIC' and tg.item1 = l.status and l.idlicitacao = ir.idlicitacao and ir.idrequisicao = r.idrequisicao	and r.suplementar ilike ('S')");
		$sql->SetOrderBy('l.numero');

		if ($filterNumero)
		{
			$where = "l.numero like '%$filterNumero%'";
			$sql->SetWhereAnd($where);
		}
		$sql->SetColumns("
			distinct(l.idlicitacao),
			l.numero,
			l.dataabertura,
			l.datahomologacao,
			null as valor,
			null as empenhado,
			l.idModalidaDeLicitacao,
			null as saldo
		");

		if( ($filterTipo == 1) || ($filterTipo == 2) )//novas ou parciais
		{
			$sql->SetTables("
				ad_licitacao l,
				ad_itemreq ir,
				ad_requisicao r,
				cm_tabelageral tg,				
				ad_empenhado e
			");
		}
		else
		{
			$sql->SetTables("
				ad_licitacao l,
				ad_itemreq ir,
				ad_requisicao r,
				cm_tabelageral tg
			");
		}

		if($filterTipo == 3)//com saldo
		{
			$sql->SetWhereAnd("(tg.item2 = 'VENCEDORES DEFINIDOS')");
		}
		else
		{
			$sql->SetWhereAnd("(tg.item2 = 'VENCEDORES DEFINIDOS' or tg.item2 = 'EMPENHADA')");
		}

		if($filterTipo == 1)//novas
		{
		
//Takanori
		//$sql->SetWhereAnd("(l.idlicitacao = e.idlicitacao(+)) and (e.idlicitacao is null)");

		$sql->tables = null;
		$sql->SetTables("ad_licitacao l LEFT OUTER JOIN ad_empenhado e on(l.idlicitacao = e.idlicitacao), cm_tabelageral tg ");
		$sql->SetWhereAnd("e.idlicitacao is null");
//Takanori
		}
		elseif($filterTipo == 2)//parciais
		{
			$sql->SetWhereAnd("(l.idlicitacao = e.idlicitacao)");
		}

		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Selecionar Licitação',
			20,
			0
		);
		$lookup->grid->setRowMethod('BusinessAdmLookup', 'LookupLicitacaoRowMethod');
	}
	
	public function LookupLicitacaoRowMethod($i,$row,$actions,$columns)
	{
		global $MIOLO;

		$idLicitacao = $row[0];
		$cf = new MCurrencyFormatter();
		$licitacao = $MIOLO->GetBusiness('adm','licitacao',$idLicitacao);//idlicitacao

		$licitacao->retrieveAssociation('mapa');
		$valorLicitacao = 0;
		$valorEmpenhado = 0;
		$saldo = 0;
		if($licitacao->mapa)
		{
			foreach($licitacao->mapa as $item)
			{
                if ($item->vencedor == '1')
                {
                    $objMapa = $MIOLO->GetBusiness('adm','mapalicitacao');
                    $objMapa->GetByIdLicitacaoItemVencedor($idLicitacao, $item->item);

                    $totalMapa = $cf->toDecimal($objMapa->quantidade) * $cf->toDecimal($objMapa->preco);

                    $itemLicitacao = $MIOLO->GetBusiness('adm','itemlicitacao');
                    
                    $objSuplementacao = $MIOLO->GetBusiness('adm','suplementacaoitem');
                    $totalSuplementacao = $objSuplementacao->GetTotalByIdLicitacaoItem($idLicitacao, $item->item);

                    $totalEmpenhado = $totalEmpenhado + $itemLicitacao->GetValorEmpenhado($idLicitacao, $item->item);
					                    $valorLicitacao = $cf->toDecimal($valorLicitacao) +
									  $cf->toDecimal($totalMapa) +
									  $cf->toDecimal($totalSuplementacao); 
                }
			}
			$valorEmpenhado = $cf->toDecimal($valorEmpenhado) + $cf->toDecimal($totalEmpenhado);	
			$saldo = $cf->toDecimal($valorLicitacao) - $cf->toDecimal($valorEmpenhado);
		}

		$valorLicitacao = number_format(str_replace(',','.',$valorLicitacao),2,',','.');
		$valorEmpenhado = number_format(str_replace(',','.',$valorEmpenhado),2,',','.');
		$saldo = number_format(str_replace(',','.',$saldo),2,',','.');
		$columns['valor']->control[$i]->SetValue($valorLicitacao);
		$columns['empenhado']->control[$i]->SetValue($valorEmpenhado);
		$columns['saldo']->control[$i]->SetValue($saldo);
	}

	function LookupLicitacaoComSolicitacao(&$lookup)
	{
		$filterNumero = $lookup->GetFilterValue('filter0');
		$filterStatus = $lookup->GetFilterValue('filter1');

		//Converte o valor $filterStatus para uma string de char de forma que a comparação funcione corretamente no comando sql
                $status = explode(",","$filterStatus");
                $filterStatus = "";
                foreach($status as $s)
                {
                        if($filterStatus != "")
                                $filterStatus .= ",";
                        $filterStatus .= "'".$s."'";
                }


		$lookup->AddFilterField( 
			new MTextField('filter0',$filterNumero,'Licitação: ',50)
		);
		$lookup->AddFilterField( 
			new MHiddenField('filter1',$filterStatus)
		);
		
		$columns = array(
			new DataGridColumn('idlicitacao','','left',true,'',false),
			new DataGridColumn('numeroLic','Número','center',true,'17%',true),
			new DataGridColumn('dataabertura','Data Abertura','center',true,'13%',true),
			new DataGridColumn('datahomologacao','Data Homologação','center',true,'15%',true),
			new DataGridColumn('valor','Valor Licitação','right',true,'15%',true),
			new DataGridColumn('empenhado','Valor Empenhado','right',true,'15%',true),
			new DataGridColumn('idModalidaDeLicitacao','Modalidade','center',true,'',false),
			new DataGridColumn('saldo','Saldo','right',true,'10%',true),
			new DataGridColumn('numero','Nº Solicit','center',true,'15%',true),
		);
		$sql = new sql();
		$sql->SetWhere("tg.tabela = 'AD_ALMOXSTATUSLIC' and tg.item1 = l.status and ml.idlicitacao=l.idlicitacao");
		$sql->SetOrderBy('l.numero');

		if ($filterNumero)
		{
			$where = "l.numero = '$filterNumero'";
			$sql->SetWhereAnd($where);
		}

		$sql->SetColumns("
			l.idlicitacao,
			l.numero as numeroLic,
			l.dataabertura,
			l.datahomologacao,
			to_char(ml.valor, '999G999G999D99') as valor,
			NVL(to_char(d.empenhado, '999G999G999D99'), '0,00') as empenhado,
			l.idModalidaDeLicitacao,
			(to_char(ml.valor-NVL(d.empenhado, 0), '999G999G999D99')) as saldo,
			s.numero,
			to_char(s.solicitacao, '999G999G999D99') as solicitacao
		");
		$sql->SetTables("
			ad_licitacao l LEFT JOIN			
			(	select 	d.idlicitacao, sum(d.valoremp) as empenhado 
				from 	ad_empenhado 	d, 
					ad_itemreq 	i, 
					ad_requisicao 	r
				where 	d.idlicitacao=i.idlicitacao 
				and 	d.item=i.item 
				and 	i.idrequisicao=r.idrequisicao
				and i.status in ('A','5','6','7','9') and r.status in ('7','8','9')
				group by d.idlicitacao
			) d  ON l.idlicitacao=d.idlicitacao,
			cm_tabelageral tg,
			
			(	select 	v1.idlicitacao, 
					v1.valor+NVL(v2.suplemento,0) as valor
				from	(	select 	ml.idlicitacao, 
							sum(ml.preco*ml.quantidade) as valor
						from 	ad_mapalicitacao 	ml, 
							ad_itemreq 		i, 
							ad_requisicao 		r
						where 	ml.vencedor 	= '1' 
						and 	ml.idlicitacao	=i.idlicitacao 
						and 	ml.item		=i.item 
						and 	i.idrequisicao	=r.idrequisicao
						and 	i.status in ('A','5','6','7','9') 
						and 	r.status in ('7','8','9')
					group by ml.idlicitacao
					) as v1 
					LEFT JOIN (	select 	si.idlicitacao, 
								sum(si.valorunitsuplementar*si.quantidadesuplementar) as suplemento
							from 	ad_suplementacaoitem 	si, 
								ad_itemreq 		i, 
								ad_requisicao 		r
							where 	si.idlicitacao	= i.idlicitacao 
							and 	cast(si.item as numeric)		= i.item 
							and 	i.idrequisicao	= r.idrequisicao
							and 	i.status in ('A','5','6','7','9') 
							and 	r.status in ('7','8','9')
							group by si.idlicitacao
					) v2 ON v1.idlicitacao = v2.idlicitacao 
					) ml,
					(select s.numero, 
						s.idlicitacao, 
						sum(m.preco*s.quantidade) as solicitacao 
					 from 	ad_solicitacao s, 
						ad_mapalicitacao m 
					where 	s.status IN ($filterStatus) 
					and 	vencedor='1' 
					and 	s.idlicitacao=m.idlicitacao 
					and 	s.item=m.item 
					group by s.numero, s.idlicitacao
					) s
		");
		$where = "s.idlicitacao=l.idlicitacao";
		$sql->SetWhereAnd($where);
		$sql->SetWhereAnd("(tg.item2 = 'VENCEDORES DEFINIDOS' or tg.item2 = 'EMPENHADA')");

		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Selecionar Licitação',
			20,
			0
		);
	}

	function LookupFornecedor(&$lookup)
	{
        global $MIOLO, $state;

		$session = $MIOLO->session;
	
		$filterNome = $lookup->GetFilterValue('filterNome');
		$filterNome2 = $lookup->GetFilterValue('filterNome2');
		if (!$filterNome) $filterNome = $lookup->GetFilterValue();

		$lookup->AddFilterField( 
			new TextField('filterNome',$filterNome,'Fornecedor: ',50)
		);
		$lookup->AddFilterField( 
			new TextField('filterNome2',$filterNome2,'CNPJ: ',20)
		);
		$columns = array(
			new DataGridColumn('documento','CNPJ/CPF','center',true,'20%',true), 
			new DataGridColumn('nome','Instituição','left',true,'80%',true),
		);

		$select1 = "(SELECT f.idfornecedor, i.cgc as documento, i.nome FROM cm_instituicao i, ad_fornecedor f WHERE i.idinstituicao = f.idinstituicao ";

		if($filterNome2)
		{
			$select1 .= " OR i.cgc = '$filterNome2' ";
		}

		$sql = new sql("d.idfornecedor, d.nome, d.documento", $select1." UNION SELECT f.idfornecedor, p.cpf as documento, p.nome FROM cm_pessoa p, ad_fornecedor f WHERE p.idpessoa = f.idpessoa) d ");

		if ($filterNome)
		{
			$where = "(upper(d.nome) like upper('%$filterNome%') or d.documento like '%$filterNome%')";
			$sql->SetWhere($where);
		}

		if ( $session->isRegistered("filterAntigo") )
		{
			$filterAntigo = $session->getValue("filterAntigo"); 
		}
		else
		{
			$session->register("filterAntigo");
			$session->setValue("filterAntigo",$filterNome);
			$filterAntigo = $session->getValue("filterAntigo");
		}

		if ( $filterNome != $filterAntigo )
		{
			$filterAntigo = $filterNome;
			$session->setValue("filterAntigo",$filterAntigo);
			$state->set('pn_page',1);
		}

		$sql->SetOrderBy('d.nome');
		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Selecionar Fornecedor',
			10,
			0
		);
	}
	function LookupFornecedorParticipante(&$lookup)
	{
        global $MIOLO, $state;

		$session = $MIOLO->session;

		$SESSAO = $MIOLO->getSession();
        $idLicitacao = $SESSAO->get('idLicitacao');
		
		$filterNome = $lookup->GetFilterValue('filterNome');
		$filterNome2 = $lookup->GetFilterValue('filterNome2');
		if (!$filterNome) $filterNome = $lookup->GetFilterValue();
		$lookup->AddFilterField( 
			new TextField('filterNome',$filterNome,'Fornecedor: ',50)
		);
		$lookup->AddFilterField( 
			new TextField('filterNome2',$filterNome2,'CNPJ: ',20)
		);
		$columns = array(
			new DataGridColumn('documento','CNPJ/CPF','center',true,'20%',true), 
			new DataGridColumn('nome','Instituição','left',true,'80%',true),
		);

		$select1 = "(SELECT f.idfornecedor, i.cgc as documento, i.nome FROM cm_instituicao i, ad_fornecedor f WHERE i.idinstituicao = f.idinstituicao ";

		if($filterNome2)
		{
			$select1 .= " AND i.cgc = '%$filterNome2%' ";
		}

		$sql = new sql("d.idfornecedor, d.nome, d.documento", $select1." UNION SELECT f.idfornecedor, p.cpf as documento, p.nome FROM cm_pessoa p, ad_fornecedor f WHERE p.idpessoa = f.idpessoa) d ", "d.idfornecedor not in (SELECT idfornecedor FROM ad_participante WHERE idlicitacao = $idLicitacao) ");

		if ($filterNome)
		{
			$where = "(upper(d.nome) like upper('%$filterNome%') or d.documento like '%$filterNome%') AND d.idfornecedor not in (SELECT idfornecedor FROM ad_participante WHERE idlicitacao = $idLicitacao)";
			$sql->SetWhere($where);
		}

		if ( $session->isRegistered("filterAntigo") )
		{
			$filterAntigo = $session->getValue("filterAntigo"); 
		}
		else
		{
			$session->register("filterAntigo");
			$session->setValue("filterAntigo",$filterNome);
			$filterAntigo = $session->getValue("filterAntigo");
		}

		if ( $filterNome != $filterAntigo )
		{
			$filterAntigo = $filterNome;
			$session->setValue("filterAntigo",$filterAntigo);
			$state->set('pn_page',1);
		}

		$sql->SetOrderBy('d.nome');
		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Selecionar Fornecedor',
			10,
			0
		);
	}
	
	function LookupBancoAgenciaNova(&$lookup)
    {   
		global $MIOLO;

        $filter = $lookup->GetFilterValue('filter1');
        if (!$filter) 
           $filter = $lookup->GetFilterValue();

        $fBanco = $lookup->GetFilterValue('filter0');
        if (!$fBanco) 
           $fBanco = '001';

		$fNomeAgencia = $lookup->GetFilterValue('filter2');
        if (!$fNomeAgencia) 
           $fNomeAgencia = ''; // a testar
		
        $objBanco = $MIOLO->GetBusiness('common','banco');
        $objQuery = $objBanco->ListAll();

        $lookup->AddFilterField( new Selection('filter0', $fBanco,'Banco', $objQuery->result));
        $lookup->AddFilterField( new TextField('filter1', $filter,'Num', 8));
		$lookup->AddFilterField( new TextField('filter2', $fNomeAgencia,'Nome', 10));
	
		$columns = array(
			new DataGridColumn('idagenc','Numero','left',true,'20%',true),
			new DataGridColumn('idbanco','idbanco','left',true,'0%',false),
			new DataGridColumn('nome','Agencia','left',true,'80%',true),
			new DataGridColumn('nomebanco','Banco','left',true,'80%',true)
		);

		$sql = new sql("trim(t.idagenc)||'_'||t.idbanco as key,t.idagenc,t.idbanco,t.nome,b.nome as nomebanco",'cm_agencia t,cm_banco b', 't.idbanco = b.idbanco');

        if ( $filter )
        {
            $sql->where .= " and ( t.idagenc like '%$filter%' )";
        }

        $sql->where .= " and ( t.idbanco = '{$fBanco}' )";

		
		if( $fNomeAgencia )
		{
			$sql->where .= " and ( t.nome like upper('{$fNomeAgencia}%') )";
		}
		
        $lookup->SetGrid('common',$sql,$columns,'Pesquisa Agências',15,0);
    }
	
	function LookupNomePessoaPorTipoBolsista(&$lookup)
    {   
		global $MIOLO;

        $filter = $lookup->GetFilterValue('filter1');
        if (!$filter) 
           $filter = $lookup->GetFilterValue();

        $fTipo = $lookup->GetFilterValue('filter0');
        if( ! isset($fTipo) )
           $fTipo = '2';

		$vetTipoBolsista = Array('alunos'=>'Alunos','funcs'=>'Funcionários','nofilter'=>'Sem Filtro');

        $lookup->AddFilterField( new Selection('filter0', $fTipo,'Filtrar por',$vetTipoBolsista) );
        $lookup->AddFilterField( new TextField('filter1', $filter,'Nome', 20) );

		$sql = new sql();
		
        if ( $filter )
        {
			$sql->SetTables('cm_pessoa p');
			$sql->SetColumns('p.idpessoa, p.nome, p.cpf');
			$sql->SetOrderBy('p.nome');
            $sql->where .= " ( upper(p.nome) like upper('{$filter}%') )";
        }
		
		if( $fTipo == 'alunos' )
		{
			$sql->SetTables('cm_pessoa p, ga_aluno al, ga_situacao sit');
			$sql->SetColumns('p.idpessoa, p.nome, sit.situacao, al.matricula, p.cpf');
        	$sql->SetWhereAnd("p.idpessoa = al.idpessoa");
			$sql->SetWhereAnd("al.idsituacao = sit.idsituacao");
			$sql->SetOrderBy('p.nome');

			$columns = Array(
           		new DataGridColumn('idpessoa','Id','right',true, '10%',false),
           		new DataGridColumn('nome','Nome','left', true, '70%',true),
				new DataGridColumn('situacao','Situacao','right', true, '10%',true),
		   		new DataGridColumn('matricula','Matricula','right', true, '20%',true),
				new DataGridColumn('cpf','CPF','right', true, '20%',true)
        	);
		}
		elseif( $fTipo == 'funcs' )
		{
			$sql->SetTables('cm_pessoa p, rh_funcionario f');
			$sql->SetColumns('p.idpessoa, p.nome, f.idfuncionario, p.cpf');
			$sql->SetWhereAnd("p.idpessoa = f.idpessoa");
			$sql->SetOrderBy('p.nome');
			
			$columns = Array(
           		new DataGridColumn('idpessoa','Id','right',true, '10%',false),
           		new DataGridColumn('nome','Nome','left', true, '70%',true),
		   		new DataGridColumn('idfuncionario','SIAPE','right', true, '20%',true),
				new DataGridColumn('cpf','CPF','right', true, '20%',true)
        	);
		}
		elseif( $fTipo == 'nofilter' )
		{
			$sql->SetTables('cm_pessoa p');
			$sql->SetColumns('p.idpessoa, p.nome, p.cpf');
			$sql->SetOrderBy('p.nome');

			$columns = Array(
           		new DataGridColumn('idpessoa','Id','right',true, '10%',false),
           		new DataGridColumn('nome','Nome','left', true, '70%',true),
		   		new DataGridColumn('cpf','CPF','right', true, '20%',true)
        	);
		}
        $lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa Pessoa Bolsista',15,0);
    }

/*
Função RelatorioRequisicao
Gevã Schaefer Pereira Martins
*/
  function LookupRelatorioRequisicao(&$lookup)
  {
     global $MIOLO;
	 
	 $filter = $lookup->GetFilterValue('filter');
     if (!$filter) $filter = $lookup->GetFilterValue();
	 
     $lookup->AddFilterField( new TextField('filter',$filter,'Número da Requisição'));
		
     if ( $filter )
     {
	    $sql = new sql('r.idrequisicao,r.datarequisicao,tg.item2 as status,s.siglasetor as destino'); 
       $sql->SetJoin
		   (
			"ad_requisicao r",
			"cm_tabelageral tg",
			"tg.item1 = r.status"
	       );
		  $sql->SetJoin
			(
			   "ad_requisicao r",
			   "cm_setor s",
			   "s.idsetor = r.idsetoralmox"
		    );
	   $sql->SetWhere("tg.tabela = 'AD_ALMOXSTATUSREQ'");
	    $cobaia = 'idrequisicao = ';
        $cobaia .= $filter;
        $sql->SetWhereAnd($cobaia);

	 }   
	 else
	 {

       $filter = 0;
       $sql = new sql('r.idrequisicao,r.datarequisicao,tg.item2 as status,s.siglasetor as destino'); 
       $sql->SetJoin
		   (
			"ad_requisicao r",
			"cm_tabelageral tg",
			"tg.item1 = r.status"
	       );
		  $sql->SetJoin
			(
			   "ad_requisicao r",
			   "cm_setor s",
			   "s.idsetor = r.idsetoralmox"
		    );
	   $sql->SetWhere("tg.tabela = 'AD_ALMOXSTATUSREQ'");

	 } 	  
	    
				
		$columns = array
			(
			   new DataGridColumn('idrequisicao','Número','center','','25%'),
			   new DataGridColumn('datarequisicao','Data da Requisição','center','','25%'),
			   new DataGridColumn('status','Status','center','','25%'),
			   new DataGridColumn('destino','Destino','center','','25%'),
			   new DataGridColumn('codstatus','','','','',false)
             );
		
		  
  $lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa Numero Requisição',15,0);
  }

/*
Função Ptr
Gevã Schaefer Pereira Martins 23/11/2004
*/
  function LookupPtr(&$lookup)
  {
     global $MIOLO;
	 
	 $filter = $lookup->GetFilterValue('filter');
     if (!$filter) $filter = $lookup->GetFilterValue();
	 
     $lookup->AddFilterField( new TextField('filter',$filter,'PTR'));
		
     if ( $filter )
     {
	    $sql = new sql('idptr,descricao','ad_ptr');
		$cobaia = "idptr LIKE '";
        $cobaia .= $filter . "%'";
        $sql->SetWhere($cobaia);
	 }   
	 else
	 {
       $filter = 0;
       $sql = new sql('idptr,descricao','ad_ptr');
	 } 	  
				
	$columns = array
	(
	   new DataGridColumn('idptr','Número','center','','30%'),
	   new DataGridColumn('descricao','Descrição','center','','70%'),
	);
		
		  
	$lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa Ptr',15,0);
  }

/*
Função Fonte
Gevã Schaefer Pereira Martins 24/11/2004
*/
  function LookupFonte(&$lookup)
  {
     global $MIOLO;
	 
	 $filter = $lookup->GetFilterValue('filter');
     if (!$filter) $filter = $lookup->GetFilterValue();
	 
     $lookup->AddFilterField( new TextField('filter',$filter,'Fonte'));
		
     if ( $filter )
     {
	    $sql = new sql('idfonte,descricao,fontecompleta, fonteresumida','ad_fonte');
		$cobaia = "idfonte LIKE '";
        $cobaia .= $filter . "%'";
        $sql->SetWhere($cobaia);

	 }   
	 else
	 {

       $filter = 0;
       $sql = new sql('idfonte,descricao,fontecompleta, fonteresumida','ad_fonte');

	 
	 } 	  
				
		$columns = array
			(
			   new DataGridColumn('idfonte','Número','center','','10%'),
			   new DataGridColumn('descricao','Descrição','center','','50%'),
			   new DataGridColumn('fontecompleta','Fonte Completa','center','','20%'),
			   new DataGridColumn('fonteresumida','Fonte resumida','center','','20%'),					
	         );
		


		


		  
  $lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa Fonte',15,0);

  }

/*
Função Rubrica
Gevã Schaefer Pereira Martins 24/11/2004
*/
  function LookupRubrica(&$lookup)
  {
     global $MIOLO;
	 $filter = $lookup->GetFilterValue('filter');
     if (!$filter) $filter = $lookup->GetFilterValue();
	 
     $lookup->AddFilterField( new TextField('filter',$filter,'Número ou descrição da Rubrica',45));


	 if ($filter)
     {
	 	 if ( strspn($filter,"0123456789") )
		 {
			$sql = new sql('idrubrica,descricao','ad_rubrica');
			$cobaia = "idrubrica LIKE '%";
			$cobaia = $cobaia.$filter."%'";			
			$sql->SetWhere($cobaia);
		 }   
		 else
		 {
			$sql = new sql('idrubrica,descricao','ad_rubrica');
			$cobaia = "descricao LIKE upper('%";
			$cobaia = $cobaia.$filter."%')";
			$sql->SetWhere($cobaia);
		 } 	  
     }
	 else
	 {
	    $sql = new sql('idrubrica,descricao','ad_rubrica');	 
	 }
		
	$columns = array
  	(
	   new DataGridColumn('idrubrica','Número','center','','45%'),
	   new DataGridColumn('descricao','Descrição','center','','45%'),
    );
	  
  $lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa Rubrica',15,0);
  }

/*
Gevã Schaefer Pereira Martins - 26/11/2004

*/
 
 function LookupOrcamento(&$lookup)
 {
  global $MIOLO;

    $ano = trim($lookup->GetFilterValue('filter0'));
    if (!$ano)
    	$ano = date("Y");
    $idPtr = trim($lookup->GetFilterValue('filter1'));
    $idFonte = trim($lookup->GetFilterValue('filter2'));
    $idRubrica = trim($lookup->GetFilterValue('filter3'));
    $esfera = trim($lookup->GetFilterValue('filter4'));
    //$ug = trim($lookup->GetFilterValue('filter5'));
	if (!$ano) $ano = trim($lookup->GetFilterValue());
	if (!$idPtr) $idPtr = trim($lookup->GetFilterValue());
	if (!$idFonte) $idFonte = trim($lookup->GetFilterValue());
	if (!$idRubrica) $idRubrica = trim($lookup->GetFilterValue());
	if (!$esfera) $esfera = trim($lookup->GetFilterValue());
	if (!$ug) $ug = trim($lookup->GetFilterValue());
    $lookup->AddFilterField( new TextField('filter0',trim($ano),'ANO'));    
	$lookup->AddFilterField( new TextField('filter4',trim($esfera),'ESFERA'));
	$lookup->AddFilterField( new TextField('filter1',trim($idPtr),'PTR'));
	$lookup->AddFilterField( new TextField('filter2',trim($idFonte),'FONTE'));
	$lookup->AddFilterField( new TextField('filter3',trim($idRubrica),'RUBRICA'));
	//$lookup->AddFilterField( new TextField('filter5',trim($ug),'UG'));
    $sql = new sql("idorcamento,ano,idPtr,idFonte,idRubrica,To_char((dotacao + suplementacao - bloqueio - anulacao - pago), '99999999.00') as saldo, esfera,ug",'ad_orcamento');
	$sql->SetWhere("idorcamento is not null");

    $sql->SetWhereAnd("ano = '$ano'");

	if ($idPtr)
	{
	   $sql->SetWhereAnd("idptr like '{$idPtr}%'");
	}

	if ($idFonte)
	{
	   $sql->SetWhereAnd("idfonte like '{$idFonte}%'");
	}

	if ($idRubrica)
	{
	   $sql->SetWhereAnd("idrubrica like '{$idRubrica}%'");	
	}
	if ($esfera)
	{
	   $sql->SetWhereAnd("esfera like '{$esfera}%'");	
	}
	if ($ug)
	{
	   $sql->SetWhereAnd("ug like '{$ug}%'");	
	}
	$columns = array
			(
			   new DataGridColumn('ano','ANO','center','','15%'),
			   new DataGridColumn('esfera','ESFERA','center','','15%'),
	        	   new DataGridColumn('idptr','PTR','center','','15%'),
			   new DataGridColumn('idfonte','FONTE','center','','15%'),
		           new DataGridColumn('idrubrica','RUBRICA','center','','20%'),
		           new DataGridColumn('saldo','SALDO','center','','20%'),
		           new DataGridColumn('ug','UG','center','','20%'),
	         );

	 $lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa Orcamento',15,0);
 }


 function LookupOrcamentoSemRubrica(&$lookup)
 {
  global $MIOLO;

    $ano = trim($lookup->GetFilterValue('filter0'));
    if (!$ano)
    	$ano = date("Y");
    $idPtr = trim($lookup->GetFilterValue('filter1'));
    $idFonte = trim($lookup->GetFilterValue('filter2'));
	$idRubrica = trim($lookup->GetFilterValue('filter3'));
	$esfera = trim($lookup->GetFilterValue('filter4'));

	if (!$ano) $ano = trim($lookup->GetFilterValue());
	if (!$idPtr) $idPtr = trim($lookup->GetFilterValue());
	if (!$idFonte) $idFonte = trim($lookup->GetFilterValue());
	if (!$idRubrica) $idRubrica = trim($lookup->GetFilterValue());
	if (!$esfera) $esfera = trim($lookup->GetFilterValue());

    $lookup->AddFilterField( new TextField('filter0',trim($ano),'Ano',5));    
	$lookup->AddFilterField( new TextField('filter4',trim($esfera),'Esfera',3));
	$lookup->AddFilterField( new TextField('filter1',trim($idPtr),'PTR',13));
	$lookup->AddFilterField( new TextField('filter2',trim($idFonte),'Fonte',12));
	$lookup->AddFilterField( new HiddenField('filter3',trim($idRubrica)));
	$lookup->AddFilterField( new TextLabel('',trim($idRubrica),'Rubrica'));

    $sql = new sql("idorcamento,ano,idPtr,idFonte,esfera,idRubrica,To_char((dotacao + suplementacao - bloqueio - anulacao - pago), '99999999.00') as saldo",'ad_orcamento');

	$sql->SetWhere("idorcamento is not null");

    $sql->SetWhereAnd("ano like '{$ano}%'");

	if ($idPtr)
	{
	   $sql->SetWhereAnd("idptr like '{$idPtr}%'");
	}
	if ($idFonte)
	{
	   $sql->SetWhereAnd("idfonte like '{$idFonte}%'");
	}
	if ($idRubrica)
	{
	   $sql->SetWhereAnd("idrubrica like '{$idRubrica}%'");	
	}
	if ($esfera)
	{
	   $sql->SetWhereAnd("esfera like '{$esfera}%'");	
	}

	$columns = array
			(
			   new DataGridColumn('ano','ANO','center','','12%'),
	           new DataGridColumn('esfera','ESFERA','center','','8%'),
	           new DataGridColumn('idptr','PTR','center','','20%'),
			   new DataGridColumn('idfonte','FONTE','center','','20%'),
		       new DataGridColumn('idrubrica','RUBRICA','center','','20%'),
		       new DataGridColumn('saldo','SALDO','center','','20%'),
	         );

	 $lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa Orcamento',15,0);
 }


/*
Gevã Schaefer Pereira Martins - 06/01/2004
É o Mesmo do Módulo Common

*/	
             
	function LookupMunicipio(&$lookup)
	{
		$filter = $lookup->GetFilterValue('filter');
		if ( !$filter )
		{
			$filter = $lookup->GetFilterValue();

		}
		$lookup->AddFilterField( new TextField('filter',$filter,'Municipio',20) );
		$columns = array(
			new DataGridColumn('idmunicipio','IdMunicipio','left',true,'10%',false),
			new DataGridColumn('municipio','Nome','left',true,'50%',true),
			new DataGridColumn('iduf','Estado','left','10%',true)		
			);
		$sql = new sql('m.idmunicipio,m.municipio,m.iduf,p.pais','cm_municipio m,cm_pais p','m.idpais = p.idpais');
		if ($filter)
		{
	$sql->where .= " and upper(m.municipio) LIKE upper('%$filter%')	or upper(m.idmunicipio) LIKE upper ('$filter%')		";
		}
        $lookup->SetGrid('common',$sql,$columns,'Pesquisa Municipio',15,0);
	}

 


function LookupFuncionario(&$lookup)
    {   
        $filterNome = $lookup->GetFilterValue('filterNome');

        if (!$filterNome) {
           $filterNome = $lookup->GetFilterValue();
           if (!$filterNome) {
             $filterNome = '%';
           }
        }
        $lookup->AddFilterField( new TextField('filterNome',
         $filterNome,'Nome', 40));
       $columns = array(
       new DataGridColumn('idpessoa','Id Pessoa','center',true, '15%',true),
	   new DataGridColumn('nome','Nome Funcionario','left',true, '85%',true),
        );
        $columns[0]->visible = true;
        $sql = new sql('p.idpessoa, p.nome','cm_pessoa p, rh_funcionario f');

		if ( $filterNome )
        {
          $sql->where .= " ( upper(p.nome) like upper('{$filterNome}%') )";
          $sql->where .= " AND ";
          $sql->where .= " f.idpessoa = p.idpessoa ";
		  $sql->SetOrderBy('p.nome');
        }
       
        $lookup->SetGrid('sigaept',$sql,$columns,
        ' Pesquisa de Funcionarios ',15,0);
    }

    /*+++++++
    # LookupNumeroEmpenho:
	# Filtro pelo numero do empenho
	# Grid: (ad_empenho) idempenho e numero
    --------*/

    function LookupNumeroEmpenho(&$lookup)
    {
        $filterNumeroEmpenho = $lookup->GetFilterValue('filterNumeroEmpenho');
        if (!$filterNumeroEmpenho) {
           $filterNumeroEmpenho = $lookup->GetFilterValue();
		   if(!$filterNumeroEmpenho)
		   {
		       $filterNumeroEmpenho = '%';
		   }
        }
        $lookup->AddFilterField( new TextField('filterNumeroEmpenho',
		$filterNumeroEmpenho,'Número Empenho', 30));
		$columns = array(
			new DataGridColumn('idEmpenho','Id','center',true, '0%',false),
			new DataGridColumn('numero','Número','left', true, '100%',true)
		);
		$sql = new sql("idempenho, numero",'ad_empenho');
		
		if ( $filterNumeroEmpenho )
		{
			$sql->where .= " ( numero like '%{$filterNumeroEmpenho}%' ) ";
		}
		$sql->SetOrderBy('numero');
		$lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa Empenhos',15,0);
	}

    /*+++++++
    # LookupDescRubrica:
	# Filtro pela descricao da rubrica
	# Grid: (ad_empenho) idrubrica e descricao
    --------*/

    function LookupDescRubrica(&$lookup)
    {
        $filterDescRubrica = $lookup->GetFilterValue('filterDescRubrica');
        
		if (!$filterDescRubrica)
		{
           $filterDescRubrica = $lookup->GetFilterValue();
		   if(!$filterDescRubrica)
		   {
		       $filterDescRubrica = '%';
		   }
        }
        
		$lookup->AddFilterField( new TextField('filterDescRubrica',
		$filterDescRubrica,'Descrição', 30));
		
		$columns = array(
			new DataGridColumn('idrubrica','Id','center',true, '10%',true),
			new DataGridColumn('descricao','Descrição','left', true, '90%',true)
		);
		
		$sql = new sql("idrubrica, descricao",'ad_rubrica');
		
		if ( $filterDescRubrica )
		{
			$sql->where .= " ( descricao like upper('{$filterDescRubrica}%') ) ";
		}

		$sql->SetOrderBy('descricao');
		$lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa Rubrica',15,0);
	}
    function LookupMotorista(&$lookup)
    {
        $filterMotorista = $lookup->GetFilterValue('filterMotorista');
        
		if (!$filterMotorista)
		{
			  $filterMotorista = $lookup->GetFilterValue();
			  if(!$filterMotorista)
			  {
			      $filterMotorista = '%';
			  }
		}
		$lookup->AddFilterField(new TextField('filterMotorista',$filterMotorista,'Nome do motorista', 30));
		
		$columns = array(
			new DataGridColumn('idMotorista','Id','center',true, '0%',false),
			new DataGridColumn('nome','Nome do Motorista','left', true, '100%',true)
		);

		$filterMotorista = strtoupper($filterMotorista);
		$sql = new sql("m.idmotorista, p.nome",'ad_motorista m, cm_pessoa p',"m.idpessoa=p.idpessoa and upper(p.nome) like '%$filterMotorista%' and ((m.ativo NOT LIKE 'N') OR (m.ativo is null ))");

		$sql->SetOrderBy('p.nome');
		$lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa Motorista',15,0);
	}

	function LookupVeiculo(&$lookup)
	{
		global $MIOLO;
		$filterVeiculo = $lookup->GetFilterValue('filterVeiculo');
		$SESSAO = $MIOLO->getSession();
		$tipoVeiculo = $SESSAO->get('tipoveiculo');
		if (!$filterVeiculo)
		{
			$filterVeiculo = $lookup->GetFilterValue();
			if(!$filterVeiculo)
			{
				$filterVeiculo = '%';
			}
		}

		$lookup->AddFilterField(new
		TextField('filterVeiculo',$filterVeiculo,'Placa', 30));

		$columns = array(
			new DataGridColumn('placa','Placa','left',true, '10%',true),
			new DataGridColumn('marca','Marca','left', true, '10%',true),
			new DataGridColumn('modelo','Modelo','left', true, '40%',true),
			new DataGridColumn('instituicao','Instituição','left', true, '40%',true)
		);

		$filterVeiculo = strtoupper($filterVeiculo);

		$sql = new sql("i.instituicao,v.placa,v.marca,v.modelo,v.modelo||' - '||v.placa as modeloplaca",'ad_veiculo v,cm_instituicao i', "i.idinstituicao = v.idinstituicao and upper(v.placa) like '%$filterVeiculo%'");
		
		$sql->SetOrderBy('v.modelo');
		$lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa de Veículos',15,0);
	}



	/*  Função Antiga
    function LookupVeiculo(&$lookup)
    {	
    	global $MIOLO;
        $filterVeiculo = $lookup->GetFilterValue('filterVeiculo');
        $SESSAO = $MIOLO->getSession();
        $tipoVeiculo = $SESSAO->get('tipoveiculo');
		if (!$filterVeiculo)
		{
           $filterVeiculo = $lookup->GetFilterValue();
		   if(!$filterVeiculo)
		   {
		       $filterVeiculo = 'A DEFINIR';
		   }
        }
        
		$lookup->AddFilterField(new TextField('filterVeiculo',$filterVeiculo,'Placa', 30));
		
		$columns = array(
			new DataGridColumn('placa','Placa','left',true, '33%',true),
			new DataGridColumn('marca','Marca','left', true, '33%',true),
			new DataGridColumn('modelo','Modelo','left', true, '33%',true)
		);
		
		$sql = new sql("placa,marca,modelo,modelo||' - '||placa as modeloplaca",'ad_veiculo');
		$sql->where .= " tipoveiculo = '$tipoVeiculo' ";
		if ( $filterDescRubrica )
		{
			$sql->where .= " ( placa like upper('{$filterVeiculo}%') ) ";
		}

		$sql->SetOrderBy('modelo');
		$lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa de Veículos',15,0);
	}
*/

    function LookupPessoaPorSIAPE(&$lookup)
    {
        $filterSIAPE = $lookup->GetFilterValue('filterSIAPE');

        if(!$filterSIAPE)
        {
            $filterSIAPE= $lookup->GetFilterValue();

            if (!$filterSIAPE)
                $filterSIAPE = '%';
        }

        $lookup->AddFilterField( new TextField('filterSIAPE', $filterSIAPE,'SIAPE', 15));

        $columns = array(
            new DataGridColumn('idvinculo','SIAPE','left', true, '20%',true),
            new DataGridColumn('nome','Nome','left', true, '70%',true)
        );

        $sql = new sql("v.idvinculo,p.nome",'cm_pessoa p, rh_funcionario f, rh_vinculo v');

        if ( $filterSIAPE )
        {
            $sql->SetOrderBy('v.idvinculo');            
            $sql->where .= " (p.idpessoa = f.idpessoa) AND (f.idfuncionario = v.idfuncionario) ";
            $sql->where .= " AND ( upper(v.idvinculo) like upper('{$filterSIAPE}%') ) ";
        }
        $lookup->SetGrid('sigaept',$sql,$columns,' Pesquisa SIAPE ',15,0);
    }

		/* ---------------------------------------

	Método LookupServicoExterno

	Gera o Lookup de servico externo com
	busca na tabela ad_servico
	/modulos/adm/classes
	----------------------------------------*/
	
	function LookupServicoExterno(&$lookup)
	{
        $codservico = (intval($lookup->GetFilterValue('filter'))) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('codservico');
        $descricao = (!$codservico && $lookup->GetFilterValue('filter')) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('descricao');
        $lookup->AddFilterField(new Text('','Digite o código:'));
		$lookup->AddFilterField(new TextField('codservico',$codservico,'',12));
        $lookup->AddFilterField(new Text('','ou a descrição:'));
        $lookup->AddFilterField(new TextField('descricao',$descricao,'',30));
        if (!$descricao || $codservico) $descricao = '%';
		$columns = array(
			new DataGridColumn('idservico','Código','left',true,'10%',false),
			new DataGridColumn('codservico','Código','left',true,'10%',true),			
			new DataGridColumn('descricao','Nome','left',true,'70%',true),
		);
		$sql = new sql();
		$sql->SetColumns('
			idservico,
			codservico,
			descricao			
		');
		$sql->SetTables('
			ad_servico
		');
		if ($codservico || $descricao)
		{
			$where = "(upper(ativo) = 'S' and upper(descricao) like upper('%$descricao%')) or (upper(ativo) = 'S' and cast(codservico as varchar) = '$codservico')";
			$sql->SetWhere($where);
		}
		$sql->SetOrderBy('descricao');
		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Pesquisa de Serviço',
			10,
			0
		);
	}
	
    function LookupDependencia(&$lookup)
    {
		$filterDependencia = $lookup->GetFilterValue('filter0');
		if (!$filterDependencia)
			$filterDependencia = '%';

		$filterIdSetor = $lookup->GetFilterValue('filter1');
		$filterSetor = $lookup->GetFilterValue('filter2');

		$lookup->AddFilterField( 
			new HiddenField('filter2',$filterSetor)
		);
		$lookup->AddFilterField( 
			new TextLabel('filter3',$filterSetor,'Setor: ',50)
		);
		
		$lookup->AddFilterField(
			new TextField('filter0',$filterDependencia, 'Dependência:')
		);

		$lookup->AddFilterField(
			new HiddenField('filter1',$filterIdSetor)
		);

        $columns = array(
            new DataGridColumn('dependencia','Dependência','left', true, '100%',true)
        );

        $sql = new sql("iddependencia,dependencia",'ad_dependencia');

        if ( $filterDependencia && $filterIdSetor)
        {
            $sql->SetOrderBy('dependencia');
            $sql->where .= " ( upper(dependencia) like upper('{$filterDependencia}%') and idsetor = $filterIdSetor) ";
        }
        $lookup->SetGrid('sigaept',$sql,$columns,' Pesquisa Dependência ',15,0);
    }

	function LookupClassificador(&$lookup)
    {
        $filter = $lookup->GetFilterValue('filter');

        if(!$filter)
        {
            $filter= $lookup->GetFilterValue();

            if (!$filter)
                $filter = '%';
        }

        $lookup->AddFilterField( new TextField('filter', $filter,'Classificador', 40));

        $columns = array(
            new DataGridColumn('idclassificador','Classificador','left', true, '20%',true),
            new DataGridColumn('descricao','Descrição','left', true, '80%',true),
        );

        $sql = new sql("idclassificador,descricao",'ad_classificador');

        if ( $filter )
        {
            $sql->SetOrderBy('descricao');
            $sql->where .= " ( upper(descricao) like upper('%{$filter}%') OR upper(idclassificador) like upper('{$filter}%') ) ";
        }
        $lookup->SetGrid('sigaept',$sql,$columns,' Pesquisa Classificador ',15,0);
    }
    
    function LookupRequisicaoOriginal(&$lookup)
    {
        $filter = $lookup->GetFilterValue('filter');

        if(!$filter)
        {
            $filter= $lookup->GetFilterValue();

            if (!$filter)
                $filter = '%';
        }

        $lookup->AddFilterField( new TextField('filter', $filter,'Requisição', 15));
        
        $columns = array(
            new DataGridColumn('idRequisicao','Req.','center', true, '20%',true),
            new DataGridColumn('nome','Nome','left', true, '80%',true)
        );

        $sql = new sql("r.idrequisicao,i.idvinculo,p.nome",'ad_requisicao r, ad_itemreqdiaria i, cm_pessoa p, rh_funcionario f, rh_vinculo v');

        if ( $filter )
        {
            $sql->SetOrderBy('r.datahorareq');
            $sql->where .= " (r.idrequisicao = i.idrequisicao) AND (i.idvinculo = v.idvinculo) ";
            $sql->where .= " AND (p.idpessoa = f.idpessoa) AND (f.idfuncionario = v.idfuncionario) ";
            $sql->where .= " AND r.tiporequisicao = '5' AND r.status <> '1' AND r.status <> 'I' AND r.status <> '2' AND r.status <> 'A'";
            $sql->where .= " AND (r.idrequisicao like '{$filter}%' ) ";
        }

        $lookup->SetGrid('sigaept',$sql,$columns,' Pesquisa Requisição ',15,0);        
    }

    function LookupLicitacaoEmpenho(&$lookup)
	{
		global $MIOLO; 
		$filterNumero = $lookup->GetFilterValue('filter0');
		$filterTipo = $lookup->GetFilterValue('filter1');

		$lookup->AddFilterField( 
			new TextField('filter0',$filterNumero,'Licitação: ',50)
		);
		
		$lookup->AddFilterField(
			new HiddenField('filter1',$filterTipo)
		);

		$columns = array(
			new DataGridColumn('idlicitacao','','left',true,'',false),
			new DataGridColumn('numero','Número','center',true,'25%',true),
			new DataGridColumn('dataabertura','Data de Abertura','center',true,'25%',true),
			new DataGridColumn('idModalidadeLicitacao','Modalidade','center',true,'',false),
			new DataGridColumn('imediato','Imediato','center',true,'',false),	
			new DataGridColumn('idTipoLicitacao','Modalidade','center',true,'',false),

			new DataGridColumn('descricao','Modalidade','center',true,'15%',true),
			new DataGridColumn('valor','Valor Licitação','center',true,'20%',true),
			new DataGridColumn('empenhado','Valor Empenhado','center',true,'15%',true),
		);
		$db=$MIOLO->getdatabase('sigaept');
		$sql = new sql();
		$sql->SetWhere("tg.tabela = 'AD_ALMOXSTATUSLIC' and tg.item1 = l.status and ml.idlicitacao=l.idlicitacao");
		$sql->SetOrderBy('l.idlicitacao');

		$sql->SetColumns(
			'l.idlicitacao,
			l.numero,'
			.$db->datetochar("l.dataabertura").',
			l.idModalidadeLicitacao,
			l.imediato,
			l.idtipolicitacao,
			modL.descricao,
			ml.valor,
			d.empenhado
		');
		$sql->SetTables("
			ad_licitacao l,
			cm_tabelageral tg,
			(select d.idlicitacao, sum(d.valoremp) as empenhado 
			from ad_empenhado d, ad_itemreq i, ad_requisicao r
			where d.idlicitacao=i.idlicitacao and d.item=i.item and i.idrequisicao=r.idrequisicao
			and i.status in ('A','5','6','7','9') and r.status in ('7','8','9')
			group by d.idlicitacao
			) d,
			(select v1.idlicitacao, v1.valor+NVL(v2.suplemento,0) as valor
			from 
			(select ml.idlicitacao, sum(ml.preco*ml.quantidade) as valor
			from ad_mapalicitacao ml, ad_itemreq i, ad_requisicao r
			where ml.vencedor = '1' and ml.idlicitacao=i.idlicitacao and ml.item=i.item and i.idrequisicao=r.idrequisicao
			and i.status in ('A','5','6','7','9') and r.status in ('7','8','9')
			group by ml.idlicitacao
			) v1,
			(select si.idlicitacao, sum(si.valorunitsuplementar*si.quantidadesuplementar) as suplemento
			from ad_suplementacaoitem si, ad_itemreq i, ad_requisicao r
			where si.idlicitacao=i.idlicitacao and si.item=i.item and i.idrequisicao=r.idrequisicao
			and i.status in ('A','5','6','7','9') and r.status in ('7','8','9')
			group by si.idlicitacao
			) v2
			where v1.idlicitacao = v2.idlicitacao(+)
			) ml, 
			ad_modalidadelicitacao modL
		");
		$where = "l.idlicitacao=d.idlicitacao(+)";
		$sql->SetWhereAnd($where);
		$sql->SetWhereAnd("(tg.item2 = 'VENCEDORES DEFINIDOS' or tg.item2 = 'EMPENHADA')");
		$sql->SetWhereAnd("(l.idModalidadeLicitacao = modL.idModalidadeLicitacao)");
	 	$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Selecionar Licitação',
			20,
			0
		);
	}
function LookupLicitacaoEmpenho2(&$lookup)
	{
		global $MIOLO; 
		$filterNumero = $lookup->GetFilterValue('filter0');
		if (!$filterNumero) $filterNumero = strtoupper($lookup->GetFilterValue());
		$lookup->AddFilterField( 
			new TextField('filter0',$filterNumero,'Licitação: ',50)
		);
		$columns = array(
			new DataGridColumn('idlicitacao','','left',true,'',false),
			new DataGridColumn('numero','Número','center',true,'70%',true),
			new DataGridColumn('dataabertura','Data de Abertura','center',true,'30%',true),
			new DataGridColumn('idModalidadeLicitacao','Modalidade','center',true,'',false),
			new DataGridColumn('imediato','Imediato','center',true,'',false),	
			new DataGridColumn('idTipoLicitacao','Modalidade','center',true,'',false),

		);
		$db=$MIOLO->getdatabase('sigaept');
		$sql = new sql();
		$sql->SetOrderBy('l.idlicitacao');
		$sql->SetColumns(
			'l.idlicitacao,
			l.numero,'
			.$db->datetochar("l.dataabertura").',
			l.idModalidadeLicitacao,
			l.imediato,
			l.idtipolicitacao
		');
		$sql->SetTables("
			ad_licitacao l
		");
		if(is_null($filterNumero)){
			$where = " ";
		}else{
			$where = " l.numero like '%$filterNumero%'";
		}
		
		$sql->SetWhereAnd($where);
		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Selecionar Licitação',
			20,
			0
		);
	}

 function LookupFornecedorEmpenho(&$lookup)
	{
		$filterNome = $lookup->GetFilterValue('filterNome');
		$filterNome2 = $lookup->GetFilterValue('filterNome2');
		
		if (!$filterNome) $filterNome = $lookup->GetFilterValue();
		if (!$filterNome2) $filterNome2 = $lookup->GetFilterValue();
			
		$lookup->AddFilterField( 
			new TextField('filterNome',$filterNome,'Fornecedor: ',50)
		);
		$lookup->AddFilterField( 
			new TextField('filterNome2',$filterNome2,'CNPJ: ',40)
		);
		$columns = array(
			new DataGridColumn('cgc','CNPJ/CPF','center',true,'20%',true), 
			new DataGridColumn('nome','Instituição','left',true,'80%',true),
		);

		
		$sql = new sql();
		$sql->SetColumns(
			'f.idfornecedor, i.cgc, i.nome');
		$sql->SetTables("cm_instituicao i, ad_fornecedor f");
		$where=" i.idinstituicao = f.idinstituicao ";
		if($filterNome2)
		{
			$where= $where . "AND i.cgc ='$filterNome2' ";
		}
		if ($filterNome)
		{
			$where =$where ."AND i.nome like '%".strtoupper($filterNome)."%'";
		}
		$sql->SetWhere($where);
		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Selecionar Fornecedor',
			10,
			0
		);
	}

	function LookupEmpenho(&$lookup)
	{
		$filterNumero = $lookup->GetFilterValue('filter0');
		$filterStatus = $lookup->GetFilterValue('filter1');

		if (!$filterNumero)
		{
			$filterNumero = $lookup->GetFilterValue('filter');
		}

		$lookup->AddFilterField( 
			new MTextField('filter0',$filterNumero,'Empenho: ',50)
		);
		$lookup->AddFilterField( 
			new MHiddenField('filter1',$filterStatus)
		);
		
		$columns = array(
			new DataGridColumn('idempenho','','left',true,'',false),
			new DataGridColumn('empenho','Empenho','center',true,'15%',true),
			new DataGridColumn('dataempenho','Data Abertura','center',true,'15%',true),
			new DataGridColumn('licitacao','Licitação','center',true,'15%',true),
			new DataGridColumn('fornecedor','Fornecedor','left',true,'45%',true),
			new DataGridColumn('valor','Valor','right',true,'10%',true),
			new DataGridColumn('ug','UG','right',true,'10%',true),		
		);
		$sql = new sql();
		$sql->SetWhere("tg.tabela = 'AD_EMPENHOSTATUS' and tg.item1 = e.status and e.idempenho=d.idempenho and e.idfornecedor=f.idfornecedor and f.idinstituicao=i.idinstituicao and d.idlicitacao=l.idlicitacao");

		if ($filterNumero)
		{
			$where = "e.numero like '%$filterNumero%'";
			$sql->SetWhereAnd($where);
		}

		$sql->SetColumns("
			e.idempenho,
			e.numero as empenho,
			e.dataempenho,
			l.numero as licitacao,
			sum(d.valoremp) as valor,
			i.nome as fornecedor,
			e.ug as ug			
		");
		$sql->SetTables("
			ad_empenho e,
			ad_empenhado d,
			ad_fornecedor f,
			cm_instituicao i,
			ad_licitacao l,
			cm_tabelageral tg
		");
		if($filterStatus)
		{
			$status = explode(',',$filterStatus);
			$stringStatus = "";
			foreach($status as $s)
			{
				$stringStatus .= "'".$s."',";
			}
			$stringStatus = substr($stringStatus,0,-1);
			$sql->SetWhereAnd("(tg.item1 IN (".$stringStatus."))");
		}
		$sql->SetOrderBy('e.numero');
		$sql->SetGroupBy('e.idempenho,e.numero,e.dataempenho,l.numero,i.nome,e.ug');

		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Selecionar Empenho',
			20,
			0
		);
	}

	function LookupRequisicaoSuplementar(&$lookup)
	{
		$filterNumero = $lookup->GetFilterValue('filter0');

		$lookup->AddFilterField( 
			new MTextField('filter0',$filterNumero,'Requisição: ',20)
		);
		
		$columns = array(
			new DataGridColumn('idrequisicao','Requisição','center',true,'15%'),
			new DataGridColumn('datahorareq','Data','center',true,'15%',true),
			new DataGridColumn('requisitante','Requisitante','left',true,'55%',true),
			new DataGridColumn('uorequisitante','UO Requisitante','left',true,'15%',true),
		);
		$sql = new sql();
		$sql->SetWhere("r.idusuarioreq = u.idusuario and u.idpessoa = p.idpessoa and r.iduoreq = uo.iduo and r.status = '4' and r.suplementar = 'S'");

		if ($filterNumero and is_numeric($filterNumero))
		{
            $where = "r.idrequisicao = $filterNumero";
			$sql->SetWhereAnd($where);
		}

		$sql->SetColumns("
			r.idrequisicao,
			to_char(r.datahorareq, 'dd/mm/yyyy') as datahorareq,
			p.nome as requisitante,
			uo.sigla as uorequisitante
		");
		$sql->SetTables("
			ad_requisicao r,
			cm_usuario u,
			cm_pessoa p,
			ad_uo uo
		");
		$sql->SetOrderBy('r.idrequisicao');

		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Selecionar Requisição Suplementar',
			20,
			0
		);
	}
	function LookupExeRubrica(&$lookup)
	{
    	global $MIOLO;

		$SESSAO = $MIOLO->getSession();
        $idTipoReq = $SESSAO->get('tiporeq');
        $filter = $lookup->GetFilterValue('filter');
     	if (!$filter) $filter = $lookup->GetFilterValue();
     	$lookup->AddFilterField( new TextField('filter',$filter,'Número ou descrição da Rubrica',45));
	
	 	if ($filter)
     	{
	 	 		$sql = new sql('rq.idrubrica, r.descricao ','ad_reqrubrica rq, ad_rubrica r');
				$where = "rq.idrubrica = r.idrubrica AND rq.idrubrica = '%$filter%' AND idtiporeq = $idTipoReq";
				$sql->SetWhere($where);		 	 
     	}
	 	else
	 	{
		    	$sql = new sql('rq.idrubrica, r.descricao ','ad_reqrubrica rq, ad_rubrica r');
		    	$where = "rq.idrubrica = r.idrubrica AND idtiporeq = $idTipoReq";	 
		    	$sql->SetWhere($where);		 	 
	 	}
			
		$columns = array(
	   		new DataGridColumn('idrubrica','Número','center','','45%'),
	   		new DataGridColumn('descricao','Descrição','center','','45%'),
    					);
	  
  		$lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa Rubrica',15,0);
  	}
	function LookupEmpresaManutencaoVeiculo(&$lookup)
    	{	
	    	global $MIOLO;
	        $filter = $lookup->GetFilterValue('filter');
	        $lookup->AddFilterField( new TextField('filter',$filter,'Nome Empresa',45));
	        if (!$filter)
		{
	        	$filter = $lookup->GetFilterValue();
			if(!$filter)
			{
				$filter = '%';
			}
        	}
        
		$columns = array(
			new DataGridColumn('idempresa','Id','left',true, '20%',true),
			new DataGridColumn('nome','Nome','left', true, '30%',true),
			new DataGridColumn('cnpj','CNPJ','left', true, '20%',true),
			new DataGridColumn('razaoSocial','Razão Social','left', true, '30%',true)
				);
		
		$sql = new sql("idempresa, nome, cnpj, razaosocial",'ad_empresamanutencaoveiculo');
		$sql->where .= " ( nome like upper('{$filter}%') ) ";
		$sql->SetOrderBy('nome');
		$lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa de Empresas',15,0);
	}	
	function LookupPrevRevisao(&$lookup)
    	{	
	    	global $MIOLO;
	    	
	    	$session = $MIOLO->getSession();
	    	$placa = $session->get('varplaca');
	        $filter = $lookup->GetFilterValue('filter');
	        if (!$filter)
		{
        		$filter = $lookup->GetFilterValue();
			if(!$filter)
			{
				$filter = '%';
			}
        	}
        
		$columns = array(
			new DataGridColumn('idprevrevisao','Id','left',true, '10%',true),
			new DataGridColumn('placa','Placa','left', true, '30%',true),
			new DataGridColumn('data_prevista','Data Prevista','left', true, '60%',true),
				);
		
		$sql = new sql("idprevrevisao, placa,TO_CHAR(data_prevista,'DD/MM/YYYY') as data_prevista",'ad_prevrevisao');
		$sql->where .= " ( placa = ('$placa') AND situacao = '1') ";
		$sql->SetOrderBy('data_prevista');
		$lookup->SetGrid('sigaept',$sql,$columns,'Pesquisa de Previsões',15,0);
	}
	function LookupTipoManutencao(&$lookup)
    	{	
	    	global $MIOLO;
	        $filter = $lookup->GetFilterValue('filter');
	        $lookup->AddFilterField( new TextField('filter',$filter,'Tipo de Manutenção',45));
	        if (!$filter)
		{
	        	$filter = $lookup->GetFilterValue();
			if(!$filter)
			{
				$filter = '%';
			}
	        }
        
		$columns = array(
			new DataGridColumn('id','Id','left',true, '30%',true),
			new DataGridColumn('tipomanutencao','Tipo','left', true, '70%',true)
				);
		
		$sql = new sql("idtipomanutencao, tipomanutencao",'ad_tipomanutencao');
		$sql->where .= " ( tipomanutencao like upper('{$filter}%') ) ";
		$sql->SetOrderBy('tipomanutencao');
		$lookup->SetGrid('sigaept',$sql,$columns,'Tipo de Manutenção',15,0);
	}
	
	// Depreciação Patrimônio - Inicio

	public function lookupContaContabil(&$lookup)
	{
		$filter = $lookup->getFilterValue('filter');

		$lookup->addFilterField(new TextField('filter', $filter, 'Conta Contábil', 50));
		$columns = array(
			new DataGridColumn('idvidautil', 'Conta Contábil', 'right', true, '10%', true),
			new DataGridColumn('descricao', 'Descrição', 'left', true, '65%', true),
			new DataGridColumn('anosvidautil', 'Vida útil', 'right', true, '10%', true),
			new DataGridColumn('valorresidual', 'Valor residual', 'right', true, '15%', true),
		);
		$sql = new sql('idvidautil,descricao,anosvidautil,valorresidual', 'ad_vidautil', '', 'descricao');
		if ($filter != '')
		{
			$sql->where .= " descricao like upper('%" . $filter . "%')";
		}
		$lookup->SetGrid('sigaept', $sql, $columns, 'Pesquisa Contas Contábeis', 20, 0);
	}
		
	// Depreciação Patrimônio - Fim
	
		
	/* ---------------------------------------

	Método LookupUoAtiva()

	Gera o Lookup de uos ativas com
	busca na tabela ad_uo.

	----------------------------------------*/
	
	function LookupUoAtiva(&$lookup)
	{
		$filterNome = $lookup->GetFilterValue('filterNome');
		if (!$filterNome) $filterNome = $lookup->GetFilterValue();
		if (!$filterNome) $filterNome = '%';
		$lookup->AddFilterField( 
			new TextField('filterNome',$filterNome,'Sigla da U.O.',50)
		);
		$columns = array(
			new DataGridColumn('nome','Nome','left',true,'85%',true),
		);
		$sql = new sql();
		$sql->SetColumns('
			iduo,
			nome
		');
		$sql->SetTables('
			ad_uo
		');
		if ($filterNome)
		{
			$where = "upper(sigla) like upper('$filterNome%') and ativo = 'S' ";
			$sql->SetWhere($where);
		}
		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Pesquisa de U.O.',
			10,
			0
		);
	}
	
	
	/* ---------------------------------------

	Método LookupMaterialAcervoSetorial()

	Gera o Lookup de material de Acervo Setorial com
	busca na tabela ad_material.

	----------------------------------------*/
	
	function LookupMaterialAcervoSetorial(&$lookup)
	{
		global $MIOLO, $page, $state;

		$session = $MIOLO->session;
        $codmaterial = (intval($lookup->GetFilterValue('filter'))) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('codmaterial');
        $descricao = (!$codmaterial && $lookup->GetFilterValue('filter')) ? $lookup->GetFilterValue('filter') : $lookup->GetFilterValue('descricao');
        $lookup->AddFilterField(new Text('','Digite o código:'));
		$lookup->AddFilterField(new TextField('codmaterial',$codmaterial,'',14));
        $lookup->AddFilterField(new Text('','ou a descrição:'));
        $lookup->AddFilterField(new TextField('descricao',$descricao,'',30));
        $codmaterial = trim($codmaterial);
        $descricao = trim($descricao);
		$columns = array(
			new DataGridColumn('idmaterial','Código','left',true,'10%',false),
			new DataGridColumn('codmaterial','Código','left',true,'10%',true),
			new DataGridColumn('unidade','Un','left',true,'10%',true),
                        new DataGridColumn('precoestimado','Valor Unitário R$','left',true,'10%',true),
			new DataGridColumn('descricao','Nome','left',true,'60%',true),
                        
		);
		$sql = new sql();
		$sql->SetColumns('
			idmaterial,
			descricao,
			codmaterial,
                        unidade,
                        precoestimado
               
		');
		$sql->SetTables('
			ad_material
		');
		if ($codmaterial)
			$where = "(upper(ativo) = 'S' and (" . ($descricao ? "upper(descricao) like upper('%$descricao%') or " : '') . "cast(codmaterial as varchar) = '$codmaterial') and idelemento = '449052' and idsubelemento='18')"; 
		else
			$where = "(upper(ativo) = 'S' and " . ($descricao ? "upper(descricao) like upper('%$descricao%') and " : '') . "idelemento = '449052' and idsubelemento='18')"; 
    $sql->SetWhere($where);
		$sql->SetOrderBy('descricao');

		if ( $session->isRegistered("filterAntigo") )
		{
			$filterAntigo = $session->getValue("filterAntigo"); 
		}
		else
		{
			$session->register("filterAntigo");
			$session->setValue("filterAntigo",$descricao);
			$filterAntigo = $session->getValue("filterAntigo");
		}

		if ( $descricao != $filterAntigo )
		{
			$filterAntigo = $descricao;
			$session->setValue("filterAntigo",$filterAntigo);
			$state->set('pn_page',1);
		}

		$lookup->SetGrid(
			'sigaept',
			$sql,
			$columns,
			'Pesquisa de Material',
			10,
			0
		);
	}

	
}
?>
