
<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>

<?
class frmLicitacaoJulgamento extends Form
{
	protected $objLicitacao;    

	function __construct($licitacao)
	{
 		global $MIOLO;
        
        $this->objLicitacao = $licitacao;
        $this->Form('Julgamento');
        $this->EventHandler();        
	}
	
	Function CreateFields()
	{
		global $MIOLO,$module,$item,$self;		
        
		$fields = array(
			new TextField('membro1','','Membro 1',50),
			new TextField('membro2','','Membro 2',50),
 			new TextField('membro3','','Membro 3',50),
            new CalendarField('dataJulgamento',date("d/m/Y"),'Data',10)
        );
		
        $this->SetFields($fields);    
        $this->SetClose(NULL);        

		$buttons = Array(
        	new FormButton('btnGerarRelatorio','Gerar Relatório','pdf')
		);
		$this->SetButtons($buttons);	
	}	

	function btnGerarRelatorio_click()
	{
		global $MIOLO,$module,$item;
		$idLicitacao = $item;
		$objLicitacao = $MIOLO->GetBusiness($module,'licitacao',$idLicitacao);

 	    $membro1 = $this->GetFieldValue('membro1');
 	    $membro2 = $this->GetFieldValue('membro2');
 	    $membro3 = $this->GetFieldValue('membro3');
 	    $dataJulgamento = $this->GetFormValue('dataJulgamento');


		if($objLicitacao->status <= 2)
		{
			$MIOLO->Error('Julgamento ainda não definido para essa licitação!');
		}
		else
		{
			$report = new MEzPDFReport('2','portrait');		
			$h  = $report->pdf->getFontHeight(10);
			$ui = $this->manager->GetUI();
			$image = $ui->GetImageSrc('logonet.png');//correção, erro no quente
			$report->pdf->ezImage($image,5,50,'none','left',0); //correção, erro no quente
			//$report->pdf->ezImage($ui->GetImage('','logonet.png'),5,50,'none','left',0);
			$report->pdf->addText(110,810       ,10,'UFJF - UNIVERSIDADE FEDERAL DE JUIZ DE FORA');
			$report->pdf->addText(110,810-$h    ,10,'CGCO - CENTRO DE GESTÃO DO CONHECIMENTO ORGANIZACIONAL');
			$report->pdf->addText(110,810-(2*$h),10,'SIGA - SISTEMA INTEGRADO DE GESTÃO ACADÊMICA');
			$report->pdf->addText(110,810-(3*$h),10,'COSUP - COORDENADORIA DE SUPRIMENTOS');
			$report->pdf->ezSetY(810-5*$h);
			$report->pdf->ezText ('<b>JULGAMENTO</b>',16,array('justification'=>'center'));
			$report->pdf->ezText ('<b>Licitação Nº '.$objLicitacao->numero.'</b>',10,array('justification'=>'center'));
			$report->pdf->ezText ('',40);
			$report->pdf->addText(200,810-(11*$h),10,'A Comissão de Licitação, abaixo assinada, procedendo o exame das propostas');
			$report->pdf->addText(110,810-(12*$h),10,'ofertadas na presente licitação, apresenta o resultado do julgamento das mesmas, na conformidade');
			$report->pdf->addText(110,810-(13*$h),10,'do Quadro demostrativo anexo.');
	
			$this->objLicitacao->retrieveAssociation('itens');
			$offSet = 16;
			foreach($this->objLicitacao->itens as $item){
				$id = $this->objLicitacao->GetParticipanteVencedor($item->idLicitacao,$item->item);
				$vencedores[$id] = $id;
			}
			foreach($vencedores as $idVencedor){
				$objFornecedor = $MIOLO->GetBusiness('adm','fornecedor',$idVencedor);
				$objFornecedor->retrieveAssociation('instituicao');
				$report->pdf->addText(110,810-($offSet*$h),10,'<b>'.$objFornecedor->instituicao->nome.'</b>');
				$offSet++;

			}

            $mes["01"] = "Janeiro";
            $mes["02"] = "Fevereiro";
            $mes["03"] = "Março";
            $mes["04"] = "Abril";
            $mes["05"] = "Maio";
            $mes["06"] = "Junho";
            $mes["07"] = "Julho";
            $mes["08"] = "Agosto";
            $mes["09"] = "Setembro";
            $mes["10"] = "Outubro";
            $mes["11"] = "Novembro";
            $mes["12"] = "Dezembro";

			/*
			$list = $this->objLicitacao->ListParticipantes()->result;
			if($list){
				foreach($list as $l)
				{
					$empresa = $l[1];
					$report->pdf->addText(110,810-($offSet*$h),10,'<b>'.$empresa.'</b>');
					$offSet++;
				}
			}*/
			$offSet++;
			$offSet++;		
			$dataAtual = substr($dataJulgamento,0,2)." de ".$mes[substr($dataJulgamento,3,2)]." de ".substr($dataJulgamento,6,4);
			$report->pdf->addText(250,810-($offSet*$h),10,'Juiz de Fora, '.$dataAtual);
			$offSet++;
			$offSet++;
			$offSet++;
			$offSet++;
			$offSet++;
			$offSet++;
			$offSet++;
			$offSet++;
			$report->pdf->line(110,810-($offSet*$h),265,810-($offSet*$h));
			$report->pdf->line(410,810-($offSet*$h),565,810-($offSet*$h));
			$offSet++;
			$report->pdf->addText(110,810-($offSet*$h),10,$membro1);
			$report->pdf->addText(410,810-($offSet*$h),10,$membro2);
			$offSet++;
			$report->pdf->addText(110,810-($offSet*$h),10,'Membro da Comissão Permanente');
			$report->pdf->addText(410,810-($offSet*$h),10,'Membro da Comissão Permanente');
			$offSet++;
			$report->pdf->addText(110,810-($offSet*$h),10,'de Licitação');
			$report->pdf->addText(410,810-($offSet*$h),10,'de Licitação');
			$offSet++;
			$offSet++;
			$offSet++;
			$offSet++;
			$offSet++;
			$offSet++;
			$report->pdf->line(260,810-($offSet*$h),415,810-($offSet*$h));
			$offSet++;
			$report->pdf->addText(260,810-($offSet*$h),10,$membro3);
			$offSet++;
			$report->pdf->addText(260,810-($offSet*$h),10,'Membro da Comissão Permanente');
			$offSet++;
			$report->pdf->addText(260,810-($offSet*$h),10,'de Licitação');
			$report->Execute();
		}
    }	
}
?>
