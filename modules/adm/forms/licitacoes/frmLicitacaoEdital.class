
<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>

<?
class frmLicitacaoEdital extends MForm
{
    protected $licitacao;
    protected $protocolo;
	function __construct($licitacao)
	{   
        global $MIOLO;
        $this->licitacao = $licitacao;
        $this->protocolo = $MIOLO->getBusiness('protocolo','processo');
		parent::__construct('Imprimir Edital de Licitação');
		$this->eventHandler();
	}
	
    function createFields()
	{
		$this->addField(new MCalendarField('dataEdital',date('d/m/Y'),'Data'));
		$this->addField(new MSelection('participantes','','Participante'));
		$this->addButton(new MButton('btnReport','Exibir Relatório','pdf'));
		$this->setFieldAttr('participantes', 'options', $this->licitacao->listParticipantes()->result);
		$this->participantes->setOption('', 'TODOS');
	}

	function btnReport_click()
	{
		$participantes = $this->licitacao->listParticipantes();
		$report = new MEzPDFReport('2','portrait');
		$totalParticipantes= count($participantes->result);
		$i=0;

		if($totalParticipantes>0)
        {
			if($this->getFieldValue('participantes') == '')
			{
				foreach($participantes->result as $partipante)
                {
					$i++;
					$this->generateBodyReport($partipante,$report);
					if($i < $totalParticipantes)
                    {
						$report->pdf->ezNewPage();
					}
				}
			}
			else
			{
				$participante = array($this->getFieldValue('participantes'));
				$this->generateBodyReport($participante,$report);
			}
		}
        else
        {
			$report->pdf->ezText("Não há participantes cadastrados.",14,array("justification"=>"center","spacing"=>"1"));
		}
		$report->Execute();
	}

	function getTextoMaterial($report)
    {
		$report->pdf->ezText("01) Proposta em papel impresso da empresa contendo a razão social, CGC, e inscrição, em 01(uma) via sem rasuras ou emendas. Não será aceito documento copiado por FAX;",11);
		$report->pdf->ezText("02) Oferecimento pela empresa do preço unitário por item, inclusos impostos, taxas, frete, embalagem, montagem e/ou instalação, descontos, com a cotação do preço do material posto no ALMOX. CENTRAL da UFJF-Cid. Universitária - Juiz de Fora-MG;",11);
		$report->pdf->ezText("03) Constar na proposta a MARCA DO MATERIAL oferecido e PROCEDÊNCIA (país de fabricação), anexando, quando solicitado, catálogo, prospecto, indicando o período de garantia, no caso de equipamento;",11);
		$report->pdf->ezText("04) A critério da UFJF a presente consulta poderia ser anulada, revogada, no todo ou em parte, ter valores iniciais do empenho acrescido ou suprimido nos limites previsto no artigo 65 – Lei nº 8666/93, por qualquer destas razões, caiba ao solicitante vencedor indenização ou não aceitação;",11);
		$report->pdf->ezText("05) A empresa deverá assegurar, dentro da validade de sua proposta a disponibilidade de material ofertado e não poderá alegar, posteriormente, falta de estoque, sob pena de, ficar sujeito às penalidades previstas na lei nº 8.666 de 21 de junho de 1993;",11);
		$report->pdf->ezText("06) As amostras apresentadas para efeito de julgamento dos materiais ofertados, que se referirem aos materiais não escolhidos, estarão à disposição das empresas a partir do trigésimo dia da abertura da licitação, e deverão ser procuradas pelos interessados nos 15 (quinze) dias subseqüentes a esta data, sob pena de a Universidade dar a elas a destinação que lhe convier. As amostras referentes aos materiais escolhidos somente estarão à disposição  após o recebimento e conferência pela UFJF;",11);
		$report->pdf->ezText("07) A presente licitação é do tipo menor preço, podendo ser considerados no julgamento, para efeito de obtenção final, os fatores de qualidade, rendimento e prazo;",11);
		$report->pdf->ezText("08) A UFJF não permitirá a entrega PARCELADA do material, salvo em caso de Empenho-Estimativa;",11);
		$report->pdf->ezText("09) A entrega do material no ALMOXARIFADO CENTRAL-Cidade Universitária, ou no Restaurante Universitário, será acompanhada de Nota Fiscal, em 2 (duas) vias, onde deverá ser informado banco, agência, conta corrente;",11);
		$report->pdf->ezText("10) A omissão, na proposta da empresa, de aceitação destas cláusulas e condições será considerada como tácita aceitação;",11);
		$report->pdf->ezText("11) Será desclassifica a proposta que apresentar faturamento mínimo e/ou opção de marca;",11);
		$report->pdf->ezText("12) As empresas deverão apresentar obrigatoriamente junto com a proposta a seguinte documentação:",11);
		$report->pdf->ezText("12.1) Certificado de Regularidade de Situação do FGTS (Lei  8036/90  - Art. 27-a);",11);
		$report->pdf->ezText("12.2) Certidão negativa de débitos (C.N.D.) do Instituto Nacional do Seguro Social-INSS (Lei nº 8212/91 art.47, I, \"a\", e art. 56);",11);
		$report->pdf->ezText("12.3) Certidão Conjunta de Débitos Relativos a Tributos Federais e à Dívida Ativa da União;",11);
		$report->pdf->ezText("13) O prazo de pagamento previsto pela UFJF, e de 05 (cinco) dias úteis, após recebimento da mercadoria e aceitação pelo Almoxarifado da UFJF/Restaurante Universitário;",11);
		$report->pdf->ezText("14) Em cumprimento à Instrução SRF nº 480, de 29/12/04, alterada pela IN 539, de 25/04/05, a UFJF reterá, na fonte, o imposto sobre a renda da Pessoa Jurídica - IRPJ, bem como a contribuição sobre o lucro líquido - CSLL, a contribuição para a seguridade social - COFINS e a contribuição para PIS/PASEP sobre os pagamentos que efetuar a pessoas jurídicas, exceto para as optantes pelo SIMPLES, sendo que o Anexo IV da IN 480/04-SRF (termo de opção), deverá acompanhar cada nota fiscal emitida, ambos com a mesma data;",11);
		$report->pdf->ezText("15) As empresas cadastradas no SICAF não precisam apresentar os documentos solicitados no item 12, e a regularidade será verificada \"on-line\" no sistema SICAF;",11);
		$report->pdf->ezText("16) Caso o sistema SICAF esteja sem comunicação na data de abertura, será feita ata, e marcada nova data.",11);
		$report->pdf->ezText("17) <b>O C.G.C. da nota fiscal deverá ser o mesmo que a empresa apresentou nos documentos de habilitação do presente certame.</b>",11);
    
	}

	function getTextoServico($report){
		$report->pdf->ezText("01) Proposta em papel impresso da empresa contendo a razão social, CGC, e inscrição, em 01(uma) via sem rasuras ou emendas. Não será aceito documento copiado por FAX;",11);
		$report->pdf->ezText("02) A empresa  deverá incluir no preço dos serviços cotados, todos impostos, taxas, embalagens, frete, seguro e descontos;",11);
		$report->pdf->ezText("03) Havendo necessidade de retirada do equipamento para cotação de preço, ou para a execução do serviço, toda a documentação para tramitação bem como as despesas de transporte, embalagem, ficarão a cargo exclusivo da empresa, que se responsabilizará, também, por outro qualquer dano que ocorrer nesse equipamento durante o tempo em que ficar sob sua guarda ou responsabilidade;",11);
		$report->pdf->ezText("04) Para a retirada do equipamento de qualquer unidade da UFJF, a empresa fornecerá um documento hábil (nota fiscal de transito ou recibo), devendo ser descrito, no documento, o equipamento com todas as características;",11);
		$report->pdf->ezText("05) A UFJF se reserva o direito de não aceitar o serviço, caso seja constatado que o equipamento, entregue como reparado, não se encontrar em perfeitas condições, não cabendo aos proponentes direitos a qualquer reclamação ou indenização;",11);
		$report->pdf->ezText("06) O não cumprimento da proposta cotada, dentro do seu prazo de validade, sujeita à empresa às penalidades previstas no Decreto Lei nº 8.666 de 21 de junho de 1993;",11);
		$report->pdf->ezText("07) Para elaboração das propostas de execução do serviço, as empresas  deverão examinar, no local indicado pela UFJF, o equipamento sujeito a reparos, descrevendo todo o material a ser empregado e o serviço a ser executado, com os respectivos preços unitário e total;",11);
		$report->pdf->ezText("08) Realizado o serviço, a empresa  deverá fazer a entrega do equipamento na Unidade a que ele pertencer, acompanhado da Nota Fiscal em 2 (duas) vias, onde deverá ser informado banco, agência, conta corrente.",11);
		$report->pdf->ezText("09) A omissão, na proposta da empresa, de aceitação destas cláusulas e condições será considerada como tácita aceitação;",11);
		$report->pdf->ezText("10) O prazo de pagamento previsto pela UFJF é de 05 (cinco) dias úteis, após o término do(s) serviço(s) e aceitação pela UFJF.",11);
		$report->pdf->ezText("11) As empresas deverão apresentar junto com a proposta a seguinte documentação:",11);
		$report->pdf->ezText("11.1) Certificado de Regularidade de Situação do FGTS (Lei  8.036/90  - Art. 27-a);",11);
		$report->pdf->ezText("11.2) Certidão negativa de débitos (C.N.D.) do Instituto Nacional do Seguro Social-INSS (Lei nº 8.212/91 art.47, I, \"a\", e art. 56);",11);
		$report->pdf->ezText("11.3) Certidão Conjunta de Débitos Relativos a Tributos Federais e à Dívida Ativa da União;",11);
		$report->pdf->ezText("12) Em cumprimento à Instrução SRF nº 480, de 29/12/04, alterada pela IN 539, de 25/04/05, a UFJF reterá, na fonte, o imposto sobre a renda da Pessoa Jurídica - IRPJ, bem como a contribuição sobre o lucro líquido - CSLL, a contribuição para a seguridade social - COFINS e a contribuição para PIS/PASEP sobre os pagamentos que efetuar a pessoas jurídicas, exceto para as optantes pelo SIMPLES, sendo que o Anexo IV da IN 480/04-SRF (termo de opção), deverá acompanhar cada nota fiscal emitida, ambos com a mesma data;",11);
		$report->pdf->ezText("13) As empresas cadastradas no SICAF não precisam apresentar os documentos solicitados no item 11, e a regularidade será verificada \"on-line\" no sistema SICAF;",11);
		$report->pdf->ezText("14) Caso o sistema SICAF esteja sem comunicação na data de abertura, será feita ata, e marcada nova data.",11);
		$report->pdf->ezText("15) <b>O C.G.C. da nota fiscal deverá ser o mesmo que a empresa apresentou nos documentos de habilitação do presente certame.</b>",11);
	}
	
	function generateBodyReport($participante,$report){
		global $MIOLO;
		$cf = new MCurrencyFormatter();
        $h = $report->pdf->getFontHeight(12);
        //$report->pdf->ezImage($this->manager->getUi()->getImage('','logonet.png'),5,50,'none','left',0);
		$report->pdf->ezText('UFJF - Universidade Federal de Juiz de Fora',12,array("justification"=>"center","spacing"=>"1"));
		$report->pdf->ezText('CGCO - Centro de Gestão do Conhecimento Organizacional',12,array("justification"=>"center","spacing"=>"1"));
		$report->pdf->ezText('SIGA - Sistema Integrado de Gestão Acadêmica',12,array("justification"=>"center","spacing"=>"1"));
        $report->pdf->ezText('COSUP - Coordenadoria de Suprimentos',12,array("justification"=>"center","spacing"=>"1"));
        $report->pdf->ezText('',20);
        $report->pdf->ezText("EDITAL DE LICITAÇÃO",14,array("justification"=>"center","spacing"=>"1"));
        $report->pdf->ezText("Licitação número {$this->licitacao->numero}",12,array("justification"=>"center","spacing"=>"1"));
        $report->pdf->ezText("Juiz de Fora, ".$this->getFormValue('dataEdital'),12,array("justification"=>"center","spacing"=>"1"));
		$report->pdf->ezText("",10);
		$objParticipante = $MIOLO->getBusiness('adm','fornecedor',$participante[0]);
		$objParticipante->retrieveAssociation('instituicao');
		$objParticipante->instituicao->retrieveAssociation('municipio');
		/*		
		if($objParticipante->instituicao->municipio){
			$objParticipante->instituicao->municipio->retrieveAssociation('uf');
		}
		*/		
		$report->pdf->ezText("<b>{$objParticipante->instituicao->nome}</b> ",12);
		$report->pdf->ezText("{$objParticipante->instituicao->rua} ",12);
		$report->pdf->ezText("{$objParticipante->instituicao->municipio->municipio} - {$objParticipante->instituicao->municipio->idUF}  -  CEP: ".substr($objParticipante->instituicao->cep, 0, 5)."-".substr($objParticipante->instituicao->cep, 5, 3), 12);		
		$report->pdf->ezText("",10);
		$report->pdf->ezText("O Orçamento em papel impresso da firma, datado e assinado, para execução dos serviços abaixo, deverá ser entregue na Coordenadoria de Suprimentos - Campus Universitário/UFJF - Bairro Martelos - 36036-900 - Juiz de Fora - MG, respeitadas as cláusulas e condições anexas.",11);
        $report->pdf->ezText("",11);
		if($this->licitacao->imediata=='1'){
			$imediato = 'IMEDIATO';
		}else{
			$imediato = $this->licitacao->dataAbertura;
		}
        //$report->pdf->ezText("Abertura: {$this->licitacao->dataAbertura}",11);
		$report->pdf->ezText("Data de Abertura da Licitação: {$imediato}   -   Validade da proposta: {$this->licitacao->validade} dias",11);
        $report->pdf->ezText("",11);

		//$report->pdf->ezText('',20);
        //$report->pdf->ezText("<b>Número do Processo..:</b> {$this->protocolo->numProcessoFormatado($this->licitacao->numProcesso)}",12);
        //$report->pdf->ezText("<b>Número da licitação....:</b> {$this->licitacao->numero}",12);
        //$report->pdf->ezText("<b>Modalidade..................:</b> {$this->licitacao->modalidade->descricao}",12);
        //$report->pdf->ezText('',40);
        $report->pdf->ezText("Clausulas de Condições para participar desta licitação",12,array("justification"=>"center","spacing"=>"1"));
        $report->pdf->ezText('',20);
	    if ($this->licitacao->idTipoLicitacao == '1' OR $this->licitacao->idTipoLicitacao == '4'){//material
			$this->getTextoMaterial($report);
		}elseif($this->licitacao->idTipoLicitacao == '2'){//serviço
			$this->getTextoServico($report);
		}
		
        $report->pdf->ezText('',40);

        $report->pdf->ezText("Artigos Necessários",12,array("justification"=>"center","spacing"=>"1"));  
        $report->pdf->ezText('',20);
        
        $options['textCol'] = array(0,0,0);
        $options['shaded'] = 1;
        $options['showLines'] = 1;
        $options['fontSize'] = 10;
        $options['width'] = 520;
        $options['xPos'] = 'left';
        $options['xOrientation'] = 'right';
        $cols = array('<b>Ítem</b>','<b>Descrição</b>','<b>Quantidade</b>','<b>Unidade</b>');
	
		if ($this->licitacao->idTipoLicitacao == '1' OR $this->licitacao->idTipoLicitacao == '4') 
		{
			$this->licitacao->retrieveAssociation('itens');
			if ($this->licitacao->itens != NULL)
            {
				foreach ( $this->licitacao->itens as $o )
				{
					$o->retrieveAssociation("itemreq");
					if ($o->itemreq)
                    {
						$quantidade=0;
						foreach ( $o->itemreq as $o2 )
						{
                            if (($o2->status == '1' || $o2->status > '4') && ($o2->status != 'C'))
                            {
                                $o2->retrieveAssociation("material");
        						$quantidade += $o2->quantPedida;
		    					$itensLicitacao[] = array($o2->item, $o2->material->descricao,$quantidade,$o2->material->unidade);
			    				//$valorEstimado += $o2->quantPedida * $cf->toDecimal($o2->precoEstimado);
                            }
						}
					}
				}
			}
		}
        elseif ($this->licitacao->idTipoLicitacao == '2')
        {
			$this->licitacao->retrieveAssociation('itens');
			if ($this->licitacao->itens != NULL)
            {
				foreach ( $this->licitacao->itens as $o )
				{
					$o->retrieveAssociation("itemservext");
					if ($o->itemservext)
                    {
						$quantidade=0;
						foreach ( $o->itemservext as $o2 )
						{  
                            if (($o2->status == '1' || $o2->status > '4') && ($o2->status != 'C'))
                            {
                                $o2->retrieveAssociation("servico");
	    						$quantidade+=$o2->quantidade;
		    					$itensLicitacao[] = array($o2->item, $o2->complemento,$quantidade,$o2->unidade);
			    				//$valorEstimado += $o2->quantPedida * $cf->toDecimal($o2->precoEstimado);
                            }
						}
					}
				}
			}
		}			
        elseif ($this->licitacao->idTipoLicitacao == '2')
        {
			$this->licitacao->retrieveAssociation('itens');
			if ($this->licitacao->itens != NULL)
            {
				foreach ( $this->licitacao->itens as $o )
				{
					$o->retrieveAssociation("itemreqbib");
					if ($o->itemservext)
                    {
						$quantidade=0;
						foreach ( $o->itemservext as $o2 )
						{  
                            if (($o2->status == '1' || $o2->status > '4') && ($o2->status != 'C'))
                            {
	    						$quantidade+=$o2->quantidade;
		    					$itensLicitacao[] = array($o2->item, $o2->titulo,$quantidade,$o2->material->unidade);
			    				//$valorEstimado += $o2->quantPedida * $cf->toDecimal($o2->precoEstimado);
                            }
						}
					}
				}
			}
		}

		$this->licitacao->retrieveAssociation('itens');

		if ($itensLicitacao)
        {
			foreach($itensLicitacao as $i)
            {
				$data[] = array($i[0],$i[1],$i[2],$i[3]);
			}
		}

		/*foreach ($this->licitacao->itens as $item)
        {	if ($this->licitacao->idTipoLicitacao == '1'){
				$item->retrieveAssociation("itemreq");
				//$item->itemreq[0]->retrieveAssociation("material");
				$codigo = $item->itemreq[0]->material->codmaterial;
				$descricao = $item->itemreq[0]->material->descricao;
				$unidade = $item->itemreq[0]->material->unidade;
				$quantidade = $item->quantidadeLicitada;
				$valor = $item->valor;
				//echo $this->licitacao->idLicitacao.'  = '.$codigo.','.$descricao.','.$quantidade.','.$unidade.'<br>';
				/*if($item->itemreq){
					foreach ($item->itemreq as $itemreq)
					{	$codigo = $itemreq->material->codmaterial;
						$descricao = $itemreq->material->descricao;
						$unidade = $itemreq->material->unidade;
						$quantidade = $itemreq->quantPedida;
						$valor += $itemreq->precoEstimado;
					}}*/
			/*}elseif ($this->licitacao->idTipoLicitacao == '2'){
                $item->retrieveAssociation("itemservext");
				if($item->itemservext){
					foreach ($item->itemservext as $itemservext){
						$codigo = $itemservext->servico->codServico;
						//$descricao = $itemservext->servico->descricao;
						$descricao = $itemservext->complemento;
						$quantidade = $itemservext->quantidade;
						$valor += $itemservext->valorEst;                    
					}
				}
            }
            $total += $quantidade*$cf->toDecimal($valor);
            $data[] = array($codigo,$descricao,$quantidade,$unidade); //$cf->formatWithSymbol($cf->toDecimal($valor)),$cf->formatWithSymbol($quantidade*$cf->toDecimal($valor)));
        }*/
        //$data[] = array(null,"<b>Total</b>",null,null,"<b>{$cf->formatWithSymbol($total)}</b>");
        $report->pdf->ezTable($data,$cols,'',$options);
		$report->pdf->ezText('',11);
		$report->pdf->ezText('',11);
		$report->pdf->ezText($this->licitacao->obs,11);
	   
    }
}
?>
