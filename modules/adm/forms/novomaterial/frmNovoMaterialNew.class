
<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>

<?php
class frmNovoMaterialNew extends MForm
{
	function __construct()
	{
		parent::__construct('Incluir Novo Material');
		$this->EventHandler();
	}


	function CreateFields()
	{
		$usuario = $this->manager->getBusiness('common','usuario');
		$usuario->getById($this->manager->GetLogin()->idkey);
		$uo = $this->manager->getbusiness('adm','uo');
		$idUsuario = $this->manager->GetLogin()->idkey;
		$uoAlocado = $uo->listByUsuario($idUsuario);
		if (count($uoAlocado->result) == 0)
		{
			$go = $this->manager->GetActionURL('adm','main','','');
			$this->manager->Error("Você não está alocado em nenhuma Unidade Orçamentária habilitada a fazer requisições.",$go);
		}
		else
		{
			$fields = array(
				new MTextField('codmaterial','','CATMAT',14,'Maximo 14 algarismos'),
				new MMultiLineField('descricao','','Descrição',500,6,50,'Máximo 500'),
				//new MTextField('precoestimado','','Preço Estimado',12,'Separacao decimal por ponto'),
				new MCurrencyField('precoestimado','','Preço Estimado',12),
				new MSeparator('Dados para contato'),
				new MTextField('nome',$usuario->pessoa->nome,'Nome',52),
				new MTextField('telefone','','Telefone',12),
				new MTextField('email',$usuario->pessoa->email,'Email',52),
				new MSelection('idUoReq','','UO',$uo->listSiglaByUsuario($idUsuario)->result)
			);
		
			$this->SetFields($fields);
			$this->nome->setReadOnly(true);
			$validators = array(
				new MRequiredValidator('descricao'),
				new MPhoneValidator('telefone','','required'),
				new MEmailValidator('email','','required'),
			);
			$this->SetValidators($validators);
			$buttons = array(
				new MButton('btnNew', 'Sugerir Material')
			);
			$this->SetButtons($buttons);
		}
	}


	function btnNew_click()
	{
		$data = $this->GetData();
		$cf = new MCurrencyFormatter();
	        $data = $this->getData();
       		$data->precoestimado = $cf->toDecimal($data->precoestimado);
		if ($data->precoestimado <= 0)
                {
				$this->AddError('O material não pode ter valor negativo.');
                }

		$usuario = $this->manager->getBusiness('common','usuario');
		$usuario->getById($this->manager->GetLogin()->idkey);
		$material = $this->manager->getBusiness('adm','novomaterial');
		try
		{
			$material->beginTransaction();
			$material->setData($data);
			$material->setStatus(1);
			$material->dataPedido = date('d/m/Y');
			$material->setUsuario($this->manager->getLogin()->idkey);
			$material->ativo = "S";
			$material->idUoReq = Form::GetFormValue('idUoReq');
			$material->precoestimado = $cf->toDecimal(Form::GetFormValue('precoestimado'));
			$material->save();
			if ($data->email != $usuario->pessoa->email)
			{
				$usuario->pessoa->setTransaction($material->getTransaction());
				$usuario->pessoa->email = $data->email;
				$usuario->pessoa->save();
			}
			$material->endTransaction();
			$material->Log(OP_INS,'Novo material inserido ['.$material->idNovoMaterial.']');
			$this->manager->information("Pedido de novo material efetuado com sucesso. O número do seu pedido é ".$material->idNovoMaterial,$this->manager->getActionUrl('adm','main:novomaterial:find') );
		}
		catch (Exception $e)
		{
			$this->AddError($e->GetMessage());
		}
	}
}
?>
