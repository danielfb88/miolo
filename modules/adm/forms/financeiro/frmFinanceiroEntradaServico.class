
<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>

<?
class frmFinanceiroEntradaServico extends MForm
{
    protected $empenho;
    function __construct($objEmpenho)
    {
        global $MIOLO,$page;
        $this->empenho = $objEmpenho;
		parent::__construct('Adicionar Nota');
        $this->eventHandler();
    }
    function CreateFields()
    {
        global $item;
        $fields = array(
            new MSeparator('Dados da nota fiscal'),
            new MTextField('notaFiscal','','Nota Fiscal',16),
            new MCalendarField('dataNotaFiscal','','Data',10),
            new MCurrencyField('valor','','Valor',14),
        );
        $this->setFields($fields);
        $this->setButtons(
            array(
                new MButton('btnItens','Enviar'),
                new MButton('btnAdicionar','Adicionar Nota'),
                new MButton('btnAlterarValor','Alterar Valor da Nota'),
                new MButton('btnSaida','Dar Saída'),
            )
        );
        $this->setButtonAttr('btnAdicionar','visible',false);
        $this->setButtonAttr('btnAlterarValor','visible',false);
        $this->setButtonAttr('btnSaida','visible',false);
    }
    function btnItens_click()
    {
        $cf = new MCurrencyFormatter();
        $data = $this->getData();
        // Consistências
        switch (true)
        {
            case (!Form::getFormValue(notaFiscal)):
                $this->addError('O número da nota fiscal é obrigatório.');
                return;
            case (!Form::getFormValue(dataNotaFiscal)):
                $this->addError('O data da nota fiscal é obrigatório.');
                return;
            case (round($cf->toDecimal(Form::getFormValue(valor)),2) <= 0):
                $this->addError('O valor da nota fiscal é obrigatório.');
                return;
            case (round($cf->toDecimal($this->empenho->valorSaldo),2) < round($cf->toDecimal(Form::getFormValue(valor)),2)):
                $this->addError('O valor da nota fiscal é superior ao valor empenhado');
                return;
            case (round($cf->toDecimal(Form::getFormValue(valor)),2) < round($cf->toDecimal($this->empenho->valorSaldo),2)):
                $this->setTitle('Entrada Parcelada de Material');
                break;
        }
        // se a nota existe --- OBS: REVER ESSA PARTE
        $nota = $this->manager->getBusiness('adm','notafiscal');
        $nota->getByNumero(Form::getFormValue('notaFiscal'),$this->empenho->idEmpenho);
        if ($nota->isPersistent())
        {
            $this->addError('Esta nota fiscal já deu entrada para este empenho.');
            return;
        }
        // normal
        $this->setButtonAttr('btnItens','visible',false);
        $this->setFieldAttr('notaFiscal','readonly',true);
        $this->setFieldAttr('dataNotaFiscal','readonly',true);
        $this->setFieldAttr('valor','readonly',true);
        $grid = $this->manager->getUI()->getGrid('adm','gridFinanceiroEntradaServicoItens',$this->empenho);
        $this->addField(new MSpacer('5px'));
        $this->addField(new MSeparator('Materiais recebidos'));
        $this->addField($grid);
        if (round($cf->toDecimal($this->empenho->valorSaldo),2) > round($cf->toDecimal(Form::getFormValue(valor)),2) && count($this->empenho->notaFiscal) == 0)
        {
            $this->addInfo('Este empenho é do tipo original, para parcela-lo é necessário uma justificativa.');
            $this->addField(new MSpacer('5px'));
            $this->addField(new MSeparator('Justificativa de parcelamento'));
            $this->addField(new MMultiLineField('obs','','Justificativa',25,5,58));
        }
        $this->setButtonAttr('btnAdicionar','visible',true);
        $this->setButtonAttr('btnAlterarValor','visible',true);
        $this->setButtonAttr('btnItens','visible',false);
    }
    function btnAdicionar_click()
    {
        $cf = new MCurrencyFormatter();
        foreach ($valorExecutado = Form::getFormValue(valorExecutado) as $idEmpenhado=>$valor)
        {
            foreach ($this->empenho->empenhado as $empenhado)
            {
                if ($empenhado->idEmpenhado == $idEmpenhado)
                {
                    $empenhado->getAtributos();
                    switch (true)
                    {
                        case (round($cf->toDecimal($valor),2) < 0):
                            $this->addError("O valor do item {$empenhado->item} não pode ser negativo.");
                            $this->btnItens_click();
                            return;
                        case (round($cf->toDecimal($valor),2) > round($cf->toDecimal($empenhado->valorSaldo),2)):
                            $this->addError("O valor do item {$empenhado->item} é superior ao valor empenhado.");
                            $this->btnItens_click();
                            return;
                        case (round($cf->toDecimal($this->empenho->valorSaldo),2) > round($cf->toDecimal(Form::getFormValue(valor)),2) && count($this->empenho->notaFiscal) == 0 && $this->empenho->tipoEmpenho == 'OR' && !Form::getFormValue('obs')):
                            $this->addError('A justificativa é obrigatória.');
                            $this->btnItens_click();
                            return;
                        default:
                            $valorTotal += $cf->toDecimal($valor);
                    }
                }
            }
        }
        if (round($cf->toDecimal(Form::getFormValue('valor')),2) != round($cf->toDecimal($valorTotal),2))
        {
            if (round($cf->toDecimal(Form::getFormValue('valor')),2) != round($cf->toDecimal($this->empenho->valorSaldo),2))
            {
                $this->addError('A soma dos itens da nota não confere com o valor informado.');
                $this->btnItens_click();
                return;
            }
        }
        $nota = $this->manager->getBusiness('adm','notafiscal');
        $nota->getByNumero(Form::getFormValue('notaFiscal'),$this->empenho->idEmpenho);
        if ($nota->isPersistent())
        {
            $this->addError('Esta nota fiscal já deu entrada para este empenho.');
            return;
        }
        try 
        {
            $nota = $this->manager->getBusiness('adm','notafiscal');
            $nota->beginTransaction();
            $nota->notaFiscal = Form::getFormValue('notaFiscal');
            $nota->dataNotaFiscal = Form::getFormValue('dataNotaFiscal');
            $nota->valor = $cf->toDecimal(Form::getFormValue('valor'));
            $nota->idEmpenho = $this->empenho->idEmpenho;
            $nota->obs = Form::getFormValue('obs');
            $nota->save();
            $msg = "Nota fiscal  número {$nota->notaFiscal} adicionada com sucesso.";
            $nota->Log(OP_INS,$msg);
            foreach ($valorExecutado as $idEmpenhado=>$valor)
            {
                foreach ($this->empenho->empenhado as $empenhado)
                {
                    if ($empenhado->idEmpenhado == $idEmpenhado)
                    {
                        if ($cf->toDecimal($valor))
                        {
                            $itemNota = $this->manager->getBusiness('adm','itemnota');
                            $itemNota->idEmpenhado = $empenhado->idEmpenhado;
                            $itemNota->quantidade = round($cf->toDecimal($valor) / $cf->toDecimal($empenhado->valorEmp) * $cf->toDecimal($empenhado->quantidadeEmp),2);
                            $itemNota->valor = round($cf->toDecimal($valor) / $cf->toDecimal($itemNota->quantidade),2);
                            $itemNota->idNotaFiscal = $nota->idNotaFiscal;
                            $itemNota->setTransaction($nota->getTransaction());
                            $itemNota->save();
                            $empenhado->retrieveAssociation('itemServExt');
                            unset($itemValorEmpenhado,$itemValorExecutado,$valorEmpenhadoPendente);
                            foreach ($empenhado->itemServExt as $servico)
                            {
                                $itemValorEmpenhado = $cf->toDecimal($itemValorEmpenhado) + ($cf->toDecimal($servico->quantEmpenhada) * $cf->toDecimal($servico->valorReal));
                                $itemValorExecutado = $cf->toDecimal($itemValorExecutado) + ($cf->toDecimal($servico->quantEntregue) * $cf->toDecimal($servico->valorReal));
                            }
                            $valorEmpenhadoPendente = $cf->toDecimal($itemValorEmpenhado) - $cf->toDecimal($itemValorExecutado);
                            if (count($empenhado->itemServExt) == 1)
                            {
                                foreach ($empenhado->itemServExt as $itemRequisicao)
                                {
                                    if ($cf->toDecimal($valor) > 0)
                                    {
                                        $itemRequisicao->retrieveAssociation('requisicao');
                                        $itemRequisicao->requisicao->retrieveAssociation('uoRequisitante');
                                        $itemRequisicao->requisicao->retrieveAssociation('uoExecutante');
                                        $movimento = $this->manager->getBusiness('adm','movimentoserv');
                                        $movimento->idMaterial = $itemRequisicao->idMaterial;
                                        $movimento->idRequisicao = $itemRequisicao->idRequisicao;
                                        $movimento->tipoMovimento = 5;
                                        $movimento->dataMovimento = date("d/m/Y");                
                                        $movimento->quantidade = $cf->toDecimal($itemNota->quantidade);        
                                        $movimento->valorTotal = round($cf->toDecimal($itemNota->quantidade) * $cf->toDecimal($itemNota->valor),2);
                                        $movimento->idItemNota = $itemNota->idItemNota;
                                        $movimento->setTransaction($nota->getTransaction());
                                        $movimento->save();
                                        $itemRequisicao->quantEntregue = $cf->toDecimal($itemRequisicao->quantEntregue) + $cf->toDecimal($itemNota->quantidade);
                                        $itemRequisicao->status = 7;
                                        $itemRequisicao->setTransaction($nota->getTransaction());
                                        $itemRequisicao->save();
                                        $itemRequisicao->requisicao->retrieveAssociation('materialCompra');
                                        if ($itemRequisicao->requisicao->materialCompra && $itemRequisicao->status == 7)
                                        {
                                            $itemRequisicao->requisicao->status = 8;
                                            foreach ($itemRequisicao->requisicao->materialCompra as $material)
                                            {
                                                if ($material->idMaterial != $itemRequisicao->idMaterial && $material->status != 7) $itemRequisicao->requisicao->status = 8; 
                                            }
                                        }
                                        else
                                        {
                                            $itemRequisicao->requisicao->status = 8;
                                        }
                                        $itemRequisicao->requisicao->setTransaction($nota->getTransaction());
                                        $itemRequisicao->requisicao->save();
                                    }
                                }
                            }
                            /*
                            elseif ($cf->toDecimal($quantidade) == $cf->toDecimal($quantEmpenhadaPendente))
                            {
                                foreach ($empenhado->itemreq as $itemRequisicao)
                                {
                                    $quantEntregue = $cf->toDecimal($itemRequisicao->quantEmpenhada) - $cf->toDecimal($itemRequisicao->quantAutorizada);
                                    $quantEntregue = ($cf->toDecimal($quantidade) < $cf->toDecimal($quantEntregue)) ? $cf->toDecimal($quantidade) : $cf->toDecimal($quantEntregue);
                                    if ($cf->toDecimal($quantEntregue) > 0)
                                    {
                                        $itemRequisicao->retrieveAssociation('requisicao');
                                        $itemRequisicao->requisicao->retrieveAssociation('uoRequisitante');
                                        $itemRequisicao->requisicao->retrieveAssociation('uoExecutante');
                                        $movimento = $this->manager->getBusiness('adm','movimento');
                                        $movimento->idMaterial = $itemRequisicao->idMaterial;
                                        $movimento->idRequisicao = $itemRequisicao->idRequisicao;
                                        $movimento->tipoMovimento = 1;
                                        $movimento->dataMovimento = date("d/m/Y");                
                                        $movimento->quantidade = $cf->toDecimal($quantEntregue);        
                                        $movimento->valorTotal = $cf->toDecimal($quantEntregue) * $cf->toDecimal($itemNota->valor);
                                        $movimento->idItemNota = $itemNota->idItemNota;
                                        $movimento->setTransaction($nota->getTransaction());
                                        $movimento->save();
                                        if ($this->empenho->idUoEntrega == $itemRequisicao->requisicao->idUoRequisitante)
                                        {
                                            $estoque = $this->manager->getBusiness('adm','estoque');
                                            $estoque->getById($this->empenho->idUoEntrega,$itemRequisicao->idMaterial);
                                            $estoque->estoque = $cf->toDecimal($estoque->estoque) + $cf->toDecimal($quantEntregue);
                                            $estoque->valorTotal = $cf->toDecimal($estoque->valorTotal) + $cf->toDecimal($quantEntregue) * $cf->toDecimal($itemNota->valor);
                                            $estoque->setTransaction($nota->getTransaction());
                                            $estoque->save();
                                        }
                                        else
                                        {
                                            $ordem = $itemRequisicao->requisicao->abrirOrdemEntrega($this->empenho->idUoEntrega);
                                            $ordem->setTransaction($nota->getTransaction());
                                            $ordem->save();
                                        }
                                        $itemRequisicao->quantAutorizada = $cf->toDecimal($itemRequisicao->quantAutorizada) + $cf->toDecimal($quantEntregue);
                                        $itemRequisicao->status = 7;
                                        $itemRequisicao->setTransaction($nota->getTransaction());
                                        $itemRequisicao->save();
                                        $itemRequisicao->requisicao->retrieveAssociation('materialCompra');
                                        $itemRequisicao->requisicao->status = 9;
                                        foreach ($itemRequisicao->requisicao->materialCompra as $material)
                                        {
                                            if ($material->idMaterial != $itemRequisicao->idMaterial && $material->status != 7) $itemRequisicao->requisicao->status = 8; 
                                        }
                                        $itemRequisicao->requisicao->setTransaction($nota->getTransaction());
                                        $itemRequisicao->requisicao->save();
                                    }
                                }
                            }
                            */
                        }
                    }
                }
            }
            $nota->endTransaction();
            $url = $this->manager->GetActionURL('adm','main:financeiro:entradaservico',$empenhado->idEmpenho,array("idNotaFiscal"=>$nota->idNotaFiscal));
            $this->manager->information("Nota adicionada com sucesso.",$url);
        }
        catch(Exception $e) {$this->manager->Error($e->getMessage());}
    }
 }
?>
