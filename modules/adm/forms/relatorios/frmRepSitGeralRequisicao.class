<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>

<?
class frmRepSitGeralRequisicao extends Form
{
	protected $uo;
	protected $requisicao;
	protected $tiporeq;
	private $objRequisicao;
	
	
	function __construct()
    {
		global $MIOLO;
		$this->uo = $MIOLO->GetBusiness('adm','uo');
		$this->requisicao = $MIOLO->GetBusiness('adm','requisicao');
		$this->tiporeq = $MIOLO->GetBusiness('adm','tiporeq');
        parent::__construct('Situação geral de requisições');
		$this->SetClose($this->manager->GetActionURL('adm','main:relatorios'));
        $this->eventHandler();
    }

    function CreateFields()
    {
		global $perms,$MIOLO,$manager,$module;
        
    	$uo = $this->uo;      	

    //    $options = array( array( 'Material', 'material' ),
  //                       array( 'Serviço', 'servico' ),
//                        );

        $this->addField(new MRadioButtonGroup( 'tipo', 'Tipo de busca: ', array( array( 'Material', 'material' ),array( 'Serviço', 'servico' ),),'material','', 'horizontal', 'css' ));
        $this->AddField(new MTextField('edtNumReq','','Nº Req',30, 'Para mais de uma requisicao separar com vírgula'));
        $this->AddField(new MSpacer(1));

		$uo = $MIOLO->GetBusiness($module,'uo');
		$usuarioUo = $uo->listByUsuario2($this->manager->getLogin()->idkey);
		

		if ($usuarioUo->result == null)
		{
			$MIOLO->error("Não existe UOs associadas a este usuário. ");
		}

		
		if (($perms->CheckAccess('ADM_ABRELICITACAO',A_EXECUTE)) or ($perms->CheckAccess('ADM_CONSULTAEMPENHO',A_EXECUTE)))
        {
			$opt = $this->uo->listUosOrdemNome();
			$options['%'] = 'TODAS';
			foreach($opt->result as $o)
			{
				$options[$o[0]] = $o[1];
			}		
			$this->addField(new MSelection('idUo','','UO',$options));
			
        }
        else if(count($usuarioUo->result) >= 2) //Se forem duas ou mais UOs
        {
			foreach($usuarioUo->result as $o)
			{
				$options[$o[0]] = $o[1];
			}		
			$this->addField(new MSelection('idUo','','UO',$options));
        }
        else //Se for apenas uma UO
        {
        	$this->addField(new MTextField('idUo',$usuarioUo->result[0][0],'UO',5,$usuarioUo->result[0][1],'',true));     	
        }

        $this->addField(new MTextField('descricao','','Descrição',30,''));
        $this->addField(new MCalendarField('dataInicio','','Data Inicial'));
        $this->addField(new MCalendarField('dataFim','','Data Final'));

		$this->addButton(new MButton('btnPost','Buscar'));
		
		
		//echo "<pre>";
		//var_dump($this->manager->getLogin());
		
	}

   function btnPost_click()
   {
	 global $MIOLO, $module,$self,$item,$theme;

		$ui = $MIOLO->GetUI();
	     
		$data = $this->getData();
		
		$inicio = Form::getFormValue('dataInicio');
                $final = Form::getFormValue('dataFim');

                $partes_da_data = explode('/',$inicio);
                $datainicial =  $partes_da_data[2].'/'.$partes_da_data[1].'/'.$partes_da_data[0];
                $partes_da_data = explode('/',$final);
                $datafinal =  $partes_da_data[2].'/'.$partes_da_data[1].'/'.$partes_da_data[0];
		if($inicio == '' || $final == '')
                {
                     $this->addError('Favor Selecionar as Datas de Início e Término do Relatório.');
		     return;
                }
                if($datainicial > $datafinal)
                {
                    $this->addError('É necessário que a data inicial seja inferior a final!');
		    return;
                }
	

		$data->idUo = $data->idUo == "" ? "%" : $data->idUo;

		$data->descricao = $data->descricao == "" ? "" : strtoupper($data->descricao);
	//	if ($data->descricao == "")
//		{
		   $objRequisicao = $MIOLO->GetBusiness($module,'requisicao');
           $query = $objRequisicao->listByNumeroReqUoDatas($data);
//        }
    /*    else
        {
           $objItemReq = $MIOLO->GetBusiness($module,'itemreq');
           $query = $objItemReq->listByUoAndDescricao($data);

        }
	*/
		$hrefWindow = $MIOLO->getActionURL( $module, $self, '%1%', array( 'event' => 'btnImprimir:click' ));
	    
		$btnWindow =  new MButtonWindow('btnWindow', 'Imprimir', $hrefWindow,'target_report');
		 
		$columns = array(
				new MGridColumn('Requisição','left','','10%'),
				new MGridColumn('Data/Hora','center','','20%'),
				new MGridColumn('Tipo','center','','20%'),
				new MGridColumn('Observação','center','','40%'),
				new MGridColumn('Requisitante','center','','20%')
			);
				
		//$href_grid = $MIOLO->getActionURL($module, $self);
		$href_grid = $MIOLO->GetActionURL($module,$action,$item, array('event'=>'btnPost:click') );
		
		$datagrid = new MGrid($query,$columns,$href_grid);
		$datagrid->SetTitle('Requisições');
		$datagrid->SetLinkType('hyperlink');
		
		
		$href = $MIOLO->GetActionURL($module, $action,'%0%', array('event'=>'btnSelecionar_click', 'idRequisicao' => '%0%') );
		$datagrid->addActionText('Imprimir','Imprimir',$href);
		
		
		$this->setFormValue('idRequisicao', null);
		$theme->clearContent();
		$theme->AppendContent(new MSpacer(1));
		$theme->AppendContent($datagrid);
	
		 
   }
   
   
   function btnSelecionar_click()
   {global $MIOLO, $module,$self,$item,$theme;
   		$idRequisicao = $this->getFormValue('idRequisicao');
		if($idRequisicao)
		{
			$form = new MForm('Requisição: ' . $idRequisicao);
	   		
	   		$buttons = array(
				new MButton('btnImprimir','Gerar Relatório','PDF'),
			);
			$form->SetButtons($buttons);
	   		
	   		$theme->appendContent($form);
		}
   }
   
   
   
     
   function btnImprimir_click()
	{		    
		global $MIOLO;
		
		$report = new MJasperReport( 'sigaept' );
                $parameters[ 'str_TITULO' ] = "SITUAÇÃO GERAL DA REQUISIÇÃO";
                $parameters[ 'int_requisicao' ] = $this->GetFormValue('idRequisicao');
                $parameters[ 'pURL' ] = $MIOLO->GetConf( 'home.url' );
                $parameters[ 'SUBREPORT_DIR' ] = $MIOLO->GetConf('home.modules');
                $parameters[ 'int_pIdUsuario' ] = $MIOLO->login->idkey;

                $report->Execute( 'adm', 'repRequisicaoSitGeral', $parameters );
    }
   
   

}
?>
