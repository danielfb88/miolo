<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>

<?
class frmTotalGastosReqUo extends Form
{
    protected $uo;
    
        function __construct()
	{
		global $MIOLO;
		$this->uo = $MIOLO->getBusiness('adm','uo');
		$this->Form('Relatório de Total de Gastos por Tipo de Requisição');
		$this->EventHandler();
	}

	function CreateFields()
	{
        	$uos = $this->uo->listUos();
        	$listaUos = array('%'=>array(0,'TODAS'))+$uos->result;
		$fields = Array(
            		new MSelection('selUos','','Uo',$listaUos),
			new MCalendarField('dataInicio','','Data Inicial',10,'informe a data inicial do relatório.'),
			new MCalendarField('dataFim','','Data Final',10,'informe a data final do relatório.'),
		);
		$this->SetFields($fields);
		$buttons = Array
		(
			new FormButton('btnPost', 'Gerar Relatório','pdf')
		);
		$this->SetButtons($buttons);
	}

	function btnPost_click()
   	{
                global $MIOLO, $module, $item;
		
		$inicio = Form::getFormValue('dataInicio');
                $final = Form::getFormValue('dataFim');
                $idUo = Form::GetFormValue('selUos');

                $partes_da_data = explode('/',$inicio);
                $datainicial =  $partes_da_data[2].'/'.$partes_da_data[1].'/'.$partes_da_data[0];
                $partes_da_data = explode('/',$final);
                $datafinal =  $partes_da_data[2].'/'.$partes_da_data[1].'/'.$partes_da_data[0];

                if($idUo == '')
                {
                        $this->addError('Favor informar a UO.');
                }
                else if($inicio == '' || $final == '')
                     {
                           $this->addError('Favor Selecionar as Datas de Início e Término do Relatório.');
                     }
                     else if($datainicial > $datafinal)
                          {
                             $this->addError('É necessário que a data inicial seja inferior a final!');
                          }
                          else
                          {
		                $report = new MJasperReport('sigaept');
                		$parameters['int_IDUO']         = Form::GetFormValue('selUos');
		                $parameters['DATAINICIAL']         = Form::GetFormValue('dataInicio');
                		$parameters['DATAFINAL']          = Form::GetFormValue('dataFim');
		                $parameters['SUBREPORT_DIR']    = $MIOLO->GetConf('home.modules');
                		$parameters['int_ID_USUARIO']   = $MIOLO->login->idkey;
		                $parameters['URL_LOGO']             = $MIOLO->GetConf('home.url');
				if( $parameters[ int_IDUO ] == 0 )
				{
                			$report->Execute( 'adm', 'repTotalGastosReqUoTodas', $parameters );
		                }
				else
				{
                			$report->Execute('adm', 'repTotalGastosReqUo', $parameters);
				}
			  }
   	}
}
?>
