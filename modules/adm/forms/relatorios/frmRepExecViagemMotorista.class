
<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>

<?
class frmRepExecViagemMotorista extends Form
{	
	protected $motorista;
	protected $itemveiculo;
    
    function __construct()
    {
        global $MIOLO;
        $this->motorista = $MIOLO->getBusiness('adm','motorista');
        $this->itemveiculo = $MIOLO->getBusiness('adm','itemveiculo');
        $this->Form('Relatório de Viagens Realizadas por Motoristas');
        $this->EventHandler();       
    }

	function CreateFields()
	{		
		$fields = Array(
			new MCalendarField('dataInicio','','Data Inicial',10,'informe a data inicial do relatório.'),
			new MCalendarField('dataFim','','Data Final',10,'informe a data final do relatório.'),
		);
		
		$this->SetFields($fields);
		$buttons = Array
		(
			new FormButton('btnGerarRelatorio', 'Gerar Relatório','pdf'),
			new FormButton('btnGerarRelatorioXls', 'Gerar Planilha')
		);
		$this->SetButtons($buttons);
	}
	function btnGerarCSV_click()
	{
		$data = $this->getData();
        
	    //$report = new MEzPDFReport('2','portrait');
        //$h = $report->pdf->getFontHeight(10);
        //$ui = $this->manager->GetUI();
        //$report->pdf->ezImage($ui->GetImage('','logonet.png'),5,50,'none','left',0);
        //$report->pdf->addText(110,810       ,10,'UNIVERSIDADE FEDERAL DE JUIZ DE FORA');
        //$report->pdf->addText(110,810-$h,10,'SISTEMA INTEGRADO DE GESTÃO ACADÊMICA - SIGA');
        //$report->pdf->ezText('RELATÓRIO DE VIAGENS REALIZADAS POR MOTORISTAS',16,array('justification'=>'center'));
        //$report->pdf->addText(200,810-(8*$h),10,"PERÍODO DE ".$data->dataInicio." ATÉ ".$data->dataFim);
        //$report->pdf->ezText('',20);
        //unset($dataRel);
        
        //$options['textCol'] = array(0,0,0);
	    //$options['shaded'] = 1;
	    //$options['showLines'] = 0;
	    //$options['fontSize'] = 11;
	    //$options['width'] = 540;
	    //$options['xPos'] = 'left';
	    //$options['xOrientation'] = 'right';
	    
	    //$cols = array('NOME','RIO DE JANEIRO','BELO HORIZONTE','OUTROS');
	    $dataRel[] = array('NOME','RIO DE JANEIRO','BELO HORIZONTE','OUTROS');

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////	    
	    $motorista = $this->motorista;
	    $itemveiculo = $this->itemveiculo;
	    $nomes = $motorista->ListNomeById()->result;
        $consulta = $motorista->ListNomeById();
	    $totalRj = 0;
	    $totalBh = 0;
	    $totalOutros = 0;
		foreach ( $nomes as $n )
		{
			$nomeMotorista = $n[0];
			$idMotorista = $n[1];
			$rj = 0;
			$bh = 0;
			$outros = 0;
			$viagens = $itemveiculo->listViagensbyMotorista($idMotorista,$data->dataInicio,$data->dataFim)->result; // variavel viagem recebeu a consulta
			if ( $viagens )
			{
				foreach ( $viagens as $v )
				{
					$idMunicipioOrig = $v[0];
					$idMunicipioDest = $v[1];							
					if ( $idMunicipioDest == 4733 )
					{
						switch($idMunicipioOrig)
						{
							case 4123:
								$bh++;
								break;
							case 6001:
								$rj++;
								break;
							default:
								$outros++;							
								break;
						}					
					}
					
					if ( $idMunicipioOrig == 4733 )
					{
						switch($idMunicipioDest)
						{
							case 4123:
								$bh++;
								break;
							case 6001:
								$rj++;
								break;
							default:
								$outros++;							
								break;
						}										
					}				
				}
				$totalRj += $rj;
				$totalBh += $bh;
				$totalOutros += $outros;
				$dataRel[] = array($nomeMotorista,$rj,$bh,$outros);					
			}
		}	    

	    $consulta->result = $dataRel;
		$consulta->getCSV("viagem");
	}

	function btnGerarRelatorio_click()
	{	
		global $MIOLO, $module, $item;
	    /*$data = $this->getData();
        
	    $report = new MEzPDFReport('2','portrait');
        $h = $report->pdf->getFontHeight(10);
        $ui = $this->manager->GetUI();
        $report->pdf->ezImage($ui->GetImage('','logonet.png'),5,50,'none','left',0);
        $report->pdf->addText(110,810       ,10,'UNIVERSIDADE FEDERAL DE JUIZ DE FORA');
        $report->pdf->addText(110,810-$h,10,'SISTEMA INTEGRADO DE GESTÃO ACADÊMICA - SIGA');
        $report->pdf->ezText('RELATÓRIO DE VIAGENS REALIZADAS POR MOTORISTAS',16,array('justification'=>'center'));
        $report->pdf->addText(200,810-(8*$h),10,"PERÍODO DE ".$data->dataInicio." ATÉ ".$data->dataFim);
        $report->pdf->ezText('',20);
        //unset($dataRel);
        
        $options['textCol'] = array(0,0,0);
	    $options['shaded'] = 1;
	    $options['showLines'] = 0;
	    $options['fontSize'] = 11;
	    $options['width'] = 540;
	    $options['xPos'] = 'left';
	    $options['xOrientation'] = 'right';
	    
	    $cols = array('<b>NOME</b>','<b>RIO DE JANEIRO</b>','<b>BELO HORIZONTE</b>','<b>OUTROS</b>');

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////	    
	    $motorista = $this->motorista;
	    $itemveiculo = $this->itemveiculo;
	    $nomes = $motorista->ListNomeById()->result;

	    $totalRj = 0;
	    $totalBh = 0;
	    $totalOutros = 0;
		foreach ( $nomes as $n )
		{
			$nomeMotorista = $n[0];
			$idMotorista = $n[1];
			$rj = 0;
			$bh = 0;
			$outros = 0;
			$viagens = $itemveiculo->listViagensbyMotorista($idMotorista,$data->dataInicio,$data->dataFim)->result; // variavel viagem recebeu a consulta
			if ( $viagens )
			{
				foreach ( $viagens as $v )
				{
					$idMunicipioOrig = $v[0];
					$idMunicipioDest = $v[1];							
					if ( $idMunicipioDest == 4733 )
					{
						switch($idMunicipioOrig)
						{
							case 4123:
								$bh++;
								break;
							case 6001:
								$rj++;
								break;
							default:
								$outros++;							
								break;
						}					
					}
					
					if ( $idMunicipioOrig == 4733 )
					{
						switch($idMunicipioDest)
						{
							case 4123:
								$bh++;
								break;
							case 6001:
								$rj++;
								break;
							default:
								$outros++;							
								break;
						}										
					}				
				}
				$totalRj += $rj;
				$totalBh += $bh;
				$totalOutros += $outros;
				$dataRel[] = array($nomeMotorista,$rj,$bh,$outros);					
			}
		}	    

	    $dataRel[] = array('TOTAL',$totalRj,$totalBh,$totalOutros);
	    
        $report->pdf->ezTable($dataRel,$cols,'',$options);
	    $report->Execute();
	    */
		$inicio = Form::getFormValue('dataInicio');
                $final = Form::getFormValue('dataFim');

                $partes_da_data = explode('/',$inicio);
                $datainicial =  $partes_da_data[2].'/'.$partes_da_data[1].'/'.$partes_da_data[0];
                $partes_da_data = explode('/',$final);
                $datafinal =  $partes_da_data[2].'/'.$partes_da_data[1].'/'.$partes_da_data[0];

		if($inicio == '' || $final == '')
                {
                     $this->addError('Favor Selecionar as Datas de Início e Término do Relatório.');
                }
                else if($datainicial > $datafinal)
                     {
                          $this->addError('É necessário que a data inicial seja inferior a final!');
                     }
                     else
                     {
			$report = new MJasperReport('sigaept');

//		$parameters['dataInicio'] = $data->dataInicio; 
//		$parameters['dataFim'] = $data->dataFim; 

			$parameters['dataInicio'] 	= Form::GetFormValue('dataInicio');
			$parameters['dataFim'] 		= Form::GetFormValue('dataFim'); 
		       	$parameters['SUBREPORT_DIR']	= $MIOLO->GetConf('home.modules');
		       	$parameters['int_pIdUsuario']	= $MIOLO->login->idkey;
		       	$parameters['pURL']		= $MIOLO->GetConf('home.url');

             

		       	$report->Execute('adm', 'ViagemMotorista', $parameters);
		     }
		
    }

	function btnGerarRelatorioXls_click()
        {
		global $MIOLO, $module, $item;
		
		$inicio = Form::getFormValue('dataInicio');
                $final = Form::getFormValue('dataFim');

                $partes_da_data = explode('/',$inicio);
                $datainicial =  $partes_da_data[2].'/'.$partes_da_data[1].'/'.$partes_da_data[0];
                $partes_da_data = explode('/',$final);
                $datafinal =  $partes_da_data[2].'/'.$partes_da_data[1].'/'.$partes_da_data[0];

                if($inicio == '' || $final == '')
                {
                     $this->addError('Favor Selecionar as Datas de Início e Término do Relatório.');
                }
                else if($datainicial > $datafinal)
                     {
                          $this->addError('É necessário que a data inicial seja inferior a final!');
                     }
                     else
                     {

			$report = new MJasperReport('sigaept');
	
        	        $parameters['dataInicio']       = Form::GetFormValue('dataInicio');
                	$parameters['dataFim']          = Form::GetFormValue('dataFim');
		        $parameters['SUBREPORT_DIR']    = $MIOLO->GetConf('home.modules');
        		$parameters['int_pIdUsuario']   = $MIOLO->login->idkey;
	        	$parameters['pURL']             = $MIOLO->GetConf('home.url');
	        	$report->Execute('adm', 'ViagemMotoristaXls', $parameters, null, xls);
		    }
	}

}
?>
