
<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>

<?
class frmRepLancamentosPorUO extends MForm
{
	protected $bolsa;

    function __construct()
    {
        global $MIOLO;
        parent::__construct('Relatório Dotações Por UO');
        $this->EventHandler();
    }

	function CreateFields()
	{
	    global $MIOLO;
		$uo = $this->manager->getbusiness('adm','uo');
        $login = $this->manager->getlogin();
        $idusuario = $login->idkey;

        if ( $MIOLO->getPerms()->isMemberOf($MIOLO->getLogin()->id,'adm_adminorcamento') or $MIOLO->getPerms()->isAdmin())
	    {
	       $uo = $uo->listUosOrdemNome();
	    }
	    else
	    {
	       $uo = $uo->listUosByGestor($idusuario);
	    }

        $fields = Array(
            new MSelection('idUO','','UO Req.',$uo->result,false),
            //new LookupTextField('lkpUO', '', 'UO', 60),
            //new MHiddenField('idUO'),
			new MCalendarField('dataInicio','','Data Inicial',10,'informe a data inicial do relatório.'),
			new MCalendarField('dataFim','','Data Final',10,'informe a data final do relatório.'),
		);
		$this->SetFields($fields);
		/*
		$this->SetFieldAttr('lkpUO','module','adm');
		$this->SetFieldAttr('lkpUO','item','Uo');
		$this->SetFieldAttr('lkpUO','event','filler');
		$this->SetFieldAttr('lkpUO','related', 'idUO,lkpUO');
		*/
		$buttons = Array (new FormButton('btnGerarRelatorio', 'Gerar Relatório','pdf'));
		$this->SetButtons($buttons);
	}

	function btnGerarRelatorio_click()
	{
		global $MIOLO;
		$data = $this->getData();

		$partes_da_data = explode('/',$data->dataInicio);
                $datainicial =  $partes_da_data[2].'/'.$partes_da_data[1].'/'.$partes_da_data[0];
                $partes_da_data = explode('/',$data->dataFim);
                $datafinal =  $partes_da_data[2].'/'.$partes_da_data[1].'/'.$partes_da_data[0];

		if($data->dataInicio == '' || $data->dataFim == '')
		{
	    		$this->addError('Favor Selecionar as Datas de Início e Término do Relatório.');
	    	}
		else if($datainicial > $datafinal)
		     {
			   $this->addError('É necessário que a data inicial seja inferior a final!');
		     }
		    else
		    {
	        	if ($data->idUO == '')
		        {
		            $this->addError('Por favor selecione a UO.');
	        	}
		        else
		        {
                		$report = new MJasperReport('sigaept');
		                $parameters['str_DATA_INI'] = $this->getFieldValue('dataInicio');
                		$parameters['str_DATA_FIM'] = $this->getFieldValue('dataFim');
		                $parameters[int_IDUO] = $this->getFieldValue('idUO');
				$parameters['SUBREPORT_DIR']  = $MIOLO->GetConf('home.modules');
				$parameters['pURL']           = $MIOLO->GetConf('home.url');
				$parameters['int_pIdUsuario'] = $MIOLO->login->idkey;                
		         //       $parameters['str_SUBREPORT_DIR'] = $this->manager->getConf('home.modules') . "/common/reports/";
                		$report->Execute('adm', 'LancamentosPorUO', $parameters);
		        }
		    }
	}
}
?>
