
<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>

<?
/**
/**
 * Formulário para imprimir requisicao
 * 
 */
class frmImprimirReq extends Form
{
	var $objRequisicao;

	function __construct()
    {
		global $MIOLO;
		$this->objRequisicao = $MIOLO->GetBusiness('adm','requisicao');
        $this->Form('Imprimir Requisição');
		$this->SetClose($this->manager->GetActionURL('adm','main'));
        $this->EventHandler();
    }

    function CreateFields()
    {
		$fields = array(
			new TextField('numRequisicao','','Número da Requisição',10,''),
		);
       	$this->SetFields($fields);

		$button = array(
			new FormButton('btnProcurar','Procurar')
		);
       	$this->SetButtons($button);
		$this->defaultButton = false;
	}


	function btnProcurar_click()
	{

		$id = $this->GetFormValue('numRequisicao');
		if(($id=='') or (($id!='')and(!is_numeric($id))) )
		{	
			$this->manager->information("Digite Apenas números.", $this->manager->getActionUrl('adm','main:recursos:imprimirreq'));
		}
		else  
		{ 
			$requisicao = $this->objRequisicao->getById($id);
			$idTipo = $requisicao->idTipoReq;
			$idUsuario = $this->manager->GetLogin()->idkey;
					    
			switch ($idTipo) //seleciona o relatorio
			{
				case 1:
					$tipo = 'alimentacao';
					$action_rep = $this->manager->getActionURL('adm','main:requisicoes:reprequisicaoalimentacao', '', array("req"=>"{$this->objRequisicao->idRequisicao}"));
					break;
				case 2:
					$tipo = 'hospedagem';
					$action_rep = $this->manager->getActionURL('adm','main:requisicoes:reprequisicaohospedagem', '', array("req"=>"{$this->objRequisicao->idRequisicao}"));
					break;
				case 3:
					$tipo = 'passagem';
					$action_rep = $this->manager->getActionURL('adm','main:requisicoes:reprequisicaopassagem', '', array("req"=>"{$this->objRequisicao->idRequisicao}"));
					break;
				case 4:
					$tipo = 'veiculo';
					$action_rep = $this->manager->getActionURL('adm','main:requisicoes:reprequisicaoveiculo', '', array("req"=>"{$this->objRequisicao->idRequisicao}"));
					break;
				/*
				case 5:
					$tipo = 'diaria';
					$action_rep = $this->manager->getActionURL('adm','main:requisicoes:reprequisicaodiaria', '', array("req"=>"{$this->objRequisicao->idRequisicao}"));
					break;
				*/
				case 6: $tipo = 'compra permanente';
                                case 7:	$tipo = 'compra consumo';
                                case 10: $tipo = 'compra acervo biblioteca';
                                case 13: $tipo = 'compra acervo setorial';
                                        $action_rep = $this->btnSelecionar_click();
                                        $this->setFormValue('numRequisicao', null);
					return;	
                                        break;
			}

			if ($tipo == null)
			{ 
				//nao existe requisicao
				$this->manager->information("Requisição não encontrada.", $this->manager->getActionUrl('adm','main:recursos:imprimirreq'));
			}
			else
			{
				if ($idTipo == 3)
				{ 
					//requisicao de passagem (onibus ou aviao)
					$itemReq = $this->objRequisicao->getItem();
					$tipoPassagem = $itemReq->tipoTransporte;
				}

				if(($idTipo == 3) and ($tipoPassagem == 1))
				{ 
					//onibus ->testa se é gestor
					$this->objRequisicao->getUoRequisitante();
					if (! $this->objRequisicao->uoRequisitante->isGestorOf($idUsuario) )
					{
						$this->manager->information("Apenas o gestor da unidade pode imprimir esta requisição.", $this->manager->getActionUrl('adm','main:recursos:imprimirreq'));
					}
				}
				else if($idTipo == 5)
				{ 
					$this->manager->information("Esta requisição é de diária. Você deve usar a opção Diária no menu de relatórios.", $this->manager->getActionUrl('adm','main:recursos:imprimirreq'));
				}
				elseif($idTipo != 5)
				{										//outras -> testa se é executor
					$this->objRequisicao->getUoExecutante();
					if (! $this->objRequisicao->uoExecutante->isExecutorOf($idUsuario) )
					{
						$this->manager->information("Apenas o executor da unidade pode imprimir esta requisição.", $this->manager->getActionUrl('adm','main:recursos:imprimirreq'));
					}
				}
				
				//pergunta se deseja imprimir
				$action_voltar = $this->manager->getActionURL('adm','main:recursos:imprimirreq');
				$this->manager->Confirmation("Requisição de ".$tipo." encontrada com sucesso. Clique OK para imprimir a requisicão e CANCELAR para voltar.",$action_rep, $action_voltar);
			}
		}	
	}

	function btnSelecionar_click()
	{
		global $MIOLO, $module,$self,$item,$theme;
                $numRequisicao = $this->getFormValue('numRequisicao');
                if($numRequisicao)
                {
                        $form = new MForm('Requisição: ' . $numRequisicao);

                        $buttons = array(
                                new MButton('btnImprimir','Gerar Relatório','PDF'),
                        );
                        $form->SetButtons($buttons);

                        $theme->appendContent($form);
                }
   	}




	function btnImprimir_click()
        {
                global $MIOLO;

                $report = new MJasperReport( 'sigaept' );
                $parameters[ 'str_TITULO' ] = "SITUAÇÃO GERAL DA REQUISIÇÃO";
                $parameters[ 'int_requisicao' ] = $this->GetFormValue('numRequisicao');
                $parameters[ 'pURL' ] = $MIOLO->GetConf( 'home.url' );
                $parameters[ 'SUBREPORT_DIR' ] = $MIOLO->GetConf('home.modules');
                $parameters[ 'int_pIdUsuario' ] = $MIOLO->login->idkey;

                $report->Execute( 'adm', 'repRequisicaoSitGeral', $parameters );
    }

}
?>
