
<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>

<?php
class repEstoque extends PDFReport
{
	var $img;
    var $timestamp;
	var $objEstoque;
	var $objExecutor;

	function __construct()
	{
		global $MIOLO, $module, $page, $context, $self, $action, $perms;

		parent::__construct(NULL, NULL, 55);
	    $ui = $MIOLO->GetUI();
		$this->img = $ui->GetImageSrc('logonet.png'); 

		$this->SetOption('showLines',0);
		$this->timestamp = date('d/m/Y G:i');

		$this->pdf->ezStartPageNumbers(520, 800, 11, 'rigth', 'Página: {PAGENUM}');
		$this->pdf->ezSetMargins(50, 30, 30, 30);
		$this->GeneratePageHeader();
		$this->SetOption('fontSize',10);
	
		$objEstoque = $MIOLO->GetBusiness($module,'estoque');
		$objExecutor = $MIOLO->GetBusiness($module,'executor');
		$uo = $objExecutor->listUoByUsuario($MIOLO->GetLogin()->idkey);
		$quant_uo = count($uo->result);
		$j = 0;

		for($i=0; $i<$quant_uo; $i++){

			$query = $objEstoque->relatorioestoque($uo->result[$i][0]);

			if($query->result[0][0] <> null){

				$j++;
				$query->SetOrder('idmaterial,descricao,estoque');

				unset($dataini);

				foreach($query->result as $row){
					$row[3] = 'R$ ' . number_format(str_replace(',','.',$row[3]),2,',','.');
					$dataini[] = $row;
				}

				$data[$i]=$dataini;

				$columns = array(
					new PDFReportColumn('idmaterial','Código','right',true,10,true,null,true),
					new PDFReportColumn('descricao','Nome','left',true,63,true,null,true),
					new PDFReportColumn('estoque','Quantidade','center',true,12,true,null,true),
					new PDFReportColumn('valortotal','Valor','left',true,15,true,null,true),
				);

				$this->SetColumns($columns);
				$colDetail[$i] = $this->columns;
			}
		}

		// gera o report
		for($i=0; $i<$j; $i++){
			$this->columns = $colDetail[$i];
			$this->GenerateGroupHeader($uo->result[$i][1]);
			$this->GenerateData($data[$i]);
		}

		$this->GeneratePageFooter();
	}

	function GeneratePageHeader()
	{   
		$h = $this->pdf->getFontHeight(12);
   		$x0=$this->pdf->left;	

		$x00=$this->pdf->left;
		$hh = $this->pdf->getFontHeight(12);
		$this->pdf->addText($x00, 800, 12, $this->manager->getConf('instituicao.sigla')." - ".$this->manager->getConf('instituicao.nome'));
		$this->pdf->addText($x00, 800 - $hh, 12, $this->manager->getConf('theme.system'));

		/*$this->pdf->ezImage($this->img,5,50,'none','left');
		$this->pdf->addText(90,800,12,'UFJF - Universidade Federal de Juiz de Fora');
		$this->pdf->addText(90,800-$h,12,'CGCO - Centro de Gestão do Conhecimento Organizacional');
		$this->pdf->addText(90,800-$h-$h,12,'SIGA - Sistema Integrado de Gestão Acadêmica');
		$this->pdf->addText(90,800-$h-$h-$h,12,'Módulo Administrativo');*/

		$this->pdf->ezSetY(800-$h-$h-$h-$h);
		$this->pdf->ezText("Relação de Itens do Estoque",14,array('justification'=>'center'));
		$this->pdf->ezSetY(800-$h-$h-$h-$h-$h);
		
	}

	function GenerateGroupHeader($uo)
	{
		$this->pdf->SetStrokeColor(0, 0, 0);
		$x0 = $this->pdf->left;

		$this->pdf->ezSetDy(-32, 'makeSpace');
		$y = $this->pdf->y-20;
		$this->pdf->addText($x0, $y + 19, 12, 'UO: ' . $uo);
		$this->pdf->line($x0, $y + 15, 200, $y + 15);
	}

	function GeneratePageFooter()
	{
		global $MIOLO, $module, $item;

		$this->pdf->ezSetDy(-12);
		$this->pdf->ezText($this->timestamp,10,array('justification'=>'right'));
	}

	function GenerateData($data)
	{
		$this->pdf->ezSetDy(-12);
		$this->SetData($data);
		$this->rawdata = $this->GenerateTableData();
		$this->GenerateBody($this->rawdata);
	}

	function Generate()
	{
		$this->SetOutput();
		$this->Execute();
	}

}
?>
