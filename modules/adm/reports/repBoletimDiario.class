
<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>

<?php
class repBoletimDiario extends PDFReport
{
	var $img;
	var $timestamp;
	var $objRequisicao;
	var $objPassagem;

	function __construct()
	{
		global $MIOLO, $module, $page, $context, $self, $action, $perms;

		$iduoreq = Form::GetFormValue('idUo');
		$dataInicio = Form::GetFormValue('dataInicio');
		$dataFim = Form::GetFormValue('dataFim');		
				
		//var_dump($iduoreq,$dataInicio,$dataFim);
		
		parent::__construct(NULL, NULL, 55);
	    
		$ui = $MIOLO->GetUI();
        $this->img = $ui->GetImageSrc('logo_siga.png',$module);

		$this->SetOption('showLines',0);
		$this->timestamp = date('d/m/Y G:i');

		
		$this->pdf->ezStartPageNumbers(580, 800, 10, 'rigth', 'Página: {PAGENUM}/{TOTALPAGENUM}');
		$this->pdf->ezSetMargins(50, 30, 30, 30);
		$this->SetOption('fontSize',7);

		$objUO = $MIOLO->GetBusiness('adm','uo');
		$objEmpenho = $MIOLO->GetBusiness($module,'empenho');			
		$objTipoReq = $MIOLO->GetBusiness($module,'tiporeq');		
		$descReq = $objTipoReq->GetById($tipoReq)->descricao;
			
		$query = $objEmpenho->ListBoletimDiarioEntrada($dataInicio, $dataFim, $iduoreq);		
		$query2 = $objEmpenho->ListBoletimDiarioSaida($dataInicio, $dataFim, $iduoreq);		
		$saldoatual = $objEmpenho->GetSaldoAtual($iduoreq);
		$saldoatual = floatval(str_replace(',','.',$saldoatual[0][0]));		
		//var_dump($saldoatual);			
		
				
		if ($iduoreq == '%')
		{
			$UO->nome = 'TODAS';
		}
		else 
		{		
			$UO = $objUO->GetById($iduoreq);				
		}
			
		$totalentrada = 0;
		$totalsaida = 0;
			

		if ($query)
		{
			foreach($query as $row)
			{
					
				
			//	var_dump($objEmpenho->numProcessoFormatado($row[0]));
					
				$totalentrada += floatval(str_replace(',','.',$row[9]));
				
				$row[9] = 'R$ ' . number_format(str_replace(',','.',$row[9]),2,',','.');
												
				$data1[] = $row;
				
			}
		}
		if ($query2)
		{
			foreach($query2 as $row)
			{
					
				
			//	var_dump($objEmpenho->numProcessoFormatado($row[0]));
				
				$totalsaida += floatval(str_replace(',','.',$row[9]));
					
				$row[9] = 'R$ ' . number_format(str_replace(',','.',$row[9]),2,',','.');
													
				$data2[] = $row;
				
			}
		}
		//var_dump($saldoatual,$totalentrada,$totalsaida);
		$saldoanterior = $saldoatual+$totalsaida-$totalentrada;
		$soma = $saldoanterior+$totalentrada;			
			
		$totalentrada = 'R$ ' . number_format(str_replace(',','.',$totalentrada),2,',','.');
		$totalsaida = 'R$ ' . number_format(str_replace(',','.',$totalsaida),2,',','.');
		$saldoatual = 'R$ ' . number_format(str_replace(',','.',$saldoatual),2,',','.');
		$saldoanterior = 'R$ ' . number_format(str_replace(',','.',$saldoanterior),2,',','.');
		$soma = 'R$ ' . number_format(str_replace(',','.',$soma),2,',','.');
			
			
		if (!$data1)
		{
			$data = $data2;			
		}
		else if (!$data2)
		{
			$data = $data1;
		}
		else if ((!$data1) && (!$data2))
		{
			$data == NULL;
		}
		else 
		{
			$data = array_merge($data1, $data2);
		}
			
		//var_dump($data);
			
		$summary1[] = array(array("<b>TOTAL ENTRADA :</b>", "<b>$totalentrada</b>","","","",""));
		$summary2[] = array(array("<b>TOTAL SAÍDA :</b>", "<b>$totalsaida</b>","","","",""));
		$summary3[] = array(array("<b>SALDO ANTERIOR :</b>", "<b>$saldoanterior</b>","","","",""));
		$summary4[] = array(array("<b>SALDO ATUAL :</b>", "<b>$saldoatual</b>","","","",""));
		$summary5[] = array(array("<b>SOMA :</b>", "<b>$soma</b>","","","",""));

		$columns = array(
				new PDFReportColumn('codigo','<b><i>CÓDIGO</b></i>','left',true,7,true,null,true),
				new PDFReportColumn('especificacao','<b><i>ESPECIFICAÇÃO</b></i>','left',true,40,true,null,true),
				new PDFReportColumn('unidade','<b><i>UN</b></i>','center',true,4,true,null,true),
				new PDFReportColumn('empenho','<b><i>EMPENHO</b></i>','center',true,15,true,null,true),
				new PDFReportColumn('nf','<b><i>N.FISCAL</b></i>','center',true,8,true,null,true),
				new PDFReportColumn('uo','<b><i>UO</b></i>','center',true,5,true,null,true),
				new PDFReportColumn('requisicao','<b><i>REQ.</b></i>','center',true,6,true,null,true),
				new PDFReportColumn('entrada','<b><i>ENT.</b></i>','center',true,6,true,null,true),
				new PDFReportColumn('qt','<b><i>QT.</b></i>','center',true,5,true,null,true),
				new PDFReportColumn('valor','<b><i>VALOR</b></i>','center',true,10,true,null,true),
				//new PDFReportColumn('tipo','<b><i>TIPO</b></i>','center',true,2,false,null,true),
			);
			
			// define as colunas da linha de grupo (level1)
	    $sum1 = array(
	            new MPDFReportColumn('texto', 'texto', 'left', false, 15, true), 
	            new MPDFReportColumn('vs11', 'valor1', 'left', false, 15, true),
	            new MPDFReportColumn('vs12', 'valor2', 'left', false, 15, true), 
	            new MPDFReportColumn('vs13', 'valor3', 'left', false, 15, true),
	            new MPDFReportColumn('vs14', 'valor3', 'left', false, 15, true),
	            new MPDFReportColumn('vs15', 'valor3', 'left', false, 20, true),        
	            );
	    
	    $sum2 = array(
	            new MPDFReportColumn('texto1', 'texto', 'left', false, 15, true), 
	            new MPDFReportColumn('vs21', 'valor1', 'left', false, 15, true),
	            new MPDFReportColumn('vs22', 'valor2', 'left', false, 15, true), 
	            new MPDFReportColumn('vs23', 'valor3', 'left', false, 15, true),
	            new MPDFReportColumn('vs24', 'valor3', 'left', false, 15, true),
	            new MPDFReportColumn('vs25', 'valor3', 'left', false, 20, true),
	            );
	    
	    $sum3 = array(
	            new MPDFReportColumn('texto2', 'texto', 'left', false, 15, true), 
	            new MPDFReportColumn('vs31', 'valor1', 'left', false, 15, true),
	            new MPDFReportColumn('vs32', 'valor2', 'left', false, 15, true), 
	            new MPDFReportColumn('vs33', 'valor3', 'left', false, 15, true),
	            new MPDFReportColumn('vs34', 'valor3', 'left', false, 15, true),
	            new MPDFReportColumn('vs35', 'valor3', 'left', false, 20, true),
                );
       
        $sum4 = array(
	            new MPDFReportColumn('texto3', 'texto', 'left', false, 15, true), 
	            new MPDFReportColumn('vs41', 'valor1', 'left', false, 15, true),
	            new MPDFReportColumn('vs42', 'valor2', 'left', false, 15, true), 
	            new MPDFReportColumn('vs43', 'valor3', 'left', false, 15, true),
	            new MPDFReportColumn('vs44', 'valor3', 'left', false, 15, true),
	            new MPDFReportColumn('vs45', 'valor3', 'left', false, 20, true),
                );
        
        $sum5 = array(
	            new MPDFReportColumn('texto4', 'texto', 'left', false, 15, true), 
	            new MPDFReportColumn('vs51', 'valor1', 'left', false, 15, true),
	            new MPDFReportColumn('vs52', 'valor2', 'left', false, 15, true), 
	            new MPDFReportColumn('vs53', 'valor3', 'left', false, 15, true),
	            new MPDFReportColumn('vs54', 'valor3', 'left', false, 15, true),
	            new MPDFReportColumn('vs55', 'valor3', 'left', false, 20, true),
                );

	//		$this->SetColumns($columns);

		// gera o report

		
		
		// Largura do report, em %
	    $this->SetWidth(100);
	    $this->SetColumns($columns);
	    $colDetail = $this->columns;
	    $this->SetColumns($sum1);
	    $this->SetColumns($sum2);
	    $this->SetColumns($sum3);
	    $this->SetColumns($sum4);
	    $this->SetColumns($sum5);
	    $colSum1 = $this->columns;
		$colSum2 = $this->columns;
		$colSum3 = $this->columns;	            
		$colSum4 = $this->columns; 
		$colSum5 = $this->columns;
	    // gera o report
	   
	    $this->columns = $colDetail; 
	    
	    $this->GeneratePageHeader($dataInicio, $dataFim, $UO);
		$this->GenerateData($data);
		$this->GeneratePageFooter();
	    
	    
	    
	    $this->SetOption('showHeadings', 0);
	    $this->SetOption('showLines', 0);
	    $this->columns = $colSum1;
	    $this->columns = $colSum2;
	    $this->columns = $colSum3;
	    $this->columns = $colSum4;
	    $this->columns = $colSum5;
	    
	   
	    
		
		
		
		
		if (( $query == NULL ) && ( $query2 == NULL)) 
		{			
		// gera o report
			$this->GeneratePageHeader($dataInicio, $dataFim,  $UO);
			$this->GenerateDatanull();
			$this->GeneratePageFooter();
		}
		else 
		{
			$this->GenerateData($summary1[0]);
	    	$this->GenerateData($summary2[0]);	
	    	$this->GenerateData($summary3[0]);
	    	$this->GenerateData($summary4[0]);		
	    	$this->GenerateData($summary5[0]);
		}

	}

	function GeneratePageHeader($dataInicio, $dataFim, $UO)
	{
		global $MIOLO;
			
		$x0 = $this->pdf->left;
		$h = $this->pdf->getFontHeight(12);
//		$this->pdf->addPngFromFile($this->img, 10, 730 + $x0, 100, 54);


		$x0=$this->pdf->left;	
		$this->pdf->addText($x0, 800, 12, $this->manager->getConf('instituicao.sigla')." - ".$this->manager->getConf('instituicao.nome'));
		$this->pdf->addText($x0, 800 - $h, 12, $this->manager->getConf('theme.system'));		

/* $this->pdf->addText(110,800,12,'UFJF - Universidade Federal de Juiz de Fora');
		$this->pdf->addText(110,800-$h,12,'CGCO - Centro de Gestão do Conhecimento Organizacional');
		$this->pdf->addText(110,800-$h-$h,12,'SIGA - Sistema Integrado de Gestão Acadêmica');		
*/		
		$this->pdf->addText(110,800-$h-$h-$h,12,'Pré-Reitoria de Logística');

		$this->pdf->addTextWrap(10,800-5*$h,600,11,'Boletim Diário','left');
		$this->pdf->addTextWrap(10,800-6*$h,600,11,'UO : '.$UO->nome, 'left');
		$this->pdf->addTextWrap(10,800-7*$h,600,11,'Período de '.$dataInicio.' a '.$dataFim, 'left');

		$this->pdf->ezSetY(800-$h-$h-$h-$h-$h-$h-$h);
	}

	function GeneratePageFooter()
	{
		$x0 = $this->pdf->left;
        $x1 = $this->pdf->right;
        $footer = $this->pdf->openObject();
        $this->pdf->saveState();
        $this->pdf->SetStrokeColor(0, 0, 0);
        $this->pdf->line($x0, 28, $x1, 28);
        $this->pdf->addText($x0, 19, 9, $this->timestamp . ' - CGCO/DSI');
        $this->pdf->restoreState();
        $this->pdf->closeObject();
        $this->pdf->addObject($footer, 'all');    		

	}

	function GenerateData($data)
	{
		$this->pdf->ezSetDy(-12);
		$this->SetData($data);
		$this->rawdata = $this->GenerateTableData();
		$this->GenerateBody($this->rawdata);
	}
	function GenerateDataNULL()
	{
		$this->pdf->ezSetDy(-12);
		$h = $this->pdf->getFontHeight(12);		
		$this->pdf->addTextWrap(0,800-12*$h,600,11,' NÃO FORAM ENCONTRADOS DADOS RELATIVOS À CONSULTA SOLICITADA ', 'center');
		
	}

	function Generate()
	{
		$this->SetOutput();
		$this->Execute();
	}
}
?>
