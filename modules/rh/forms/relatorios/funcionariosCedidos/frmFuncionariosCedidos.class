<?
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */

class frmFuncionariosCedidos extends MForm
{
	function __construct()
    	{
        	parent::__construct('Relatório de Servidores Cedidos');
        	$this->SetClose($this->manager->GetActionURL('rh','main:relatorio'));
        	$this->EventHandler();
    	}

    	function CreateFields()
    	{
        	$ui = $this->manager->getUI();
        	//$grid = $ui->getGrid('rh','gridCedidos', NULL,'relatorios');
        	$fields = array(
            		new CalendarField('dtReferencia','','Data de referência','10'),
            		//new MCalendarField('dtReferencia','07/03/2007','Data de referência'),
            		//new MCalendarField('dtFim','','Fim')
        			);
        	$this->SetFields($fields);
        	$buttons = array(
            	//new MButton('btnExibe','Exibir'),
            	new MButton('btnReport','Gerar Relatório', 'PDF'),
            	new MButton('btnPasso1','Enviar'),
            	new MButton('btnGerarCSV','Gerar Planilha'),
        				);
		$validators = array(
				new MRequiredValidator('dtReferencia')
				);
        	$this->SetButtons($buttons);
        	$this->defaultButton = false;
		$this->setButtonAttr('btnReport','visible',false);
		$this->setButtonAttr('btnGerarCSV','visible',false);

		$this->setValidators($validators);
    	}

    	//function btnExibe_click(){}

    	function btnPasso1_click()	
    	{
	        $dtReferencia = $this->GetFormValue('dtReferencia');
		$dt = strlen(trim($dtReferencia));
        	if ( is_null($dtReferencia) or empty($dtReferencia) or ($dt < '10'))
		{
			$this->addError('Selecione a data de referência corretamente');
		}
		else
		{
			$this->addInfo('Escolha a opção para a geração de relatório clicando no botão abaixo');
			$this->setFieldAttr('dtReferencia','readonly',true);
			$this->setButtonAttr('btnReport','visible',true);
			$this->setButtonAttr('btnGerarCSV','visible',true);
			$this->setButtonAttr('btnPasso1','visible',false);
		}


		
    	}
	function btnReport_click()
	{
		global $MIOLO; 
       		$report = new MJasperReport('sigaept'); 
		$data = $this->GetData();
		$dtReferencia = new InvertDate($data->dtReferencia);
		$parameters['str_data'] = $dtReferencia->date;
		$parameters['SUBREPORT_DIR'] = $MIOLO->GetConf('home.modules');
		$parameters['int_pIdUsuario']= $MIOLO->login->idkey;
		$parameters['pURL']=$MIOLO->GetConf('home.url');
		$report->Execute('rh', 'funcionariosCedidos', $parameters);
		
	}
    	/*function btnReport_click()
    	{

         	$data = $this->getData();
            	$ui = $this->manager->getUi();
            	$report = $ui->getReport('rh','repFuncionariosCedidos',$data);
            	$report->generate();

    	}*/
    
    	function btnGerarCSV_click()
	{
		$objCessao = $this->manager->GetBusiness('rh','cessao');
		$dtReferencia = $this->GetFormValue('dtReferencia');
		$consulta = $objCessao->listFuncionariosCedidos($dtReferencia);            

		$resultAux[] = array('Matrícula','Nome','Data de Início','Data de Fim','Onus','Cessão','Descrição','Instituição');
		if (!$consulta->result)
                	$consulta->result = array();
		foreach ($consulta->result as $result)		  
	    	{
	    		$resultAux[] = array($result[0],$result[1],$result[2],$result[3],$result[4],$result[5],$result[6],$result[7]);		
	    	}
			$consulta->result = $resultAux;
			$consulta->getCSV("funcionariosCedidos.$dtReferencia"); 
	}
 }
?>
