<?PHP
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */

class frmDependenteParentesco extends MForm
{
  protected $dependente;

  function __construct($iddependente)
  {
    global $module, $MIOLO;
    $this->dependente = $MIOLO->GetBusiness($module, 'dependente', $iddependente);
    parent::__construct('Alteração de parentesco');
    $this->EventHandler();
  } // __construct

  function CreateFields()
  {
    global $module;

    $parentesco = $this->GetFormValue('parentesco'); //para obter o novo valor, após gravação de uma alteração
    if (!$parentesco) //iniciando, obtém do banco

    {
      $parentesco = $this->dependente->parentesco;
    }

    $tabelaGeral = $this->manager->GetBusiness('common', 'tabelageral');

    $query = $tabelaGeral->getByItem('RH_PARENTESCO', $parentesco);
    $fields[] = new Mspacer(1);
    $fields[] = new MTextLabel('', $query->item2, 'Parentesco atual', 'green', true);
    $fields[] = new Mspacer(1);

    $query = $tabelaGeral->ListByTabela('RH_PARENTESCO', 'item2');
    $fields[] = new MLabel('Caso queira modificar o parentesco, escolha:');
    $fields[] = new MSelection('parentesco', $this->dependente->parentesco, '', $query->
      result);

    $this->SetFields($fields);
    $this->AddButton(new MButton('btnSalvar', 'Salvar'));
  } // CreateFields

  function btnSalvar_click()
  {
    global $module;

    $parentesco = $this->GetFieldValue('parentesco');

    if (!$parentesco)
    {
      $this->addError("faltou escolher o parentesco");
    } else
    {
      try
      {
        $operacao = OP_UPD;
        $descricao = 'Parentesco alterado ' . $this->dependente->parentesco .
          ', iddependente ' . $this->dependente->idDependente;

        $this->dependente->parentesco = $parentesco;

        $this->dependente->beginTransaction();
        $this->dependente->save(true);
        $this->dependente->Log($operacao, $descricao);
        $this->dependente->endTransaction();
        $this->AddInfo($msg);

      }
      catch (exception $e)
      {
        $this->AddError($e->GetMessage());
      }
    }
  } // btnSalvar_click

}

?>
