<?
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */

class repFerias extends MPDFReport
{
    private $img;
    private $timestamp;
    private $total;
    private $mes;
    private $ano;

    function __construct($data)
    {
        global $MIOLO, $module, $page, $context, $self, $action, $perms;
        parent::__construct(NULL,NULL,55,NULL,'landscape','a4');
        $ui = $MIOLO->GetUI();
        $this->img = $ui->GetImageSrc('logo_siga.png','rh');
        $this->timestamp = date('d/m/Y G:i');
        $this->pdf->ezStartPageNumbers(800,540,10,'rigth','Página: {PAGENUM}/{TOTALPAGENUM}');
        $this->pdf->ezSetMargins(100,30,20,20);


/*
        if ( ($MIOLO->getPerms()->isMemberOf('','RH_SECRETARIA')) && (!$MIOLO->getPerms()->isMemberOf('','ADMIN')) && (!$MIOLO->getPerms()->isMemberOf('','RH_GESTOR')) )
        {
            $login = $MIOLO->getLogin();
            //var_dump($login->id);
            $usuario = $MIOLO->getBusiness('common','usuario');
            $usuario->getByLogin($login->id);
            //var_dump($usuario->nome, $usuario->idPessoa ,$usuario->idSetor);
            $pessoa = $MIOLO->GetBusiness('common','pessoa',$usuario->idPessoa);
            $funcionario = $MIOLO->GetBusiness('rh','funcionario');
            if ($funcionario->isFuncionario($pessoa->idpessoa))
            {
            	$funcionario->GetFuncionarioByPessoa($pessoa->idpessoa);
            	$vinculoAtivo = $funcionario->GetVinculoAtivo();
            	$provimentoAtual = $vinculoAtivo->GetProvimentoAtual();
            	$usuario->idSetor = $provimentoAtual->idSetor;
            }
        }
        //var_dump($usuario->idSetor);
        // com o usuario, pegar a pessoa
        // com a pessoa, pegar o funcionario (servidor)
        // com o servidor, pegar o vinculo
        // com o vinculo pegar o ultimo provimento
        $setor = $MIOLO->getBusiness('common','setor',$usuario->idSetor);
        //var_dump($setor->sigla, $setor->nome);
        $setorPai = $MIOLO->getBusiness('common','setor');
        $setorPai->getById($setor->idPaiSetor);
        //var_dump($setor->idPaiSetor, $setorPai->idSetor, $setorPai->nome);
        $idSetorPai = ( $setorPai->idPaiSetor == 0 ) ? $setor->idSetor : $setorPai->idSetor;
        $idSetores = $setor->getSetoresFilhos($idSetorPai);
        //var_dump($idSetores);

*/

        $k = new MKrono();
        $objFerias = $MIOLO->GetBusiness('rh','ferias');
        $this->mes = $k->getMonthByNumber($data->selMes);
        $this->ano = $data->txtAno;
        //var_dump($data);
        $query = $objFerias->listFerias($data->selMes,$data->txtAno,$data->rbgSiape,$usuario->idSetor);
        $this->total = count($query->result);
        while ( ! $query->eof() )
        {
            $idMat          = $query->fields('idVinculo');
            $row[]          = $idMat;
            $row[]          = ucwords(strtolower($query->fields('nome')));
            $catg           = $query->fields('categoria');
            if ($catg == 60) {$row[] = 'DOC';} else {$row[] = 'TA';}
            $dtInicioPerAq  = $query->fields('dataInicioPerAq');
            $row[]          = $dtInicioPerAq;
            $row[]          = $query->fields('dataFimPerAq');
            $dtInicioFerias = $query->fields('dataInicio');
            $row[]          = $dtInicioFerias;
            $row[]          = $query->fields('dataFim');
            $row[]          = $query->fields('adiantamento13');
            $row[]          = $query->fields('adiantamentoSalario');
            //$row[]        = $query->fields('abono');
            $row[]          = $query->fields('abonoConst');
            $row[]          = $query->fields('totalDias');
            $row[]          = $objFerias->getPeriodoFerias($idMat,$dtInicioFerias,$dtInicioPerAq);
            $query->moveNext();
            $dataRel[] = $row;
            unset($row);
        }

        $this->GeneratePageHeader();
        $this->GeneratePageFooter();

        if ( is_array($query->result) )
        {
            $columns = array(
                new PDFReportColumn('idVinculo', 'Matrícula', 'center', true, 7, true, null, true),
                new PDFReportColumn('nome', 'Nome', 'left', true, 28, true, null, true),
                new PDFReportColumn('categoria', 'Categ.', 'center', true, 5, true, null, true),
                new PDFReportColumn('dataInicio', 'Dt. Início P.Aquisitivo', 'center', true, 8, true, null, true),
                new PDFReportColumn('dataFim', 'Dt. Fim P.Aquisitivo', 'center', true, 8, true, null, true),
                new PDFReportColumn('dataInicioFerias', 'Dt. Início Férias', 'center', true, 8, true, null, true),
                new PDFReportColumn('dataFimFerias', 'Dt. Fim Férias', 'center', true, 7, true, null, true),
                new PDFReportColumn('adiantamento13', 'Ad. 13º', 'center', true, 4, true, null, true),
                new PDFReportColumn('adiantamentoSalario', 'Ad. Salário', 'center', true, 5, true, null, true),
                new PDFReportColumn('abonoConst', 'Abono C.', 'center', true, 5, true, null, true),
                new PDFReportColumn('totalDias', 'Total Dias', 'center', true, 5, true, null, true),
                new PDFReportColumn('periodo', 'Período', 'center', true, 5, true, null, true),
            );
            $this->SetWidth(110);
            $this->SetColumns($columns);
            $colDetail = $this->columns;
            $this->SetOption('fontSize', 8);
            $this->SetOption('showHeadings', 1);
            $this->SetOption('showLines', 0);
            $this->GenerateData($dataRel);
            $this->GenerateFooter();
        }
        else
        {
            $this->SetWidth(100);
            $x0 = $this->pdf->left;
            $this->pdf->ezSetDy(-32, 'makeSpace');
            $y = $this->pdf->y;
            $this->pdf->addText($x0 +50, $y - 50, 12, 'Não foram encontrados registros.');
        }
    }

    function GeneratePageHeader()
    {
        $x0 = $this->pdf->left;
        $x1 = $this->pdf->right;
        $h = $this->pdf->getFontHeight(10);
        $header = $this->pdf->openObject();
        $this->pdf->saveState();
        $this->pdf->addPngFromFile($this->img, 40, 520 + $x0, 54, 27);
        $this->pdf->addText($x0+85, 560 -$h , 10, 'IF - Instituto Federal');
        $this->pdf->addText($x0+85, 560 -$h -$h , 10, 'SIGA - Sistema Integrado de Gestão Acadêmica - Módulo Recursos Humanos');
        $y = 550 - $h - $h - 5;
        $this->pdf->SetColor(0.4,0.4,0.4);
        $this->pdf->filledRectangle($x0, $y-20, $x1-30, 16 );
        $this->pdf->SetColor(1,1,1);
        $setor = $this->setor;
        $this->pdf->addText($x0 + 5, $y - 16, 10, "Relatório de Férias. Mês: {$this->mes} Ano: {$this->ano}");
        $this->pdf->restoreState();
        $this->pdf->closeObject();
        $this->pdf->addObject($header,'all');
    }

    function GeneratePageFooter()
    {
        $x0 = $this->pdf->left;
        $x1 = $this->pdf->right;
        $footer = $this->pdf->openObject();
        $this->pdf->saveState();
        $this->pdf->SetStrokeColor(0, 0, 0);
        $this->pdf->line($x0, 28, $x1, 28);
        $this->pdf->addText($x0, 19, 9, $this->timestamp . ' - CGCO/DSI');
        $this->pdf->restoreState();
        $this->pdf->closeObject();
        $this->pdf->addObject($footer, 'all');
    }

    function GenerateFooter()
    {
        $this->pdf->ezText(" ", 9, array('justification' => 'left'));
        $this->pdf->ezText(" ", 9, array('justification' => 'left'));
        $this->pdf->ezText(" ", 9, array('justification' => 'left'));
        $this->pdf->ezText("Total de marcações de férias: {$this->total}", 9, array('justification' => 'left'));
        $this->pdf->ezText(" ", 9, array('justification' => 'left'));
    }

    function GenerateData($data)
    {
        $this->pdf->ezSetDy(-5);
        $this->SetData($data);
        $this->rawdata = $this->GenerateTableData();
        $this->GenerateBody($this->rawdata);
    }

    function Generate()
    {
        $this->SetOutput();
        $this->Execute();
    }
}
?>
