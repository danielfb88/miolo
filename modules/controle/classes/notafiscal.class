
<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>

<?
class BusinessControleNotaFiscal extends Business
{
    public $idNotaFiscal;
    public $placa;
    public $idEmpresa;
    public $data;
    public $valorTotal;
    public $idPrevRevisao;
 
    public $manutencoes;   
    public $veiculo;
    public $empresa;
    public $previsao;
        
    function __construct($data=NULL)
    {
        $this->Business('sigaept',$data);
    }
    function GetById($id)
    {
		$this->idNotaFiscal = $id;
		$this->retrieve();
    }
    function setData($data)
    {
		$this->idEmpresa = $data->idEmpresa;
		$this->idPrevRevisao = $data->idPrevRevisao;
		$this->placa = $data->placa;
        $this->data = $data->data;
		$this->valorTotal = $data->valorTotal;
    }
    function getData()
    {
		$data->data = $this->data;
		$data->valorTotal = $this->valorTotal;
		return $data;
    }
    function addManutencao($data)
    {
       $this->manutencoes[] = $data;
    	
    }
    function getManutencoes()
    {
        $this->retrieveAssociation('manutencoes');
        if ($this->manutencoes != NULL)
        {
            if (!is_array($this->manutencoes))
            {
		$this->manutencoes = array($this->manutencoes);  
            }
        }
	return $this->manutencoes;
		
    }
    function setVeiculo($id)
    {
		$this->idVeiculo = $id;
    }
    function getVeiculo()
    {
        $this->retrieveAssociation('veiculo');
    }
    function setEmpresa($id)
    {
		$this->idEmpresa = $id;
    }
    function getEmpresa()
    {
		global $MIOLO;
		$this->empresa = $MIOLO->GetBusiness('controle','empresa',$this->idEmpresa);
		//$this->retrieveAssociation('empresa');
    }
    function setPrevRevisao($id)
    {
    	$this->idPrevRevisao = $id;
    }
    function getPrevRevisao()
    {
    	return $this->idPrevRevisao;
    }
    function listAll()
    {
        global $MIOLO;
        
		$criteria =  $this->getCriteria();
        $criteria->addOrderAttribute('idNotaFiscal');
		$criteria->addColumnAttribute('idNotaFiscal');
		$criteria->addColumnAttribute('placa');
		$criteria->addColumnAttribute('empresa.nome');
		$criteria->addColumnAttribute('valorTotal');
		$criteria->addColumnAttribute('data');
		$criteria->addCriteria('empresa.idEmpresa','=', 'idEmpresa');
        return $criteria->retrieveAsQuery();
    }
    function getManutencao($id)
    {
        if ( $this->manutencoes == NULL )
        {
    		$this->retrieveAssociation('manutencoes');
        }
        
        if ($this->manutencoes != NULL)
        {
            foreach ( $this->manutencoes as $m )
            {
                if ( $m->idManutencao == $id )
                    return $m;
            }
        }
        
        return null;
    }
    function DeleteManutencao($id,$url)
    {
		global $MIOLO;
        $objManutencao = $this->getManutencao($id);
		try
		{
			$this->valorTotal = $this->valorTotal - $objManutencao->valor;
			$objManutencao->Delete();		
			$this->Update();
			$msg = "Manutenção excluida com sucesso.";
			$MIOLO->Information($msg,$MIOLO->GetActionURL('controle',$url,$this->idNotaFiscal));
	}
	catch(Exception $e)
	{
		$this->manager->Error($e->getMessage());
	}
	
    }
    function relManutencoes()
    {
		$sql = new MSql("r.idrequisicao, p.nome, r.enderecoorig, m.municipio as origem, r.enderecodest, m2.municipio as destino, (r.odometrocheg - r.odometrosaida) as KMRodados, (r.odometrocheg - r.odometrosaida)* v.valorkm as Gasto","ad_itemreqveiculo r, cm_municipio m, cm_municipio m2, cm_pessoa p, ad_veiculo v", 'p.idpessoa = r.idpessoa AND m.idmunicipio = r.idmunicipioorigem AND m2.idmunicipio = r.idmunicipiodestino AND v.placa = r.placa');
		$query = $this->Query($sql);
		return $query;
    }	
}
?>
