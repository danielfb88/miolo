
<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>

<?
class frmPassword extends MForm
{
    var $objUsuario;

	function __construct()
    {   global $MIOLO, $module, $page, $context, $self, $action;

        $this->objUsuario = $MIOLO->GetBusiness($module,'usuario');
		parent::__construct('Alteração de senha');
	    $this->EventHandler();
	}

    function CreateFields()
	{  global $auth, $perms, $action;
       $fields = array(
           new MHiddenField('key',''),
	       new MLookupTextField('lkpLogin','','Login',20),
           new MTextLabel('txtLogin','','Login'),
           new MPasswordField('edtSenhaAtual','','Senha Atual',20),
           new MPasswordField('edtSenha1','','Nova Senha',20),
           new MPasswordField('edtSenha2','','Confirmação',20)
       );
	   $this->SetFields($fields);
       if ($perms->checkAccess('password',A_ADMIN))
       {
	      $this->SetFieldAttr('txtLogin','visible',false);
  	      $this->addValidator(new MRequiredValidator('lkpLogin'));
       }
       else
       {
          $login = $auth->GetLogin();
	      $this->SetFieldValue('key',$login->idkey);
	      $this->SetFieldValue('txtLogin',$login->id);
	      $this->SetFieldValue('lkpLogin',$login->id);
	      $this->SetFieldAttr('lkpLogin','visible',false);
       }
	   $this->SetFieldAttr('lkpLogin','module','common');
	   $this->SetFieldAttr('lkpLogin','item','usuario');
	   $this->SetFieldAttr('lkpLogin','event','filler');
	   $this->SetFieldAttr('lkpLogin','related','key,lkpLogin,edtSenhaAtual');
       $buttons = array(
           new MButton('btnPost', 'Enviar')
       );
	   $this->SetButtons($buttons);
       $this->AddValidator(new MRequiredValidator('edtSenhaAtual'));
       $this->AddValidator(new MPasswordValidator('edtSenha1'));
       $this->AddValidator(new MPasswordValidator('edtSenha2'));
	}

	function GetData()  // nome dos formfields != business fields
	{
        $data = new FormData();
		$data->idusuario = $this->GetFieldValue('key');
		$data->login = $this->GetFieldValue('lkpLogin');
		$data->pwdatual = $this->GetFieldValue('edtSenhaAtual');
		$data->pwdnew1 = $this->GetFieldValue('edtSenha1');
		$data->pwdnew2 = $this->GetFieldValue('edtSenha2');
        return $data;
	}

	function SetData($data)
	{
		$this->SetFieldValue('key', $data->idusuario);
		$this->SetFieldValue('lkpLogin', $data->login);
		$this->SetFieldValue('edtSenhaAtual', $data->password);
	}

	function btnPost_click()
	{
		global $MIOLO, $module, $self, $action;
        $data = $this->GetData();
        $objUsuario = $this->objUsuario->GetById($data->idusuario);
        $ok = $objUsuario->ValidatePassword($data->pwdatual);
        if ($ok)
        {
           if ($ok = ($data->pwdnew1 == $data->pwdnew2))
           {
			  $ok = $objUsuario->UpdatePassword($data->pwdnew1);
              if ( $ok )
              {
                 $go = $this->manager->getActionUrl('common','main');
                 $MIOLO->Information('Senha atualizada com sucesso.', $go);
                 return true;
              }
           }
           else
           {
              $this->AddError('Confirmação da senha não confere!');
           }
        }
        $this->AddError($objUsuario->GetErrors());
	}
}

?>
