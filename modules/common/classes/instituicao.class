
<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>

<?
class BusinessCommonInstituicao extends MBusiness
{
	var $idinstituicao;
	var $instituicao;
	var $nome;
	var $rua;
	var $bairro;
	var $cep;
	var $telefone;
	var $email;
	var $fax;
	var $cgc;
	var $caixapostal;
	var $idpais;
	var $idmunicipio;
	var $municipio;
	var $mesmoif;
	var $sigla;
	var $uasg;
	var $campus;
	var $ug;

    function __construct($data=null)
    {
       parent::__construct('common',$data);
       //$this->objInstituicao = $MIOLO->GetBusiness($module,'instituicao');
    }
    

	function GetData()
	{
        	$data = new FormData();
			$data->idinstituicao  = $this->GetFieldValue('idinstituicao');
			$data->instituicao    = $this->GetFieldValue('instituicao');
			$data->nome           = $this->GetFieldValue('nome');
			$data->rua            = $this->GetFieldValue('rua');
			$data->numero         = $this->GetFieldValue('numero');
			$data->complemento    = $this->GetFieldValue('complemento');
			$data->bairro         = $this->GetFieldValue('bairro');
			$data->cep            = $this->GetFieldValue('cep');
			$data->telefone       = $this->GetFieldValue('telefone');
			$data->email          = $this->GetFieldValue('email');
			$data->fax            = $this->GetFieldValue('fax');
			$data->cgc            = $this->GetFieldValue('cgc');
			$data->caixapostal    = $this->GetFieldValue('caixapostal');
			$data->idpais         = $this->GetFieldValue('idpais');
			$data->idmunicipio    = $this->GetFieldValue('idunicipio');
			$data->mesmoif        = $this->GetFieldValue('mesmoif');
			$data->sigla          = $this->GetFieldValue('sigla');
			$data->uasg           = $this->GetFieldValue('uasg');
			$data->ug             = $this->GetFieldValue('ug');
			$data->campus         = $this->GetFieldValue('campus');
			$data->status         = $this->GetFieldValue('status');
		return $data;
	}
	
	
	
	
	function SetData($data)  
	{

       		$this->idinstituicao = $data->idinstituicao;
       		$this->instituicao   = $data->instituicao;
       		$this->nome          = $data->nome;
       		$this->rua           = $data->rua;
       		$this->numero        = $data->numero;
       		$this->complemento   = $data->complemento;
       		$this->bairro        = $data->bairro;
       		$this->cep           = $data->cep;
       		$this->telefone      = $data->telefone;
       		$this->email         = $data->email;
       		$this->fax           = $data->fax;
       		$this->cgc           = $data->cgc;
       		$this->caixapostal   = $data->caixapostal;
       		$this->idpais        = $data->idpais;
       		$this->idmunicipio   = $data->idmunicipio;
       		$this->mesmoif       = $data->mesmoif;
       		$this->sigla         = $data->sigla;
       		$this->uasg          = $data->uasg;
		$this->ug            = $data->ug;
       		$this->campus        = $data->campus;
       		$this->status        = $data->status;
    	}


	function GetById($idinstituicao)
	{		
		$sql = new MSQL('i.idinstituicao,i.instituicao,i.nome,i.rua,i.bairro,i.cep,i.telefone,i.email,i.fax,i.cgc,i.caixapostal,i.idpais,i.idmunicipio,i.numero,i.complemento,i.mesmoif,i.sigla,i.uasg,i.campus,i.ug, i.status, m.municipio','cm_instituicao i, cm_municipio m',"(i.idmunicipio = m.idmunicipio) and idinstituicao = $idinstituicao");

		$query = $this->Query($sql);
		$this->SetData($query->GetRowObject());
		//$query = $this->Query($sql,$idinstituicao);

		if ( !$query->eof() )
		{
			$this->SetData($query->GetRowObject());
		}

		//return $sql;
		return $this;
	}  

                           
    function Insert()
    {   global $MIOLO;
        $sql = new sql('idinstituicao, instituicao, nome, rua, bairro, cep, telefone, email, fax, cgc, caixapostal, idpais, idmunicipio,numero,complemento,mesmoif,sigla,uasg,ug,campus, status','cm_instituicao');

       
		$this->idinstituicao = $this->_db->GetNewId('seq_cm_instituicao');
 		$this->status = 'A';
		
		$args = array( $this->idinstituicao,
		       $this->instituicao, 
                       $this->nome, 
                       $this->rua, 
                       $this->bairro, 
                       $this->cep, 
                       $this->telefone, 
                       $this->email, 
                       $this->fax, 
                       $this->cgc, 
                       $this->caixapostal, 
                       $this->idpais, 
                       $this->idmunicipio,
                       $this->numero,
                       $this->complemento,
                       $this->mesmoif,
                       $this->sigla,
                       $this->uasg,
			$this->ug,
                       $this->campus,
                       $this->status
                     );
                  
                     
        $this->Execute($sql->Insert($args));

		if ($ok) {$this->Log(OP_INS,"idinstituicao = $this->idinstituicao");} 
        return $ok;
   }
                              
  
	function Update()
	{
		$idinst = $this->idinstituicao;
		$sql = new sql('instituicao,nome, sigla, rua, bairro, cep, telefone, email, fax, cgc, caixapostal, idpais, idmunicipio, mesmoif, uasg, campus, ug','cm_instituicao',"idinstituicao = ?");
		$args = array( 
			$this->instituicao,
			$this->nome, 
			$this->sigla,
			$this->rua, 
			$this->bairro, 
			$this->cep, 
			$this->telefone, 
			$this->email, 
			$this->fax, 
			$this->cgc, 
			$this->caixapostal, 
			$this->idpais, 
			$this->idmunicipio,
			$this->mesmoif,
			$this->uasg,
			$this->campus,
			$this->ug,
			$this->idinstituicao
		);

		$ok = $this->Execute($sql->Update($args));
		
		if ($ok) {$this->Log(OP_UPD,"idinstituicao = $idinst");} 
		return $ok;
	}
    
   
    
   
    function Delete()
   {
        $sql = new sql('','cm_instituicao', "idinstituicao = ?");
        $ok = $this->Execute( $sql->Delete($this->idinstituicao) );
        if ($ok) {$this->Log(OP_DEL,"idinstituicao = $this->idinstituicao");} 
        return $ok;
   }

    function ListRange($range=NULL, $where = 'instituicao')
    {
        //$sql = new sql('*', 'cm_instituicao','', $where);
        $sql = new sql('*', 'cm_instituicao', "status = 'A'", $where);
        $sql->SetRange($range); 
        $query = $this->Query($sql);
        return $query;
    }

	function ListAll()
    {
		return $this->ListRange();
    }
    
    
    function ListRangeInativa($range=NULL, $where = 'instituicao')
    {
        //$sql = new sql('*', 'cm_instituicao','', $where);
        $sql = new sql('*', 'cm_instituicao', "status = 'I'", $where);
        $sql->SetRange($range); 
        $query = $this->Query($sql);
        return $query;
    }

	function ListAllInativa()
    {
		return $this->ListRangeInativa();
    }
    
    function CountWhere($where='')
    {
        $sql = new sql('*','cm_instituicao',$where);
        return $this->_db->Count($sql->Select());
    }


    function GetByCgc($cgc)
    {
		$sql = new sql('*','cm_instituicao i',"i.cgc = '$cgc'");
	$query = $this->Query($sql);
        //$query = $this->Query($sql,$cgc);
        if ( !$query->eof() )
        {
            $this->SetData($query->GetRowObject());
        }
        return $this;
    }       
  



/*function listAtivos()
    {
        $criteria =  $this->getCriteria();
        $criteria->setDistinct(true);
        $criteria->addColumnAttribute('idinstituicao');
        $criteria->addColumnAttribute('nome');
         return $criteria->retrieveAsQuery();
    }*/
    
    function ListRangeInst($range=NULL, $where = 'instituicao')
    {
        
	global $MIOLO;
	$sql = new sql('*', 'cm_instituicao'," uasg != '' and status = 'A' ", $where);
        $sql->SetRange($range); 
        $query= $this->Query($sql);
        return $query;
    }

	function ListAlInst()
    {
		return $this->ListRangeInst();
    }
    function ListRangeSetor($range=NULL, $where = 'instituicao')
    {
        
	global $MIOLO;
	$sql = new sql('*', 'cm_instituicao'," uasg != '' and status = 'A'", $where);
        $sql->SetRange($range); 
        $query= $this->Query($sql);
        return $query;
    }

	function ListAllSetor()
    {
		return $this->ListRangeSetor();
    }

	function listUG()
    {
        $criteria =  $this->getCriteria();        
        $criteria->addColumnAttribute('ug');
		$criteria->addColumnAttribute('instituicao');
        $criteria->addCriteria('ug','is not', "null");
         return $criteria->retrieveAsQuery();
    }
	
	function GetInstByUG($ug)
    {
        $criteria =  $this->getCriteria();        
        $criteria->addColumnAttribute('instituicao');
        $criteria->addCriteria('ug','=', "'$ug'");
         return $criteria->retrieveAsQuery();
    }

		function listInst()
    {
        $criteria =  $this->getCriteria();        
        $criteria->addColumnAttribute('idinstituicao');
		$criteria->addColumnAttribute('instituicao');
        $criteria->addCriteria('ug','is not', "null");
         return $criteria->retrieveAsQuery();
    }

	
		function listCampus()
    {
        $criteria =  $this->getCriteria();        
        $criteria->addColumnAttribute('idinstituicao');
		$criteria->addColumnAttribute('instituicao');
        $criteria->addCriteria('uasg','is not', "null");
         return $criteria->retrieveAsQuery();
    }

    function getID($idinst)
	{
		global $MIOLO;
		$sql  = new sql("i.idinstituicao"," cm_instituicao i "," i.sigla = '$idinst' and status = 'A'");
		$query= $this->Query($sql);
		return $query;	
	}
	function getIDInst($inst)
	{
		global $MIOLO;
		$sql  = new sql("i.idinstituicao"," cm_instituicao i "," i.instituicao = '$inst' or i.nome = '$inst' and status = 'A'");
		$query= $this->Query($sql);
		return $query;	
	}
	function getIDByNome($nome)
	{
		global $MIOLO;
		$sql  = new sql("i.idinstituicao"," cm_instituicao i "," i.nome = '$nome'");
		$query= $this->Query($sql);
		return $query;
	}
	function GetById1($idinstituicao)
	{
		global $MIOLO;
		$sql = new sql("i.idinstituicao,i.instituicao,i.nome ,i.rua,i.bairro,i.cep,i.telefone,i.email,i.fax,i.cgc,i.caixapostal,i.idpais,i.mesmoif,i.sigla,i.uasg,i.ug,i.campus,i.idmunicipio,i.numero,i.complemento,m.municipio", "cm_instituicao i, cm_municipio m", "i.idmunicipio = m.idmunicipio and i.idinstituicao = $idinstituicao");
	
		$query = $this->Query($sql);
		$this->SetData($query->GetRowObject());
		return $this;
		 
	}
	function UpdateInst($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('instituicao','cm_instituicao',"idinstituicao = $value");
		$this->instituicao;
		$ok1 = $this->Execute($sql->Update($this->instituicao));
                return $ok1;
			
	}
	function UpdateNome($value)
	{
		
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}	
		
		$sql = new sql('nome','cm_instituicao','idinstituicao = '.$value);               
		$this->nome;
		$ok2 = $this->Execute($sql->Update($this->nome));
                return $ok2;
			
	}
	function UpdateRua($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('rua','cm_instituicao','idinstituicao = '.$value);               
		$this->rua;
		$ok3 = $this->Execute($sql->Update($this->rua));
                return $ok3;
			
	}
	function UpdateBairro($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('bairro','cm_instituicao','idinstituicao = '.$value);               
		$this->bairro;
		$ok4 = $this->Execute($sql->Update($this->bairro));
                return $ok4;
			
	}
	function UpdateCep($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('cep','cm_instituicao','idinstituicao = '.$value);               
		$this->cep;
		$ok5 = $this->Execute($sql->Update($this->cep));
                return $ok5;
			
	}
	function UpdateFone($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('telefone','cm_instituicao','idinstituicao = '.$value);               
		$this->telefone;
		$ok6 = $this->Execute($sql->Update($this->telefone));
                return $ok6;
			
	}
	function UpdateEmail($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('email','cm_instituicao','idinstituicao = '.$value);               
		$this->email;
		$ok7 = $this->Execute($sql->Update($this->email));
                return $ok7;
	}
	function UpdateFax($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('fax','cm_instituicao','idinstituicao = '.$value);               
		$this->fax;
		$ok8 = $this->Execute($sql->Update($this->fax));
                return $ok8;
	}
	function UpdateCGC($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('cgc','cm_instituicao','idinstituicao = '.$value);               
		$this->cgc;
		$ok9 = $this->Execute($sql->Update($this->cgc));
                return $ok9;
	}
	function UpdateCaixaP($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('caixapostal','cm_instituicao','idinstituicao = '.$value);               
		$this->caixapostal;
		$ok10 = $this->Execute($sql->Update($this->caixapostal));
                return $ok10;
	}
	function UpdateIdPais($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('idpais','cm_instituicao','idinstituicao = '.$value);               
		$this->idpais;
		$ok11 = $this->Execute($sql->Update($this->idpais));
                return $ok11;
	}
	function UpdateIdMun($value)
	{
		global $MIOLO;
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('idmunicipio','cm_instituicao','idinstituicao = '.$value);               
		$this->idmunicipio;
		$ok12 = $this->Execute($sql->Update($this->idmunicipio));
                return $ok12;
	}
	function UpdateNum($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('numero','cm_instituicao','idinstituicao = '.$value);               
		$this->numero;
		$ok13 = $this->Execute($sql->Update($this->numero));
                return $ok13;
	}
	function UpdateCom($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('complemento','cm_instituicao','idinstituicao = '.$value);               
		$this->complemento;
		$ok14 = $this->Execute($sql->Update($this->complemento));
                return $ok14;
	}
	function UpdateMsmIf($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('mesmoif','cm_instituicao','idinstituicao = '.$value);               
		$this->mesmoif;
		$ok15 = $this->Execute($sql->Update($this->mesmoif));
                return $ok15;
	}
	function UpdateSigla($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('sigla','cm_instituicao','idinstituicao = '.$value);               
		$this->sigla;
		$ok16 = $this->Execute($sql->Update($this->sigla));
                return $ok16;
	}
	function UpdateUasg($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('uasg','cm_instituicao','idinstituicao = '.$value);               
		$this->uasg;
		$ok17 = $this->Execute($sql->Update($this->uasg));
                return $ok17;
	}

	function UpdateUg($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('ug','cm_instituicao','idinstituicao = '.$value);               
		$this->ug;
		$ok17 = $this->Execute($sql->Update($this->ug));
                return $ok17;
	}
	
	
	function UpdateCampus($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		
		$sql = new sql('campus','cm_instituicao','idinstituicao = '.$value);               
		$this->campus;
		$ok18 = $this->Execute($sql->Update($this->campus));
                return $ok18;
	}
	function UpdateIdInst($value)
	{
		if ($value == null)
		{
			$r = $this->getIDByNome($this->nome);
			$value = $r->fields('idinstituicao');
		}
		$sql = new sql('idinstituicao','cm_instituicao','idinstituicao = '.$value);               
		$this->idinstituicao;
		$ok19 = $this->Execute($sql->Update($value));
                return $ok19;
	}
	function GetMun($idmun)
	{
		global $MIOLO;
		$sql = new sql("idmunicipio","cm_instituicao ","idinstituicao = $idmun");
		$query = $this->Query($sql);
		return $query;
	}
	function Municipio($idm)
	{
		global $MIOLO;
		$sql = new sql("municipio","cm_municipio ","idmunicipio = '$idm'");
		$query = $this->Query($sql);
		return $query;
	}
	function MudaStatus($value)
	{
		$sql = new sql('status','cm_instituicao','idinstituicao = '.$value);               
		$this->status = 'I';
		$ok19 = $this->Execute($sql->Update($this->status));
                return $ok19;
	}
	function StatusAtiva($value)
	{
		global $MIOLO;
		$sql = new sql('status','cm_instituicao','idinstituicao = '.$value);               
		$this->status = 'A';
		$ok19 = $this->Execute($sql->Update($this->status));
                return $ok19;
	}
	function getIDInstInativa($inst)
	{
		global $MIOLO;
		$sql  = new sql("i.idinstituicao"," cm_instituicao i "," i.nome = '$inst' and status = 'I'");
		$query= $this->Query($sql);
		return $query;	
	}

	function ListByNome($nome, $ativa = 'A')
	{
		$nome = strtoupper($nome);

		$sql = new sql("idinstituicao, sigla, instituicao, nome", "cm_instituicao"," ug != '' and status = '$ativa'");
		$sql->SetWhere("upper(instituicao)||' '||upper(nome)||' '||upper(sigla) like '%$nome%'");
		$sql->SetOrderBy('sigla');
		$query= $this->Query($sql);
		return $query;
	}

	function ListNameUg()
	{
		$criteria = $this->getCriteria();
		$criteria->AddColumnAttribute('ug');
		$criteria->AddColumnAttribute('instituicao');
		$criteria->AddCriteria('instituicao','not like',"''");
		$criteria->AddOrderAttribute('instituicao');
		return $criteria->RetrieveAsQuery();
	}
	
	function getPessoasAcessoPatrimonio($idInstituicao)
	{
		$sql = new MSql('p.nome, p.email', 'cm_grupoacesso as ga inner join cm_grpusuario as gp on (ga.idgrupo = gp.idgrupo) inner join cm_usuario as u on (gp.idusuario = u.idusuario) inner join cm_pessoa as p on (p.idpessoa = u.idpessoa) inner join cm_setor as s on (u.idsetor = s.idsetor)', "ga.grupo ilike('adm_patrimonio') and s.idinstituicao = $idInstituicao");
		$query = $this->Query($sql);
		return $query;
	}
	
	//Retorna quantidade de CNPJ iguais do banco de dados.
	function countByCNPJ($cgc)
    {
		$busca = "select count(*) as total from cm_instituicao where cgc = '$cgc'";					
		return pg_fetch_result( pg_query($busca) ,0, 'total' );
    }
}

?>
