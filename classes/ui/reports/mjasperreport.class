<?php

class MJasperReport extends MReport
{
	var $filetype; // pdf doc xls rtf htm rpt
	var $fileout;
	var $fileexp;
	var $objDb;
	var $db;
	var $connectionType;

	function __construct($db = 'admin', $connectionType = 'local')
	{
		$this->db = $db;
		$this->connectionType=$connectionType;
	}

	/*function unix2dos($arquivo) {
	  $file = file("$arquivo");
	  foreach($file as $texto) $conteudo.= substr($texto,0,-1) . "\r\n";    
	  if(is_writable($arquivo)) {
	  $manipular = fopen("$arquivo", "w");
	  fwrite($manipular, $conteudo);
	  fclose($manipular);
	  } else throw new EControlException("O arquivo: \"$arquivo\"  n&atilde;o possui permiss&otilde;es de leitura/escrita.");
	  }*/

	function Execute($module, $name, $parameters = null, $rangeparam = null, $filetype = 'PDF', $save = false)
	{
		global $MIOLO, $page;

		//Caso o parâmetro filetype seja null (diferente de ter sido omitido)        
		$this->filetype = isset($filetype) ? $filetype : 'PDF';

		$filein = addslashes($MIOLO->GetModulePath($module, 'reports/' . $name . '.jasper'));
		$param = "";


		if ($this->connectionType=='local') {
			//Nova solução sem usar o TomCat
			if (is_array($parameters))
			{
				foreach ($parameters as $pn => $pv)
				{
					$param .= '&' . $pn . "<-" . $pv;
				}
			}

			$uniqid = uniqid(md5(uniqid("")));        
			$this->fileout= $uniqid . "." . strtolower($this->filetype);
			$pathout = $MIOLO->getConf("home.reports") .'/'.$this->fileout;
			$pathMJasper = $MIOLO->getConf("home.extensions")."/jasper";

			$this->objDb = $MIOLO->GetDatabase($this->db);
			$dbUser = $this->objDb->user;
			$dbPass = $this->objDb->pass;
			$jdbcDriver = $this->objDb->jdbc_driver;
			$jdbcDb =  $this->objDb->jdbc_db;


			$param = "relatorio<-$filein".$param."&fileout<-".$pathout."&filetype<-".$this->filetype;

			//$comando = 'echo $JAVA_HOME';
			//$pathJava = trim(shell_exec($comando));

			$pathJava = $MIOLO->GetConf('home.java_home');
			$pathLog = $MIOLO->GetConf('home.logs');
			$fileLog = $uniqid . ".txt";

			/*$classPath = "$pathMJasper/lib/jasperreports-3.0.0.jar:$pathMJasper/lib/commons-beanutils-1.7.jar:$pathMJasper/lib/commons-collections-2.1.jar:$pathMJasper/lib/commons-digester-1.7.jar:$pathMJasper/lib/commons-javaflow-20060411.jar:$pathMJasper/lib/commons-logging-api-1.0.2.jar:$pathMJasper/lib/itext-1.3.1.jar:$pathMJasper/lib/ojdbc14.jar:$pathMJasper/lib/iReport.jar:$pathMJasper/jxl-2.4.2.jar:$pathMJasper/";*/
			// 		$classPath = "$pathMJasper/lib/jasperreports-3.0.0.jar:$pathMJasper/lib/commons-beanutils-1.7.jar:$pathMJasper/lib/commons-collections-2.1.jar:$pathMJasper/lib/commons-digester-1.7.jar:$pathMJasper/lib/commons-javaflow-20060411.jar:$pathMJasper/lib/commons-logging-api-1.0.2.jar:$pathMJasper/lib/itext-1.3.1.jar:$pathMJasper/lib/ojdbc14.jar:$pathMJasper/lib/iReport.jar:$pathMJasper/lib/jxl-2.6.3.jar:$pathMJasper/lib/postgresql-8.2-509.jdbc2.jar:$pathMJasper/";

			/**
			 * Daniel Bonfim
			 * 09/01/2013
			 * 
			 * Problemas de compatibilidade com o iReport Designer 4.8.0 resolvido alterando
			 * a versão das bibliotecas jasperreports e itext para: "jasperreports-4.8.0.jar" e "itext-2.1.7.jar" 
			 */
			$classPath = "$pathMJasper/lib/jasperreports-4.8.0.jar:$pathMJasper/lib/commons-beanutils-1.7.jar:$pathMJasper/lib/commons-collections-2.1.jar:$pathMJasper/lib/commons-digester-1.7.jar:$pathMJasper/lib/commons-javaflow-20060411.jar:$pathMJasper/lib/commons-logging-api-1.0.2.jar:$pathMJasper/lib/itext-2.1.7.jar:$pathMJasper/lib/ojdbc14.jar:$pathMJasper/lib/iReport.jar:$pathMJasper/lib/jxl-2.6.3.jar:$pathMJasper/lib/postgresql-8.2-509.jdbc2.jar:$pathMJasper/";

			/**
			 *  Daniel Bonfim
			 *  05-0702013
			 *
			 *  Resolução do problema ao enviar Strings acentuadas para o Jasper.
			 *  A decodificação deste parâmetro é feito na classe
			 *  MJasper.java.
			 */
			$param = urlencode($param);

			$cmd = $pathJava  . "/bin/java -Djava.awt.headless=true -classpath $classPath MJasper \"{$pathMJasper}\" \"{$param}\" \"{$dbUser}\" \"{$dbPass}\" \"{$jdbcDriver}\" \"{$jdbcDb}\"";
			$cmd .= " 2> $pathLog/$fileLog";
			exec($cmd,$output);
			//var_dump($cmd,$output) ;

			if (trim($output[0])=="end") {
				//Aplicação JAVA rodou sem erros!
				if ($save) {
					//Resolve problema de incompatibilidade com quebra de linhas entre Windows e Unix
					if (strtoupper(trim($this->filetype))=="TXT") Mutil::unix2dos($pathout);
					$MIOLO->response->sendDownload($pathout);
				} else {
					$this->fileout = $MIOLO->getActionURL('miolo','reports:'.$this->fileout);
					$MIOLO->getPage()->Redirect($this->fileout);
				}
				return 1;
			} else {

				$link = new MLink('','aqui',$MIOLO->GetActionURL('miolo',"logs:$fileLog"));
				$detalhes = "<br>Para mais detalhes clique " . $link->generate();
				throw new EControlException(implode("<br>",$output) . $detalhes);
			}

		} else if ($this->connectionType=='remote') {
			//Mantendo a possibilidade de usar outra máquina para geração de relatórios com o TomCat
			$filein = addslashes($MIOLO->GetModulePath($module, 'reports/' . $name . '.jasper'));
			$param = "";
			if (is_array($parameters))
			{
				foreach ($parameters as $pn => $pv)
				{

					$param .= '&' . $pn . "=" . urlencode($pv);
				}
			}

			$this->fileout = $MIOLO->getConf("home.url_jasper"). "?bd={$this->db}&relatorio=$filein" . $param;
			$MIOLO->getPage()->Redirect($this->fileout);
		}

	}
}
?>
