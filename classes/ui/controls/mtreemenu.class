<?php
class MTreeMenu extends MControl
{
    static  $order = 0;
    private $nOrder;
    private $template;
    private $action;
    private $target;
    private $items;
    private $jsItems;
    private $arrayItems;
    private $selectEvent;

    function __construct($name = '', $template = 0, $action = '', $target = '_blank')
    {
        parent::__construct($name);
        $page = $this->page;
        $this->AddStyleFile('m_treemenu.css'); 
        $page->AddScript('tigra/tree.js');
        //        $page->AddScript('tigra/tree_items.js');
        $this->items = NULL;
        $this->template = $template;
        $page->AddScript("tigra/tree{$this->template}_tpl.js");
        $this->action = $action;
        $this->target = $target;
        $this->selectEvent = '';
        $this->nOrder = MTreeMenu::$order++;
    }

    private function GetJsItems($items)
    {
        if ($items != NULL)
        {
            foreach ($items as $it)
            {
                $i .= "['{$it[1]}'";
                $i .= ($it[0] !== NULL ? ",'{$it[0]}'" : ',null');

                if ($this->action != '')
                {
                    $it[2] = str_replace('#', $it[0], $this->action);
                }

                $i .= ($it[2] != NULL ? ",'{$it[2]}'" : ',null') . ',';
                $i .= $this->GetJsItems($this->items[(int)$it[0]]);
                $i .= "],";
            }

            return $i;
        }
    }

    function SetItemsFromArray($array, $key = '3', $data = '0,1,2')
    {
        $this->arrayItems = array();
        foreach ($array as $a)
        {
            $this->arrayItems[$a[0]] = $a;
        }

        $o = new MTreeArray($array, $key, $data);
        $this->items = $o->tree;
        $this->jsItems = $this->GetJsItems($this->items['root']);
    }

    function SetItemsFromResult($result, $basename, $key = '0', $data = '1')
    {
		// for while, only for bi-dimensional results
		// column 0 - key used to group data
		// column 1 - data
        $o = new MTreeArray($result, $key, $data);
        $this->items['root'][] = array(0,$basename,'');
		$i = 0;
        foreach ($o->tree as $key => $tree)
        {
            $this->items[0][] = array(++$i,$key,'');
			$j = $i;
			foreach($tree as $t)
			{
                $this->items[$j][] = array(++$i,$t[0],'');
			}
        }
        $this->jsItems = $this->GetJsItems($this->items['root']);
    }

    function getItems()
    {
        return $this->arrayItems;
    }

    function SetSelectEvent($jsCode)
    {
        $tree = $this->nOrder;
        $this->selectEvent .= "trees[$tree].selectevent = function (n_id, item_id) { $jsCode };\n";
    }

    function SetEventHandler($eventHandler = '')
    {
        $tree = $this->nOrder;

        if ($eventHandler != '')
            $this->attachEventHandler('click', $eventHandler);

        $this->selectEvent .= "trees[$tree].selectevent = function (n_id, item_id) { miolo.doPostBack('{$this->name}:click', item_id); document.forms[0].submit(); };\n";
    }

    function GenerateInner()
    {
        $tree = $this->nOrder;
        $page = $this->page;
        $form = ($this->form == NULL) ? $page->name : $this->form->name;
        $html = "<script language=\"JavaScript\">\n";
        $html .= "<!--\n";
        $html .= "var TREE_ITEMS_{$tree} = [ " . $this->jsItems . "];\n";
        $html .= "tree{$this->template}_tpl['target'] = '{$this->target}';\n";
        $html .= "new tree (TREE_ITEMS_{$tree}, tree{$this->template}_tpl);\n";
        if ($this->selectEvent != '')
        {
            $html .= $this->selectEvent;
        }
        $html .= "//-->\n";
        $html .= "</script>\n";
        $this->inner = $html;
    }
}
?>