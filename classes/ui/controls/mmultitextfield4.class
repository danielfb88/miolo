<?php
class MMultiTextField4 extends MMultiTextField3
{
    var $tablevalue;
    var $listTitle = NULL;

    function __construct($name = '', $value = null, $label = '', $fields = '', $width = 200, $buttons = false, $layout = 'vertical', $hint = '')
    {
        parent::__construct($name, $value, $label, $fields, $width, $buttons, $layout, $hint);
        $this->page->AddScript('m_texttable.js');
        $this->page->AddScript('m_multitext4.js');
    }

    function GetTableValue()
    {
        $r = array();

        $value = $this->value;

        if (is_array($value))
        {
            for ($i = 0; $i < count($value); $i++)
            {
                $s = substr($value[$i], 1, strlen(trim($value[$i])) - 2);
                $a = explode('] [', $s);

                if (is_array($a))
                {
                    for ($j = 0; $j < count($a); $j++)
                    {
                        $r[$i][$j] = $a[$j];
                    }
                }
            }
        }

        $this->tablevalue = $r;
        return $this->tablevalue;
    }

    function setListTitle( $title = array() )
    {
        $this->listTitle = $title;
    }

    function GenerateInner()
    {
        $numFields = count($this->fields);

        $this->page->OnSubmit("miolo.multiTextField4.onSubmit('{$this->form->name}','{$this->name}')");

        // fields
        $fields = '';
        $n = 1;
        $ref = '';

        foreach ($this->fields as $f)
        {
            $ref .= ($ref ? ',' : '') . $f->GetName();
            $f->form = $this->form;
            $f->SetLabel(htmlspecialchars($f->label)); 
            $f->formMode = 2;
            if ($f->size == '') $f->_AddStyle('width', "{$this->colWidth}px");
            $fields[] = $f;
            $n++;
        }

        // select
        $labelS = $this->info . "&nbsp;";
        $content = array();

        if (!is_array($this->value))
        {
           $this->value = array(); 
        } 

        $field = new MTextTable("{$this->name}", $this->getTableValue(), $this->info,'',false);
        $field->setScrollHeight( ($this->numRows * 15) . 'px' );
        $field->setScrollWidth( $this->fieldWidth . 'px' );
        if ($this->listTitle)
        {
             $field->setTitle($this->listTitle);
        }
        $field->addCode("miolo.multiTextField4.onSelect(this.form,'{$this->name}','{$ref}');");
        $select = $field;

        // buttons

        $disposition = ($this->layout == 'horizontal') ? 'vertical' : 'horizontal';
        $button[] = new MButton("{$this->name}_add", 'Adicionar',
                                "miolo.multiTextField4.add(this.form, '{$this->name}','{$ref}')");
        $button[] = new MButton("{$this->name}_modify", 'Modificar',
                                "miolo.multiTextField4.modify(this.form,'{$this->name}','{$ref}')");
        $button[] = new MButton("{$this->name}_remove", 'Remover',
                                "miolo.multiTextField4.remove(this.form,'{$this->name}','{$ref}')");

        if ($this->shownav)
        {
            $button[] = new MButton("{$this->name}_up", '/\\',
                                    "miolo.multiTextField4.moveUp(this.form,'{$this->name}','{$ref}')");
            $button[] = new MButton("{$this->name}_down", '\\/',
                                    "miolo.multiTextField4.moveDown(this.form,'{$this->name}','{$ref}')");
        }

        foreach ($button as $b)
            $b->SetClass('button');

        $buttons = new MContainer('', $button, $disposition);

        $commentIn = $this->painter->Comment('START OF Field MultiTextField4');
        $commentOut = $this->painter->Comment('END OF Field MultiTextField4');

        // layout

        $t = array();
        $cFields = new MContainer('', $fields, 'vertical');
        $cFields->AddBoxStyle('width', "{$this->fieldWidth}px");
        if ($this->layout == 'vertical')
        {
            $t[] = $select;
            $t[] = $cFields;
            $t[] = $buttons;
            $group = new MBaseGroup('', $this->label, $t, 'vertical', 'css');
        }
        elseif ($this->layout == 'vertical2')
        {
            $t[] = $cFields;
            $t[] = $buttons;
            $t[] = $select;
            $group = new MBaseGroup('', $this->label, $t, 'vertical', 'css');
        }
        elseif ($this->layout == 'horizontal')
        {
            $t[] = new MDiv('', $cFields, 'fieldPosH');
            $t[] = new MDiv('', array(new MDiv('', '&nbsp;', 'label'), $buttons), 'buttonPosH');
            $t[] = new MDiv('', $select, 'selectPosH');
            $group = new MBaseGroup('', $this->label, $t, 'horizontal', 'css');
        }

        $div = new MDiv('', $group, 'm-multitext-field');
        $this->inner = array
            (
//            $hidden,
            $commentIn,
            $div,
            $commentOut
            );

        return $this->inner;
    }
}
?>