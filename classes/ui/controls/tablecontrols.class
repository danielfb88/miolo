<?php

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Table
#    Class for html tables
#    - Rows, Cols and Content are 0-based
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

class MTable extends MControl
{
    var $body;
    var $head;
    var $foot;
    var $colgroup;
    var $attr;

    function __construct($body, $tableAttr, $attr, $head=NULL, $foot=NULL, $colgroup=NULL)
    {
        parent::__construct();
        $this->body = $body;
        $this->head = $head;
        $this->foot = $foot;
        $this->colgroup = $colgroup;
        $this->SetAttributes($tableAttr);
        $this->attr = $attr;
    }
}

class MSimpleTable extends MControl
{
   var $head;
   var $foot;
   var $cell;
   var $colgroup;
   var $attributes;

   function __construct($name='', $attrs='', $row=1, $cell=1)
   {
      parent::__construct($name);
      if ($attrs == '')
         $attrs = "cellspacing=0 cellpadding=0 border=0 width=100%";
      else
         $attrs = str_replace("\"",'',$attrs);
      $this->SetAttributes($attrs); 
	  /*echo('<pre>');	  
	  var_dump($attrs);
	  echo('</pre>');*/
	  
      $this->SetClass($this->attrs->items['class']);
      for($i=0; $i < $row; $i++)
      {
         $this->attributes['row'][$i] = '';
         for($j=0; $j < $cell; $j++)
           $this->attributes['cell'][$i][$j] = '';
      }
   }

   private function setTableAttribute($area, $i, $j=NULL,$name, $attr)
   {
       $at = ($attr != '') ? " $name=\"$attr\" " : " $name ";
       if (is_null($j))
       {
           $this->attributes[$area][$i] .= $at;
       }
       else
       {
           $this->attributes[$area][$i][$j] .= $at;
       }
   }	  

   private function setTableClass($area, $i,$j=NULL,$class)
   {
       if (is_null($j))
       {
           $this->attributes[$area][$i] .= " class=\"$class\" ";
       }
       else
       {
           $this->attributes[$area][$i][$j] .= " class=\"$class\" ";
       }
   }	  

   function SetRowAttribute($i, $name, $attr)
   {
       $this->setTableAttribute('row',$i,NULL,$name, $attr);
   }

   function SetCellAttribute($i, $j, $name, $attr='')
   {
       $this->setTableAttribute('cell',$i,$j,$name, $attr);
   }

   function SetHeadAttribute($i, $name, $attr='')
   {
       $this->setTableAttribute('head',$i,NULL,$name, $attr);
   }

   function SetFootAttribute($i, $name, $attr='')
   {
       $this->setTableAttribute('foot',$i,NULL,$name, $attr);
   }

   function SetRowClass($i,$class)
   {
       $this->setTableClass('row',$i,NULL,$class);
   }

   function SetCellClass($i,$j,$class)
   {
       $this->setTableClass('cell',$i,$j,$class);
   }

   function SetHeadClass($i,$class)
   {
       $this->setTableClass('head',$i,NULL,$class);
   }

   function SetFootClass($i,$class)
   {
       $this->setTableClass('foot',$i,NULL,$class);
   }

   function SetCell($i,$j,$content,$attrs='')
   {
       $this->cell[$i][$j] = $content;
       if ($attrs != '')
       {
          $this->attributes['cell'][$i][$j] .= $attrs;
       }
   }

   function SetHead($i,$content,$attrs='')
   {
       $this->head[$i] = $content;
       if ($attrs != '')
       {
          $this->attributes['head'][$i] .= $attrs;
       }
   }

   function SetFoot($i,$content,$attrs='')
   {
       $this->foot[$i] = $content;
       if ($attrs != '')
       {
          $this->attributes['foot'][$i] .= $attrs;
       }
   }

   function SetColGroup($i,$attrs='')
   {
       $this->colgroup[$i]['attr'] = $attrs;
   }

   function SetColGroupCol($i,$j,$attrs='')
   {
       $this->colgroup[$i]['col'][$j] = $attrs;
   }

   function Generate()
   {
      $n = count($this->head);
      for($i=0; $i<$n; $i++)
      {
          $head[$i] = $this->painter->GenerateToString($this->head[$i]);
      }
      $n = count($this->foot);
      for($i=0; $i<$n; $i++)
      {
          $foot[$i] = $this->painter->GenerateToString($this->foot[$i]);
      }
      $n = count($this->cell);
      for($i=0; $i<$n; $i++)
      {
         $k = count($this->cell[$i]);
         for($j=0; $j<$k; $j++)
         {
            $body[$i][$j] = $this->painter->GenerateToString($this->cell[$i][$j]);
         }
      }
      $t = new MTable($body, $this->Attributes(), $this->attributes, $head, $foot, $this->colgroup);
      $t->setCaption($this->caption);
      $t->setId($this->getId()); 
      return $t->GetRender('table');
   }

}

class MTableRaw extends MSimpleTable
{
    var $title;
    var $array;
    var $colTitle;
    var $zebra = false;
    var $table;

    function __construct($title='', $array, $colTitle=null)
    {
        parent::__construct('');
        $this->title = $title;
        $this->array = $array;
        $this->colTitle = $colTitle;
        $this->table = new MSimpleTable($this->getId());
        $this->table->SetClass("m-tableraw");
        $this->table->SetAttributes('cellspacing=1 width=null cellpadding=3'); 
    }

    function SetAlternate($zebra=false)
    {
        $this->zebra = $zebra;
    }

   function Generate()
   {
      $title = $this->title;
      $array = $this->array;
      $colTitle = $this->colTitle;
      $t = $this->table;
      $k = 0;
      if ($title)
      {
         $ncols = count($array[0]);
         $t->SetCell($k++,0,$title," class=\"m-tableraw-title\" colspan=$ncols ");
      }
      if (is_array($colTitle))
      {
         $n = count($colTitle);
         for($i=0;$i<$n;$i++)
            $t->SetCell($k,$i,$colTitle[$i]," class=\"m-tableraw-column-title\" ");
         $k++;
      }
      if (is_array($array))
      {
         $nrows = count($array);
         for($i=0; $i<$nrows; $i++)
         {
            $rowClass = "m-tableraw-row" . ($this->zebra ? '-'.($i%2) : '');
            $t->SetRowClass($k, $rowClass);
            if (is_array($array[$i]))
            {
               $ncols = count($array[$i]);
               for($j=0; $j<$ncols; $j++)
               { 
                   $attr = $this->attributes['cell'][$i][$j];
                   if ($attr == '') $attr = "width=0 align=\"left\" valign=\"top\"";
                   $t->SetCell($k,$j,$array[$i][$j],$attr);

               }
            }
            else 
            {
               $attr = $this->attributes['cell'][$i][0];
               if ($attr == '') $attr = "width=0 align=\"left\" valign=\"top\"";
               $t->SetCell($k,0,$array[$i], $attr);
            }
            $k++; 
         }
      } 
      return $t->Generate();
   }

}

class MTableXml extends MTableRaw
{
    function __construct($title='', $file, $colTitle=null)
    {
        $xmlTree = new MXMLTree($file);
        $array = $xmlTree->getXMLTreeAsArray();
        parent::__construct($title, $array, $colTitle);
    }
}

class TableCell extends MControl
{
    var $content;
    var $attributes;
    var $separator;
    var $contentCount;

    function __construct()
    {
       parent::__construct();
       $this->attributes = array(); 
       $this->content = array(); 
       $this->contentCount = 0;  
       $this->cssclass = 'ThemeTableCell';
       $this->separator = '<br>';
    }

    function SetAttributes($attr)
    {
       foreach($attr as $a=>$v) $this->attributes[$a] = $v;
    }

    function SetAttribute($attr,$value)
    {
       $this->attributes[$attr] = $value;
    }

    function SetContent($content)
    {
       $this->content = array($content);
       $this->contentCount = 1;
    }

    function GetContent($pos=0)
    {
       if ($pos < $this->contentCount) {
          return $this->content[$pos];
       }
       return null;
    }

    function ClearContent()
    {
       $this->content = array();
       $this->contentCount = 0;
    }

    function AddContent($content)
    {
       $this->content[] = $content;
       $this->contentCount++;
    }
}

class TableRow extends MControl
{
    var $cell;  // array of Cell object
    var $attributes;
    var $cellCount;

    function __construct()
    {
       parent::__construct();
       $this->cell = array();
       $this->attributes = array (
          'align'=>'',
          'valign'=>''
       );
       $this->cssclass = 'ThemeTableRow';
       $this->cellCount = 0;
    }
  
    function SetAttributes($attr)
    {
       foreach($attr as $a=>$v) $this->attributes[$a] = $v;
    }

    function SetAttribute($attr,$value)
    {
       $this->attributes[$attr] = $value;
    }

    function AddCell()
    {
       $this->cell[$c = $this->cellCount++] = new TableCell();
       return $c;
    }

    function RemoveCell($cell)
    {
       if (($this->cellCount > 0) && ($this->cellCount > $cell))
       {
          array_splice($this->cell,$cell, 1);
          $this->cellCount--;
       }
    }

    function GetCell($cell)
    {
       if ($this->ncells > $cell)
       {
          return $this->cell[$cell];
       }
       return null;
    }
}

?>