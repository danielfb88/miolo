<?php
define('PN_PAGE', 'pn_page');
/**
 * Uma implementação de controles de navagação de páginas para grids
 */
class MGridNavigator extends MControl
{
    var $pageLength;
    var $pageNumber;
    var $action;
    var $range;
    var $rowCount;
    var $gridCount;
    var $pageCount;
    var $idxFirst;
    var $idxLast;
    var $showPageNo = false;
    var $linktype; // hyperlink or linkbutton
    var $grid;

    function __construct($length = 20, // Number of records per page
                           $total = 0,   // Number total of records 
                           $action = '?', // Action URL
                           $grid = NULL// The grid which contains this component
        )
    {
        global $state;

        parent::__construct();
        $this->pageLength = $length;
        $this->gridCount = $length;
        $this->SetRowCount($total);
        $this->grid = $grid;
/*
        if (urldecode($this->page->Request('gridName')) == $this->grid->name)
        {
          $this->SetPageNumber($this->page->Request(PN_PAGE));
          $state->set('pn_page', $this->page->Request(PN_PAGE), $this->grid->name);
        }
        else
        {
          $this->SetPageNumber($state->get('pn_page', $this->grid->name));
        }
*/
          $this->SetPageNumber($state->get('pn_page', $this->grid->name));

//        $this->grid->pageNumber = MUtil::NVL($state->get('pn_page', $this->grid->name),1);
//        $this->grid->prevPage = MUtil::NVL($state->get('grid_page', $this->grid->name),1);

//        $this->grid->HandlerSelecteds();

//        $state->set('grid_page', $this->getPageNumber(), $this->grid->name);

        $this->action = $action;
        $this->linktype = 'hyperlink';

    }

    function SetAction($url)
    {
        $this->action = $url;
    }

    function SetLinkType($linktype)
    {
        $this->linktype = $linktype;
    }

    function SetRowCount($rowCount)
    {
        $this->rowCount = $rowCount;
        $this->pageCount = ($this->pageLength > 0) ? (int)(($this->rowCount + $this->pageLength - 1) / $this->pageLength) : 1;
    }

    function SetGridCount($gridCount)
    {
        $this->gridCount = $gridCount;
    }

    function SetPageNumber($num)
    {
        $this->pageNumber = (int)($num ? $num : 1);
        $this->range = new MRange($this->pageNumber, $this->pageLength, $this->rowCount);
        $this->SetIndexes();
    }

    function SetIndexes()
    {
      $this->range-> __construct($this->pageNumber, $this->pageLength, $this->rowCount);
      $this->idxFirst = $this->range->offset;
      $this->idxLast = $this->range->offset + $this->range->rows - 1;
      $this->SetGridCount($this->range->rows);
    }

    function SetGridParameters($pageLength, $rowCount, $action, $grid)
    {
      $this->pageLength = $pageLength;
      $this->SetRowCount($rowCount);
      $this->action = $action;
      $this->grid = $grid;
      $this->SetIndexes();
    }

    function GetRowCount()
    {
        return $this->rowCount;
    }

    function GetGridCount()
    {
        return $this->gridCount;
    }

    function GetPageNumber()
    {
        return $this->pageNumber;
    }

    function GetPageCount()
    {
        return $this->pageCount;
    }

    function GetPagePosition($showPage = true)
    {
        $position = '[' . ($showPage ? _M('Página') : '') . ' ' . $this->GetPageNumber() . ' ' . _M('de') . ' '
                        . $this->GetPageCount() . "]";
        return $position;
    }

    function GetPageLinks($showPage = true, $limit = 10)
    {           
        $pageCount = $this->GetPageCount();
        $pageNumber = $this->GetPageNumber();
        $pageLinks = array();

        $p = 0;

        if (!$this->GetRowCount())
        {
            $pageLinks[$p] = new MLabel('&nbsp;&nbsp;&nbsp;');
            $pageLinks[$p++]->SetClass('m-pagenavigator-text');
        }
        else
        {
            if ($showPage)
            {
                $pageLinks[$p] = new MText('', '&nbsp;Página:&nbsp;');
                $pageLinks[$p++]->SetClass('m-pagenavigator-text');
            }

            if ($pageNumber <= $limit)
            {
                $o = 1;
            }
            else
            {
                $o = ((int)(($pageNumber - 1) / $limit)) * $limit;
                $pageLinks[$p] = new MLinkButton('', '...', "$this->action&" . PN_PAGE . "=" . $o++ . "&gridName=". urlencode($this->grid->name));
                $pageLinks[$p++]->SetClass('m-pagenavigator-link');
            }

            for ($i = 0; ($i < $limit) && ($o <= $pageCount); $i++, $o++)
            {
                $pg = $o;
                if ($o != $pageNumber)
                {
                    $pageLinks[$p] = new MLinkButton('', $pg, "$this->action&" . PN_PAGE . "=" . $o . "&gridName=". urlencode($this->grid->name));
                    $pageLinks[$p]->SetClass('m-pagenavigator-link');
                    $pageLinks[$p++]->SetAttribute('onMouseOver', "top.status='Página $pg'");
                }
                else
                {
                    $pageLinks[$p] = new MLinkButton('', "$pg", "$this->action&" . PN_PAGE . "=" . $o . "&gridName=". urlencode($this->grid->name));
                    $pageLinks[$p++]->SetClass('m-pagenavigator-selected');
                }
            }

            if ($o < $pageCount)
            {
                $pageLinks[$p++] = new MLabel('');
                $pageLinks[$p] = new MLinkButton('', '...', "$this->action&" . PN_PAGE . "=" . $o . "&gridName=". urlencode($this->grid->name));
                $pageLinks[$p++]->SetClass('m-pagenavigator-link');
            }
        }

        return $pageLinks;
    }

    function GetPageRange($subject = '')
    {
        if (!$this->GetRowCount())
        {
            $range = 'Nenhum dado';
        }
        else
        {
            $first = $this->idxFirst + 1;
            $last = $this->idxLast + 1;
            $range = '[' . $first . '..' . $last . '] de ' . $this->GetRowCount() . $subject;
        }

        return new MSpan('', $range, 'm-pagenavigator-range');
    }

    function GetPageRows($subject = '')
    {
        $rows = $this->GetGridCount() . '&nbsp;' . $subject;
        return $rows;
    }

    function GetPageFirst()
    {
        $pageNumber = $this->GetPageNumber();
        $attrs = array('border' => '0');
        $btn_first0 = new MImage('_gnFirst', 'Primeira', "images/but_pg_primeira.gif", $attrs);
        $btn_first1 = new MImageButton('_gnFirst', 'Primeira', "$this->action&" . PN_PAGE . "=1" . "&gridName=". urlencode($this->grid->name),
                                      "images/but_pg_primeira_x.gif");
        $btn = ($pageNumber > 1 ? $btn_first1 : $btn_first0);
        return new MSpan('', $btn, 'm-pagenavigator-image');
    }

    function GetPagePrev()
    {
        $pageNumber = $this->GetPageNumber();
        $pagePrev = $pageNumber - 1;
        $attrs = array('border' => '0');
        $btn_prev0 = new MImage('_gnPrev', 'Anterior', "images/but_pg_anterior.gif", $attrs);
        $btn_prev1 = new MImageButton('_gnPrev', 'Anterior', "$this->action&" . PN_PAGE . "=" . $pagePrev . "&gridName=". urlencode($this->grid->name),
                                     "images/but_pg_anterior_x.gif");
        $btn = ($pageNumber > 1 ? $btn_prev1 : $btn_prev0);
        return new MSpan('', $btn, 'm-pagenavigator-image');
    }

    function GetPageNext()
    {
        $pageNumber = $this->GetPageNumber();
        $pageNext = $pageNumber + 1;
        $pageCount = $this->GetPageCount();
        $attrs = array('border' => '0');
        $btn_next0 = new MImage('_gnNext', 'Próxima', "images/but_pg_proxima.gif", $attrs);
        $btn_next1 = new MImageButton('_gnNext', 'Próxima', "$this->action&" . PN_PAGE . "=" . $pageNext . "&gridName=". urlencode($this->grid->name),
                                     "images/but_pg_proxima_x.gif");
        $btn = ($pageNumber < $pageCount ? $btn_next1 : $btn_next0);
        return new MSpan('', $btn, 'm-pagenavigator-image');
    }

    function GetPageLast()
    {
        $pageNumber = $this->GetPageNumber();
        $pageCount = $this->GetPageCount();
        $attrs = array('border' => '0');
        $btn_last0 = new MImage('_gnLast', 'Última', "images/but_pg_ultima.gif", $attrs);
        $btn_last1 = new MImageButton('_gnLast', 'Última', "$this->action&" . PN_PAGE . "=" . $pageCount . "&gridName=". urlencode($this->grid->name),
                                     "images/but_pg_ultima_x.gif");
        $btn = ($pageNumber < $pageCount ? $btn_last1 : $btn_last0);
        return new MSpan('', $btn, 'm-pagenavigator-image');
    }
}
?>
